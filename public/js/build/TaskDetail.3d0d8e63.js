import{m as _}from"./vuex.cc7cb26e.js";import{T as v,a as w,P as D,b as y}from"./add.6f6c3021.js";import{n as r,U as b,T,e as h}from"./app.8f3ecf6d.js";import{C,D as x}from"./DialogWrapper.b5f8663b.js";import L from"./TEditor.631a5c08.js";var A=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Modal",{staticClass:"task-exist-tips",attrs:{title:t.$L("\u8BA1\u5212\u65F6\u95F4\u51B2\u7A81\u63D0\u793A"),styles:{width:"90%",maxWidth:"550px"}},model:{value:t.show,callback:function(a){t.show=a},expression:"show"}},[e("List",{attrs:{split:!1,size:"small"}},t._l(t.tipsTask,function(a,i){return e("ListItem",{key:i},[e("div",{staticClass:"list-content"},[e("UserAvatar",{attrs:{userid:i,size:28,"show-icon":!0,"show-name":!0}}),t._l(a,function(o,n){return e("div",{key:n,staticClass:"list-task"},[e("div",{staticClass:"list-task-info"},[e("span",[t._v("["+t._s(o.project_name)+"] ")]),e("span",{attrs:{title:o.name}},[t._v(t._s(o.name))])]),e("div",{staticClass:"list-task-date"},[t._v(t._s(t.getCutTime(o)))])])})],2)])}),1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(a){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary"},on:{click:t.onContinue}},[t._v(t._s(t.$L("\u5FFD\u7565\u5E76\u7EE7\u7EED")))])],1)],1)},S=[];const M={name:"TaskExistTips",props:{value:{type:Boolean,default:!1}},data(){return{show:!1,tipsTask:[]}},methods:{onContinue(){this.$emit("onContinue"),this.show=!1},getCutTime(t){let s=$A.dayjs(t.start_at),e=$A.dayjs(t.end_at),a="";return s.format("YYYY/MM/DD")==e.format("YYYY/MM/DD")?a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("HH:mm"):s.year()==e.year()?(a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("MM/DD HH:mm"),a=a.replace(/( 00:00| 23:59)/g,"")):(a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("YYYY/MM/DD HH:mm"),a=a.replace(/( 00:00| 23:59)/g,"")),a},isExistTask({userids:t,timerange:s,taskid:e},a){return new Promise(async i=>{if($A.isArray(s)&&(!s[0]||!s[1])){i(!1);return}this.$store.dispatch("call",{url:"project/task/easylists",data:{userid:t,timerange:s,taskid:e},method:"get",spinner:a}).then(({data:o})=>{if(o.data.length<=0){i(!1);return}this.show=!0;let n={};t.map(l=>{o.data.map(d=>{(d.task_user||[]).map(c=>c.owner?c.userid:0).indexOf(l)!==-1&&(n[l]||(n[l]=[]),n[l].push(d))})}),this.tipsTask=n,i(!0)})})}}},u={};var F=r(M,A,S,!1,I,null,null,null);function I(t){for(let s in u)this[s]=u[s]}var E=function(){return F.exports}(),O=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-editor",on:{click:t.onClickWrap,touchstart:t.onTouchstart}},[e("TEditor",{ref:"desc",attrs:{plugins:t.plugins,options:t.options,"option-full":t.optionFull,placeholder:t.placeholder,placeholderFull:t.placeholderFull,readOnly:t.windowTouch,readOnlyFull:!1,readOnlyImagePreview:!1,inline:""},on:{"on-blur":t.onBlur,"on-editor-init":t.onEditorInit,"on-transfer-change":t.onTransferChange},model:{value:t.content,callback:function(a){t.content=a},expression:"content"}}),e("div",{directives:[{name:"show",rawName:"v-show",value:t.operateVisible,expression:"operateVisible"}],staticClass:"task-editor-operate",style:t.operateStyles},[e("Dropdown",{attrs:{trigger:"custom",visible:t.operateVisible,transfer:""},on:{"on-clickoutside":function(a){t.operateVisible=!1}}},[e("div",{style:{userSelect:t.operateVisible?"none":"auto",height:t.operateStyles.height}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[t.operateMenu.checked?e("DropdownItem",{nativeOn:{click:function(a){return t.onLiPreview.apply(null,arguments)}}},[t._v(t._s(t.$L(t.operateMenu.checked==="checked"?"\u6807\u8BB0\u672A\u9009":"\u6807\u8BB0\u5DF2\u9009")))]):t._e(),t.operateMenu.link?e("DropdownItem",{nativeOn:{click:function(a){return t.onLinkPreview.apply(null,arguments)}}},[t._v(t._s(t.$L("\u6253\u5F00\u94FE\u63A5")))]):t._e(),t.operateMenu.img?e("DropdownItem",{nativeOn:{click:function(a){return t.onImagePreview.apply(null,arguments)}}},[t._v(t._s(t.$L("\u67E5\u770B\u56FE\u7247")))]):t._e(),e("DropdownItem",{nativeOn:{click:function(a){return t.onEditing.apply(null,arguments)}}},[t._v(t._s(t.$L("\u7F16\u8F91\u63CF\u8FF0")))]),t.operateMenu.history?e("DropdownItem",{nativeOn:{click:function(a){return t.onHistory.apply(null,arguments)}}},[t._v(t._s(t.$L("\u5386\u53F2\u8BB0\u5F55")))]):t._e()],1)],1)],1)],1)},j=[];const H={name:"TEditorTask",components:{TEditor:L},props:{value:{default:""},placeholder:{default:""},placeholderFull:{default:""}},data(){return{content:this.value,plugins:["advlist autolink lists checklist link image charmap print preview hr anchor pagebreak","searchreplace visualblocks visualchars code","insertdatetime media nonbreaking save table directionality","emoticons paste codesample","autoresize"],options:{statusbar:!1,menubar:!1,autoresize_bottom_margin:2,min_height:200,max_height:380,contextmenu:"checklist | bold italic underline forecolor backcolor | link | uploadImages imagePreview | history screenload",valid_elements:"a[href|title|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code,ol[class],ul[class],li[class]",extended_valid_elements:"a[href|title|target=_blank]",toolbar:!1},optionFull:{menubar:"file edit view",removed_menuitems:"preview,print",contextmenu:"checklist | bold italic underline forecolor backcolor | link | uploadImages imagePreview | screenload",valid_elements:"a[href|title|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code,ol[class],ul[class],li[class]",extended_valid_elements:"a[href|title|target=_blank]",toolbar:"uploadImages | checklist | bold italic underline | forecolor backcolor",mobile:{menubar:"file edit view"}},operateStyles:{},operateVisible:!1,operateHiddenTime:0,operateMenu:{target:null,checked:null,link:null,img:null,history:!0},listener:null}},mounted(){var s;let t=this.$parent.$el.parentNode;for(;t;){if((s=t.classList)!=null&&s.contains(".ivu-modal-wrap")){this.listener=t,t.addEventListener("scroll",this.onTouchstart);break}t=t.parentNode}this.operateMenu.history=typeof this.$listeners["on-history"]=="function"},beforeDestroy(){var t;(t=this.listener)==null||t.removeEventListener("scroll",this.onTouchstart)},computed:{editor(){return this.$refs.desc.editor}},watch:{value(t){this.content=t},content(t){this.$emit("input",t)},operateVisible(t){t||(this.operateHiddenTime=Date.now())}},methods:{getContent(){return this.$refs.desc.getContent()},updateContent(t){this.content=t},onEditing(){this.$refs.desc.onFull()},onHistory(){this.$emit("on-history")},onBlur(){this.$emit("on-blur")},onEditorInit(t){this.updateTouchContent(),this.updateHistoryContent(t),this.$emit("on-editor-init",t)},onTransferChange(t){t||!this.windowTouch||setTimeout(s=>{this.updateTouchContent(),this.onBlur()},100)},onClickWrap(t){!this.windowTouch||Date.now()-this.operateHiddenTime<300||(t.stopPropagation(),this.operateVisible=!1,this.operateMenu.target=t.target,this.operateMenu.checked=null,t.target.tagName==="LI"&&t.target.parentNode.classList.contains("tox-checklist")&&(this.operateMenu.checked=t.target.classList.contains("tox-checklist--checked")?"checked":"unchecked"),this.operateMenu.link=t.target.tagName==="A"?t.target.href:null,this.operateMenu.img=t.target.tagName==="IMG"?t.target.src:null,this.$nextTick(()=>{const s=this.$el.getBoundingClientRect();this.operateStyles={left:`${t.clientX-s.left}px`,top:`${t.clientY-s.top}px`},this.operateVisible=!0}))},onTouchstart(){!this.windowTouch||(this.operateVisible=!1)},updateTouchContent(){!this.windowTouch||this.$nextTick(t=>{!this.editor||(this.content?(this.editor.bodyElement.removeAttribute("data-mce-placeholder"),this.editor.bodyElement.removeAttribute("aria-placeholder")):(this.editor.bodyElement.setAttribute("data-mce-placeholder",this.placeholder),this.editor.bodyElement.setAttribute("aria-placeholder",this.placeholder)),this.updateTouchLink(0))})},updateTouchLink(t){!this.windowTouch||setTimeout(s=>{!this.editor||(this.editor.bodyElement.querySelectorAll("a").forEach(e=>{e.__dataMceClick!==!0&&(e.__dataMceClick=!0,e.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.onClickWrap(a)}))}),t<300&&this.updateTouchLink(t+100))},t)},updateHistoryContent(t){t.ui.registry.addMenuItem("history",{icon:"insert-time",text:this.$L("\u5386\u53F2\u8BB0\u5F55"),onAction:()=>{this.onHistory()}})},onLiPreview(){!this.operateMenu.checked||(this.operateMenu.checked==="checked"?this.operateMenu.target.classList.remove("tox-checklist--checked"):this.operateMenu.target.classList.add("tox-checklist--checked"),this.$emit("on-blur","force"))},onLinkPreview(){this.operateMenu.link&&window.open(this.operateMenu.link)},onImagePreview(){const t=this.$refs.desc.getValueImages();if(t.length===0){$A.messageWarning("\u6CA1\u6709\u53EF\u9884\u89C8\u7684\u56FE\u7247");return}this.$store.dispatch("previewImage",{index:this.operateMenu.img,list:t})}}},m={};var Y=r(H,O,j,!1,V,"3862482f",null,null);function V(t){for(let s in m)this[s]=m[s]}var P=function(){return Y.exports}(),z=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Upload",{ref:"upload",attrs:{name:"files",action:"",multiple:"",format:t.uploadFormat,"show-upload-list":!1,"max-size":t.maxSize,"on-format-error":t.handleFormatError,"on-exceeded-size":t.handleMaxSize,"before-upload":t.handleBeforeUpload}})},N=[];const B={name:"TaskUpload",props:{maxSize:{type:Number,default:1024e3}},data(){return{uploadFormat:["jpg","jpeg","webp","png","gif","doc","docx","xls","xlsx","ppt","pptx","txt","esp","pdf","rar","zip","gz","ai","avi","bmp","cdr","eps","mov","mp3","mp4","pr","psd","svg","tif"]}},methods:{handleFormatError(t){$A.modalWarning({title:"\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E",content:"\u6587\u4EF6 "+t.name+" \u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4EC5\u652F\u6301\u53D1\u9001\uFF1A"+this.uploadFormat.join(",")})},handleMaxSize(t){$A.modalWarning({title:"\u8D85\u51FA\u6587\u4EF6\u5927\u5C0F\u9650\u5236",content:"\u6587\u4EF6 "+t.name+" \u592A\u5927\uFF0C\u4E0D\u80FD\u53D1\u9001\u8D85\u8FC7"+$A.bytesToSize(this.maxSize*1024)+"\u3002"})},handleBeforeUpload(t){return this.$emit("on-select-file",t),!1},handleClick(){this.$refs.upload.handleClick()}}},p={};var R=r(B,z,N,!1,U,null,null,null);function U(t){for(let s in p)this[s]=p[s]}var W=function(){return R.exports}(),Q=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-tag-select",class:{"no-search":t.filteredTags.length<=5}},[e("div",{staticClass:"search-box"},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.searchQuery,expression:"searchQuery"}],staticClass:"search-input",attrs:{type:"text",placeholder:t.$L("\u641C\u7D22\u6807\u7B7E")},domProps:{value:t.searchQuery},on:{input:function(a){a.target.composing||(t.searchQuery=a.target.value)}}})]),e("div",{staticClass:"tag-list"},[t.filteredTags.length?t._l(t.filteredTags,function(a){return e("div",{key:a.name,staticClass:"tag-item",class:{"is-selected":t.isSelected(a)},on:{click:function(i){return t.toggleTag(a)}}},[e("div",{staticClass:"tag-color",style:{backgroundColor:a.color}}),e("div",{staticClass:"tag-info"},[e("div",{staticClass:"tag-name"},[t._v(t._s(a.name))]),a.desc?e("div",{staticClass:"tag-desc"},[t._v(t._s(a.desc))]):t._e()]),t.isSelected(a)?e("div",{staticClass:"tag-check"},[e("i",{staticClass:"el-icon-check"})]):t._e()])}):t.loading?t._e():e("div",{staticClass:"no-data"},[t._v(t._s(t.$L("\u6682\u65E0\u6807\u7B7E")))])],2),e("div",{staticClass:"footer-box"},[e("div",{staticClass:"add-button",on:{click:function(a){return t.$emit("add")}}},[e("i",{staticClass:"el-icon-plus"}),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0\u6807\u7B7E")))])])]),t.loading?e("Spin",{attrs:{fix:""}}):t._e()],1)},K=[];const q={name:"TaskTagSelect",props:{value:{type:Array,default:()=>[]},dataSources:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},max:{type:Number,default:0}},data(){return{searchQuery:"",internalDataSources:[]}},watch:{value:{immediate:!0,handler(){this.syncValueToDataSources()}},dataSources:{immediate:!0,handler(t){this.internalDataSources=[...t],this.syncValueToDataSources()}}},computed:{filteredTags(){return this.internalDataSources.filter(t=>t.name.toLowerCase().includes(this.searchQuery.toLowerCase()))}},methods:{isSelected(t){return this.value.some(s=>s.name===t.name)},toggleTag(t){const s=this.isSelected(t);let e;if(s)e=this.value.filter(a=>a.name!==t.name);else{if(this.max>0&&this.value.length>=this.max){$A.messageWarning(this.$L("\u6700\u591A\u53EA\u80FD\u9009\u62E9 (*) \u4E2A\u6807\u7B7E",this.max));return}e=[...this.value,{name:t.name,color:t.color}]}this.$emit("input",e)},syncValueToDataSources(){if(!this.value||!this.internalDataSources)return;const t=this.value.filter(s=>!this.internalDataSources.some(e=>e.name===s.name));t.length&&(this.internalDataSources=[...t.map(s=>({name:s.name,color:s.color,desc:""})),...this.internalDataSources])}}},f={};var J=r(q,Q,K,!1,G,"8c5775e4",null,null);function G(t){for(let s in f)this[s]=f[s]}var X=function(){return J.exports}(),Z=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-content-history"},[e("Table",{attrs:{"max-height":t.windowHeight-180,columns:t.columns,data:t.list,loading:t.loadIng>0,"no-data-text":t.$L(t.noText),"highlight-row":"",stripe:""}}),t.total>t.pageSize?e("Page",{attrs:{total:t.total,current:t.page,"page-size":t.pageSize,disabled:t.loadIng>0,simple:!0},on:{"on-change":t.setPage,"on-page-size-change":t.setPageSize}}):t._e()],1)},tt=[];const et={name:"TaskContentHistory",props:{taskId:{type:Number,default:0},taskName:{type:String,default:""}},data(){return{loadIng:0,columns:[{title:this.$L("\u65E5\u671F"),key:"created_at",width:168},{title:this.$L("\u63CF\u8FF0"),key:"desc",ellipsis:!0,minWidth:150,render:(t,{row:s})=>t("span",s.desc||"-")},{title:this.$L("\u521B\u5EFA\u4EBA"),width:120,render:(t,{row:s})=>s.userid?t("UserAvatar",{props:{showName:!0,size:22,userid:s.userid}}):t("div","-")},{title:this.$L("\u64CD\u4F5C"),align:"center",width:100,render:(t,{index:s,row:e,column:a})=>s===0&&this.page===1?t("div","-"):t("TableAction",{props:{column:a,menu:[{label:this.$L("\u67E5\u770B"),action:"preview"}]},on:{action:i=>{this.onAction(i,e)}}})}],list:[],page:1,pageSize:10,total:0,noText:""}},mounted(){},watch:{taskId:{handler(t){t&&this.setPage(1)},immediate:!0}},methods:{getLists(){this.taskId!==0&&(this.loadIng++,this.$store.dispatch("call",{url:"project/task/content_history",data:{task_id:this.taskId,page:Math.max(this.page,1),pagesize:Math.max($A.runNum(this.pageSize),10)}}).then(({data:t})=>{this.page=t.current_page,this.total=t.total,this.list=t.data,this.noText="\u6CA1\u6709\u76F8\u5173\u7684\u6570\u636E"}).catch(()=>{this.noText="\u6570\u636E\u52A0\u8F7D\u5931\u8D25"}).finally(t=>{this.loadIng--}))},setPage(t){this.page=t,this.getLists()},setPageSize(t){this.page=1,this.pageSize=t,this.getLists()},onAction(t,s){switch(t){case"preview":const e=(this.taskName||`ID: ${this.taskId}`)+` [${s.created_at}]`,a=`/single/task/content/${this.taskId}?history_id=${s.id}&history_title=${e}`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`task-content-${this.taskId}-${s.id}`,path:a,force:!1,config:{title:e,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:e,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${a}`}}):window.open($A.mainUrl(a.substring(1)));break}}}},k={};var st=r(et,Z,tt,!1,at,"43d23896",null,null);function at(t){for(let s in k)this[s]=k[s]}var it=function(){return st.exports}(),ot=function(){var t=this,s=t.$createElement,e=t._self._c||s;return t.ready&&t.isSubTask?e("li",[e("div",{staticClass:"subtask-icon"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,attrs:{disabled:t.taskId===0,task:t.taskDetail,"load-status":t.taskDetail.loading===!0},on:{"on-update":t.getLogLists}})],1),t.taskDetail.flow_item_name?e("div",{staticClass:"subtask-flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(a){return a.stopPropagation(),t.openMenu(a,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),e("div",{staticClass:"subtask-name"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(a){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(a){t.$set(t.taskDetail,"name",a)},expression:"taskDetail.name"}})],1),e("DatePicker",{staticClass:"subtask-time",attrs:{open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placement:"bottom-end",transfer:""},on:{"on-open-change":t.timeChange,"on-change":t.taskTimeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(a){t.timeValue=a},expression:"timeValue"}},[t.showSubTime?e("div",{class:["time",t.taskDetail.today?"today":"",t.taskDetail.overdue?"overdue":""],on:{click:t.openTime}},[t._v(" "+t._s(t.expiresFormat(t.taskDetail.end_at))+" ")]):e("Icon",{staticClass:"clock",attrs:{type:"ios-clock-outline"},on:{click:t.openTime}})],1),e("UserSelect",{staticClass:"subtask-avatar",attrs:{"multiple-max":10,"avatar-size":20,title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),"add-icon":!1,"project-id":t.taskDetail.project_id,"before-submit":t.onOwner},model:{value:t.ownerData.owner_userid,callback:function(a){t.$set(t.ownerData,"owner_userid",a)},expression:"ownerData.owner_userid"}})],1):t.ready?e("div",{class:{"task-detail":!0,"open-dialog":t.hasOpenDialog,completed:t.taskDetail.complete_at},style:t.taskDetailStyle},[e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-info"},[e("div",{staticClass:"head"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,staticClass:"icon",attrs:{disabled:t.taskId===0,task:t.taskDetail,size:"medium","color-show":!1},on:{"on-update":t.getLogLists}}),t.taskDetail.flow_item_name?e("div",{staticClass:"flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(a){return a.stopPropagation(),t.openMenu(a,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),t.taskDetail.archived_at?e("div",{staticClass:"flow"},[e("span",{staticClass:"archived",on:{click:function(a){return a.stopPropagation(),t.openMenu(a,t.taskDetail)}}},[t._v(t._s(t.$L("\u5DF2\u5F52\u6863")))])]):t._e(),e("div",{staticClass:"nav"},[t.projectName?e("p",[e("span",[t._v(t._s(t.projectName))])]):t._e(),t.columnName?e("p",[e("span",[t._v(t._s(t.columnName))])]):t._e(),t.taskDetail.id?e("p",[e("span",[t._v(t._s(t.taskDetail.id))])]):t._e()]),e("div",{staticClass:"function"},[t.$Electron?e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.$L("\u65B0\u7A97\u53E3\u6253\u5F00")}},[e("i",{staticClass:"taskfont open",on:{click:t.openNewWin}},[t._v("\uE776")])]):t._e(),e("div",{staticClass:"menu"},[e("TaskMenu",{attrs:{disabled:t.taskId===0,task:t.taskDetail,icon:"ios-more","completed-icon":"ios-more",size:"medium","color-show":!1,"show-load":!1},on:{"on-update":t.getLogLists}})],1)],1)],1),e("Scrollbar",{ref:"scroller",staticClass:"scroller"},[t.getOwner.length===0?e("Alert",{staticClass:"receive-box",attrs:{type:"warning"}},[e("span",{staticClass:"receive-text"},[t._v(t._s(t.$L("\u8BE5\u4EFB\u52A1\u5C1A\u672A\u88AB\u9886\u53D6\uFF0C\u70B9\u51FB\u8FD9\u91CC")))]),e("EPopover",{staticClass:"receive-button",attrs:{placement:"bottom"},model:{value:t.receiveShow,callback:function(a){t.receiveShow=a},expression:"receiveShow"}},[e("div",{staticClass:"task-detail-receive"},[e("div",{staticClass:"receive-title"},[e("Icon",{attrs:{type:"ios-help-circle"}}),t._v(" "+t._s(t.$L("\u786E\u8BA4\u8BA1\u5212\u65F6\u95F4\u9886\u53D6\u4EFB\u52A1"))+" ")],1),e("div",{staticClass:"receive-time"},[e("DatePicker",{attrs:{options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placeholder:t.$L("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4"),clearable:!1,editable:!1},on:{"on-change":t.taskTimeChange},model:{value:t.timeValue,callback:function(a){t.timeValue=a},expression:"timeValue"}})],1),e("div",{staticClass:"receive-bottom"},[e("Button",{attrs:{size:"small",type:"text"},on:{click:function(a){t.receiveShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{loading:t.ownerLoad>0,size:"small",type:"primary"},on:{click:function(a){return t.onOwner(!0)}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)]),e("Button",{attrs:{slot:"reference",loading:t.ownerLoad>0,size:"small",type:"primary"},slot:"reference"},[t._v(t._s(t.$L("\u9886\u53D6\u4EFB\u52A1")))])],1)],1):t._e(),e("div",{staticClass:"title"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(a){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(a){t.$set(t.taskDetail,"name",a)},expression:"taskDetail.name"}})],1),e("TEditorTask",{ref:"desc",staticClass:"desc",attrs:{value:t.taskContent,placeholder:t.$L("\u8BE6\u7EC6\u63CF\u8FF0...")},on:{"on-history":t.onHistory,"on-blur":function(a){return t.updateBlur("content",a)}}}),e("Form",{staticClass:"items",attrs:{"label-position":"left","label-width":"auto"},nativeOn:{submit:function(a){a.preventDefault()}}},[t.getTag.length>0||t.tagForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE61E")]),t._v(t._s(t.$L("\u6807\u7B7E"))+" ")]),e("div",{staticClass:"item-content tags"},[e("EPopover",{staticClass:"tags-select",attrs:{placement:"bottom"},model:{value:t.tagShow,callback:function(a){t.tagShow=a},expression:"tagShow"}},[e("TaskTagSelect",{attrs:{"data-sources":t.tagData,loading:t.tagLoad>0,max:10},on:{add:t.onTagAdd},model:{value:t.tagValue,callback:function(a){t.tagValue=a},expression:"tagValue"}}),e("div",{attrs:{slot:"reference"},slot:"reference"},[e("TaskTag",{attrs:{tags:t.getTag}},[t.getTag.length===0?e("li",{staticClass:"add-icon",attrs:{slot:"end"},slot:"end"}):t._e()])],1)],1)],1)]):t._e(),t.taskDetail.p_name?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6EC")]),t._v(t._s(t.$L("\u4F18\u5148\u7EA7"))+" ")]),e("ul",{staticClass:"item-content priority"},[e("li",[e("EDropdown",{ref:"priority",attrs:{trigger:"click",placement:"bottom"},on:{command:function(a){return t.updateData("priority",a)}}},[e("TaskPriority",{attrs:{backgroundColor:t.taskDetail.p_color}},[t._v(t._s(t.taskDetail.p_name))]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.taskPriority,function(a,i){return e("EDropdownItem",{key:i,attrs:{command:a}},[e("i",{staticClass:"taskfont",style:{color:a.color},domProps:{innerHTML:t._s(t.taskDetail.p_name==a.name?"&#xe61d;":"&#xe61c;")}}),t._v(" "+t._s(a.name)+" ")])}),1)],1)],1)])]):t._e(),t.getOwner.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E4")]),t._v(t._s(t.$L("\u8D1F\u8D23\u4EBA"))+" ")]),e("UserSelect",{staticClass:"item-content user",attrs:{"multiple-max":10,"avatar-size":28,title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),"project-id":t.taskDetail.project_id,"add-icon":!1,"before-submit":t.onOwner},model:{value:t.ownerData.owner_userid,callback:function(a){t.$set(t.ownerData,"owner_userid",a)},expression:"ownerData.owner_userid"}})],1):t._e(),t.getAssist.length>0||t.assistForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE63F")]),t._v(t._s(t.$L("\u534F\u52A9\u4EBA\u5458"))+" ")]),e("UserSelect",{ref:"assist",staticClass:"item-content user",attrs:{"multiple-max":10,"avatar-size":28,title:t.$L(t.getAssist.length>0?"\u4FEE\u6539\u534F\u52A9\u4EBA\u5458":"\u6DFB\u52A0\u534F\u52A9\u4EBA\u5458"),"project-id":t.taskDetail.project_id,"disabled-choice":t.assistData.disabled,"add-icon":!1,"before-submit":t.onAssist},model:{value:t.assistData.assist_userid,callback:function(a){t.$set(t.assistData,"assist_userid",a)},expression:"assistData.assist_userid"}})],1):t._e(),t.taskDetail.visibility>1||t.visibleForce||t.visibleKeep?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE77B")]),e("span",{staticClass:"visibility-text color",on:{click:t.showCisibleDropdown}},[t._v(t._s(t.$L("\u53EF\u89C1\u6027"))+" "),e("i",{staticClass:"taskfont"},[t._v("\uE740")])])]),e("div",{staticClass:"item-content user"},[t.taskDetail.visibility==1||t.taskDetail.visibility==2?e("span",{ref:"visibilityText",staticClass:"visibility-text",on:{click:t.showCisibleDropdown}},[t._v(t._s(t.taskDetail.visibility==1?t.$L("\u9879\u76EE\u4EBA\u5458\u53EF\u89C1"):t.$L("\u4EFB\u52A1\u4EBA\u5458\u53EF\u89C1")))]):e("UserSelect",{ref:"visibleUserSelectRef",attrs:{"avatar-size":28,title:t.$L("\u9009\u62E9\u6307\u5B9A\u4EBA\u5458"),"project-id":t.taskDetail.project_id,"add-icon":!1},on:{"on-show-change":t.visibleUserSelectShowChange},model:{value:t.taskDetail.visibility_appointor,callback:function(a){t.$set(t.taskDetail,"visibility_appointor",a)},expression:"taskDetail.visibility_appointor"}})],1)]):t._e(),t.taskDetail.end_at||t.timeForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E8")]),t.taskDetail.end_at?e("span",{staticClass:"visibility-text color",on:{click:t.showAtDropdown}},[t._v(t._s(t.$L("\u622A\u6B62\u65F6\u95F4")))]):e("span",{staticClass:"visibility-text color",on:{click:function(a){t.timeOpen=!0}}},[t._v(t._s(t.$L("\u622A\u6B62\u65F6\u95F4")))])]),e("ul",{staticClass:"item-content"},[e("li",[e("DatePicker",{attrs:{disabled:"",open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",transfer:""},on:{"on-open-change":t.timeChange,"on-change":t.taskTimeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(a){t.timeValue=a},expression:"timeValue"}},[e("div",{staticClass:"picker-time"},[t.taskDetail.end_at?e("div",{staticClass:"time",on:{click:t.showAtDropdown}},[t._v(t._s(t.taskDetail.end_at?t.cutTime:"--"))]):e("div",{staticClass:"time",on:{click:function(a){t.timeOpen=!0}}},[t._v(t._s(t.taskDetail.end_at?t.cutTime:"--"))]),!t.taskDetail.complete_at&&t.taskDetail.end_at?[t.within24Hours(t.taskDetail.end_at)?e("Tag",{attrs:{color:t.tagColor(t.taskDetail)},on:{"on-click":t.showAtDropdown}},[e("i",{staticClass:"taskfont"},[t._v("\uE71D")]),t._v(t._s(t.expiresFormat(t.taskDetail.end_at))+" ")]):t._e(),t.taskDetail.overdue?e("Tag",{attrs:{color:"red"},on:{"on-click":t.showAtDropdown}},[t._v(t._s(t.$L("\u8D85\u671F\u672A\u5B8C\u6210")))]):t._e()]:t._e()],2)])],1)])]):t._e(),t.taskDetail.loop&&t.taskDetail.loop!="never"||t.loopForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE93F")]),t._v(t._s(t.$L("\u91CD\u590D\u5468\u671F"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("EDropdown",{ref:"loop",attrs:{trigger:"click",placement:"bottom"},on:{command:function(a){return t.updateData("loop",a)}}},[e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch||!t.taskDetail.loop_at,content:`${t.$L("\u4E0B\u4E2A\u5468\u671F")}: ${t.taskDetail.loop_at}`,placement:"right"}},[e("span",[t._v(t._s(t.$L(t.loopLabel(t.taskDetail.loop))))])]),e("EDropdownMenu",{staticClass:"task-detail-loop",attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.loops,function(a){return e("EDropdownItem",{key:a.key,attrs:{command:a.key}},[t._v(" "+t._s(t.$L(a.label))+" ")])}),1)],1)],1)])]):t._e(),t.fileList.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E6")]),t._v(t._s(t.$L("\u9644\u4EF6"))+" ")]),e("ul",{staticClass:"item-content file"},[t.taskDetail.file_num>50?e("li",{staticClass:"tip"},[t._v(t._s(t.$L(`\u5171${t.taskDetail.file_num}\u4E2A\u6587\u4EF6\uFF0C\u4EC5\u663E\u793A\u6700\u65B050\u4E2A`)))]):t._e(),t._l(t.fileList,function(a){return e("li",{on:{click:function(i){return t.showFileDropdown(a,i)}}},[a.id?e("img",{staticClass:"file-ext",attrs:{src:a.thumb}}):e("Loading",{staticClass:"file-load"}),e("div",{staticClass:"file-name"},[t._v(t._s(a.name))]),e("div",{staticClass:"file-size"},[t._v(t._s(t.$A.bytesToSize(a.size)))])],1)})],2),e("ul",{staticClass:"item-content file-up"},[e("li",[e("div",{staticClass:"add-button",on:{click:function(a){return t.onUploadClick(!0)}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0\u9644\u4EF6")))])])])])]):t._e(),t.subList.length>0||t.addsubForce?e("FormItem",{attrs:{className:"item-subtask"}},[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F0")]),t._v(t._s(t.$L("\u5B50\u4EFB\u52A1"))+" ")]),t.subList.length>0?e("ul",{staticClass:"item-content subtask"},t._l(t.subList,function(a,i){return e("TaskDetail",{key:i,ref:`subTask_${a.id}`,refInFor:!0,attrs:{"task-id":a.id,"open-task":a,"main-end-at":t.taskDetail.end_at,"can-update-blur":t.canUpdateBlur}})}),1):t._e(),e("ul",{staticClass:"item-content subtask-add"},[e("li",[t.addsubShow?e("Input",{ref:"addsub",staticClass:"add-input",class:{loading:t.addsubLoad>0},attrs:{placeholder:t.$L("+ \u8F93\u5165\u5B50\u4EFB\u52A1\uFF0C\u56DE\u8F66\u6DFB\u52A0\u5B50\u4EFB\u52A1"),icon:t.addsubLoad>0?"ios-loading":"",enterkeyhint:"done"},on:{"on-blur":t.addsubChackClose,"on-keydown":t.addsubKeydown},model:{value:t.addsubName,callback:function(a){t.addsubName=a},expression:"addsubName"}}):e("div",{staticClass:"add-button",on:{click:t.addsubOpen}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0\u5B50\u4EFB\u52A1")))])])],1)])]):t._e()],1),t.menuList.length>0?e("div",{staticClass:"add"},[e("EDropdown",{attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropAdd}},[e("div",{staticClass:"add-button"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0")))]),e("em",[t._v(t._s(t.menuText))])]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.menuList,function(a,i){return e("EDropdownItem",{key:i,attrs:{command:a.command}},[e("div",{staticClass:"item"},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(a.icon)}}),t._v(t._s(t.$L(a.name))+" ")])])}),1)],1)],1):t._e(),e("EDropdown",{ref:"eDropdownRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropVisible}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==1?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u9879\u76EE\u4EBA\u5458"))+" ")],1)]),e("EDropdownItem",{attrs:{command:2}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==2?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u4EFB\u52A1\u4EBA\u5458"))+" ")],1)]),e("EDropdownItem",{attrs:{command:3}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==3?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u6307\u5B9A\u6210\u5458"))+" ")],1)])],1)],1),e("EDropdown",{ref:"eDeadlineRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropDeadline}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[t._v(" "+t._s(t.$L("\u4EFB\u52A1\u5EF6\u671F"))+" ")]),e("EDropdownItem",{attrs:{command:2}},[t._v(" "+t._s(t.$L("\u4FEE\u6539\u65F6\u95F4"))+" ")]),e("EDropdownItem",{attrs:{command:3}},[t._v(" "+t._s(t.$L("\u6E05\u9664\u65F6\u95F4"))+" ")])],1)],1),e("EDropdown",{ref:"eFileRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropFile}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[t._v(" "+t._s(t.$L("\u67E5\u770B\u9644\u4EF6"))+" ")]),e("EDropdownItem",{attrs:{command:2}},[t._v(" "+t._s(t.$L("\u4E0B\u8F7D\u9644\u4EF6"))+" ")]),e("EDropdownItem",{staticClass:"task-calc-warn-text",attrs:{command:3}},[t._v(" "+t._s(t.$L("\u5220\u9664\u9644\u4EF6"))+" ")])],1)],1)],1),e("TaskUpload",{ref:"upload",staticClass:"upload",on:{"on-select-file":t.onSelectFile}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-dialog",style:t.dialogStyle},[t.hasOpenDialog?[t.taskId>0?e("DialogWrapper",{ref:"dialog",attrs:{"dialog-id":t.taskDetail.dialog_id}},[e("div",{staticClass:"head",attrs:{slot:"head"},slot:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(a){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(a){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e()])],1)]):t._e(),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id},on:{"on-load-change":t.logLoadChange}}):t._e()]:e("div",[e("div",{staticClass:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(a){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(a){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e()]),e("div",{staticClass:"menu"},[t.navActive=="dialog"&&t.taskDetail.msg_num>0?e("div",{staticClass:"menu-item",on:{click:function(a){return a.stopPropagation(),t.onSend("open")}}},[t.openLoad>0?e("div",{staticClass:"menu-load"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u4EFB\u52A1\u804A\u5929"))+" "),e("em",[t._v("("+t._s(t.taskDetail.msg_num>999?"999+":t.taskDetail.msg_num)+")")]),e("i",{staticClass:"taskfont"},[t._v("\uE703")])]):t._e()])],1),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id,"show-load":!1},on:{"on-load-change":t.logLoadChange}}):e("div",{staticClass:"no-dialog",on:{drop:function(a){return a.preventDefault(),t.taskPasteDrag(a,"drag")},dragover:function(a){return a.preventDefault(),t.taskDragOver(!0,a)},dragleave:function(a){return a.preventDefault(),t.taskDragOver(!1,a)}}},[e("div",{staticClass:"no-tip"},[t._v(t._s(t.$L("\u6682\u65E0\u6D88\u606F")))]),e("div",{staticClass:"no-input"},[e("ChatInput",{ref:"chatInput",attrs:{"task-id":t.taskId,loading:t.sendLoad>0,maxlength:2e5,placeholder:t.$L("\u8F93\u5165\u6D88\u606F..."),"send-menu":!1},on:{"on-more":t.onEventMore,"on-file":t.onSelectFile,"on-record":t.onRecord,"on-send":t.onSend},model:{value:t.msgText,callback:function(a){t.msgText=a},expression:"msgText"}})],1),t.dialogDrag?e("div",{staticClass:"drag-over",on:{click:function(a){t.dialogDrag=!1}}},[e("div",{staticClass:"drag-text"},[t._v(t._s(t.$L("\u62D6\u52A8\u5230\u8FD9\u91CC\u53D1\u9001")))])]):t._e()])],1)],2),t.taskDetail.id?t._e():e("div",{staticClass:"task-load"},[e("Loading")],1),e("TaskExistTips",{ref:"taskExistTipsRef",on:{onContinue:function(a){return t.updateData("timesSave",t.updateParams)}}}),e("Modal",{attrs:{title:t.$L("\u4EFB\u52A1\u5EF6\u671F"),"mask-closable":!1,styles:{width:"90%",maxWidth:"450px"}},model:{value:t.delayTaskShow,callback:function(a){t.delayTaskShow=a},expression:"delayTaskShow"}},[e("Form",t._b({ref:"formDelayTaskRef",attrs:{model:t.delayTaskForm,rules:t.delayTaskRule},nativeOn:{submit:function(a){a.preventDefault()}}},"Form",t.formOptions,!1),[e("FormItem",{attrs:{label:t.$L("\u5EF6\u671F\u65F6\u957F"),prop:"time"}},[e("Input",{attrs:{type:"number",placeholder:t.$L("\u8BF7\u8F93\u5165\u65F6\u957F")},scopedSlots:t._u([{key:"append",fn:function(){return[e("Select",{staticStyle:{width:"auto"},model:{value:t.delayTaskForm.type,callback:function(a){t.$set(t.delayTaskForm,"type",a)},expression:"delayTaskForm.type"}},[e("Option",{attrs:{value:"hour"}},[t._v(t._s(t.$L("\u5C0F\u65F6")))]),e("Option",{attrs:{value:"day"}},[t._v(t._s(t.$L("\u5929")))])],1)]},proxy:!0}]),model:{value:t.delayTaskForm.time,callback:function(a){t.$set(t.delayTaskForm,"time",a)},expression:"delayTaskForm.time"}}),e("div",{staticClass:"form-tip form-quick-select"},[e("span",[t._v(t._s(t.$L("\u5FEB\u6377\u9009\u62E9"))+":")]),t._l(t.delayTaskQuicks,function(a,i){return e("em",{key:i,on:{click:function(o){return t.onTaskQuick(a.time,a.type)}}},[t._v(t._s(t.$L(a.name)))])})],2)],1),e("FormItem",{attrs:{label:t.$L("\u5EF6\u671F\u5907\u6CE8"),prop:"remark"}},[e("Input",{attrs:{type:"textarea",placeholder:t.$L("\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8")},model:{value:t.delayTaskForm.remark,callback:function(a){t.$set(t.delayTaskForm,"remark",a)},expression:"delayTaskForm.remark"}})],1)],1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{on:{click:function(a){t.delayTaskShow=!1}}},[t._v(t._s(t.$L("\u5173\u95ED")))]),e("Button",{attrs:{type:"primary"},on:{click:t.onDelay}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u4EFB\u52A1\u63CF\u8FF0\u5386\u53F2\u8BB0\u5F55"),"mask-closable":!1,styles:{width:"90%",maxWidth:"700px"}},model:{value:t.historyShow,callback:function(a){t.historyShow=a},expression:"historyShow"}},[t.historyShow?e("TaskContentHistory",{attrs:{"task-id":t.taskDetail.id,"task-name":t.taskDetail.name}}):t._e(),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{on:{click:function(a){t.historyShow=!1}}},[t._v(t._s(t.$L("\u5173\u95ED")))])],1)],1),e("TaskTagAdd",{ref:"addTag",attrs:{"project-id":t.taskDetail.project_id},on:{"on-save":t.onTagAddSave}})],1):t._e()},nt=[];const lt={name:"TaskDetail",components:{TaskTagAdd:v,TaskContentHistory:it,TEditorTask:P,UserSelect:b,TaskTag:w,TaskTagSelect:X,TaskExistTips:E,ChatInput:C,TaskMenu:T,ProjectLog:D,DialogWrapper:x,TaskUpload:W,TaskPriority:y},props:{taskId:{type:Number,default:0},openTask:{type:Object,default:()=>({})},mainEndAt:{default:null},canUpdateBlur:{type:Boolean,default:!0},modalMode:{type:Boolean,default:!1}},data(){return{ready:!1,taskDetail:{},ownerData:{},ownerLoad:0,receiveShow:!1,tagForce:!1,tagShow:!1,tagValue:[],tagBakValue:[],tagData:[],tagLoad:0,assistForce:!1,assistData:{},assistLoad:0,visibleForce:!1,addsubForce:!1,addsubShow:!1,addsubName:"",addsubLoad:0,timeForce:!1,timeOpen:!1,timeValue:[],timeOptions:{shortcuts:$A.timeOptionShortcuts()},loopForce:!1,nowTime:$A.dayjs().unix(),nowInterval:null,msgText:"",msgFile:[],msgRecord:{},navActive:"dialog",logLoadIng:!1,sendLoad:0,openLoad:0,dialogDrag:!1,imageAttachment:!0,loops:[{key:"never",label:"\u4ECE\u4E0D"},{key:"day",label:"\u6BCF\u5929"},{key:"weekdays",label:"\u5DE5\u4F5C\u65E5"},{key:"week",label:"\u6BCF\u5468"},{key:"twoweeks",label:"\u6BCF\u4E24\u5468"},{key:"month",label:"\u6BCF\u6708"},{key:"year",label:"\u6BCF\u5E74"},{key:"custom",label:"\u81EA\u5B9A\u4E49"}],updateParams:{},delayTaskShow:!1,delayTaskQuicks:[],delayTaskForm:{type:"hour",time:24,remark:""},delayTaskRule:{time:[{required:!0,message:this.$L("\u8BF7\u8F93\u5165\u65F6\u957F"),trigger:"blur",pattern:/^\d+(\.\d+)?$/}],remark:[{required:!0,message:this.$L("\u8BF7\u8F93\u5165\u5907\u6CE8"),trigger:"blur"}]},historyShow:!1}},created(){const t=$A.getObject(this.$route.query,"navActive");["dialog","log"].includes(t)&&(this.navActive=t),$A.IDBJson("delayTaskForm").then(s=>{s.time&&this.$set(this.delayTaskForm,"time",Math.round(s.time*100)/100),s.type&&this.$set(this.delayTaskForm,"type",s.type)})},mounted(){this.nowInterval=setInterval(()=>{this.nowTime=$A.dayjs().unix()},1e3),h.on("receiveTask",this.onReceiveShow)},destroyed(){clearInterval(this.nowInterval),h.off("receiveTask",this.onReceiveShow)},computed:{..._(["systemConfig","cacheProjects","cacheColumns","cacheTasks","taskContents","taskFiles","taskPriority","dialogId","formOptions"]),projectName(){if(!this.taskDetail.project_id)return"";if(this.taskDetail.project_name)return this.taskDetail.project_name;const t=this.cacheProjects.find(({id:s})=>s==this.taskDetail.project_id);return t?t.name:""},columnName(){if(!this.taskDetail.column_id)return"";if(this.taskDetail.column_name)return this.taskDetail.column_name;const t=this.cacheColumns.find(({id:s})=>s==this.taskDetail.column_id);return t?t.name:""},taskContent(){if(!this.taskId)return"";let t=this.taskContents.find(({task_id:s})=>s==this.taskId);return t?t.content:""},fileList(){return this.taskId?this.taskFiles.filter(({task_id:t})=>t==this.taskId).sort((t,s)=>s.id-t.id):[]},subList(){return this.taskId?this.cacheTasks.filter(t=>t.parent_id==this.taskId).sort((t,s)=>t.id-s.id):[]},hasOpenDialog(){return this.taskDetail.dialog_id>0&&this.windowLandscape},dialogStyle(){const{windowHeight:t,hasOpenDialog:s}=this,e=Math.min(1100,t);if(!e)return{};if(!s)return{};const a=e>900?200:70;return{minHeight:e-a-48+"px"}},taskDetailStyle(){const{modalMode:t,windowHeight:s,hasOpenDialog:e}=this,a=Math.min(1100,s);if(t&&e){const i=a>900?200:70;return{maxHeight:a-i-30+"px"}}return{}},cutTime(){const{taskDetail:t}=this;let s=$A.dayjs(t.start_at),e=$A.dayjs(t.end_at),a="";return s.format("YYYY/MM/DD")==e.format("YYYY/MM/DD")?a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("HH:mm"):s.year()==e.year()?(a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("MM/DD HH:mm"),a=a.replace(/( 00:00| 23:59)/g,"")):(a=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("YYYY/MM/DD HH:mm"),a=a.replace(/( 00:00| 23:59)/g,"")),a},getTag(){const{taskDetail:t}=this;return $A.isArray(t.task_tag)?t.task_tag:[]},getOwner(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:s})=>s===1).sort((s,e)=>s.id-e.id):[]},getAssist(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:s})=>s===0).sort((s,e)=>s.id-e.id):[]},menuList(){const{taskDetail:t}=this,s=[];return $A.arrayLength(t.task_tag)===0&&s.push({command:"tag",icon:"&#xe61e;",name:"\u6807\u7B7E"}),t.p_name||s.push({command:"priority",icon:"&#xe6ec;",name:"\u4F18\u5148\u7EA7"}),$A.isArray(t.task_user)&&t.task_user.find(({owner:e})=>e===0)||s.push({command:"assist",icon:"&#xe63f;",name:"\u534F\u52A9\u4EBA\u5458"}),t.visibility<=1&&!this.visibleKeep&&s.push({command:"visible",icon:"&#xe77b;",name:"\u53EF\u89C1\u6027"}),t.end_at||s.push({command:"times",icon:"&#xe6e8;",name:"\u622A\u6B62\u65F6\u95F4"}),(!t.loop||t.loop=="never")&&s.push({command:"loop",icon:"&#xe93f;",name:"\u91CD\u590D\u5468\u671F"}),this.fileList.length==0&&s.push({command:"file",icon:"&#xe6e6;",name:"\u9644\u4EF6"}),this.subList.length==0&&s.push({command:"subtask",icon:"&#xe6f0;",name:"\u5B50\u4EFB\u52A1"}),s},menuText(){const{menuList:t}=this;let s="";return t.length>0&&t.forEach((e,a)=>{a>0&&(s+=" / "),s+=this.$L(e.name)}),s},visibleKeep(){return this.systemConfig.task_visible==="open"},isSubTask({taskDetail:t}){return t.parent_id>0},showSubTime({taskDetail:t,mainEndAt:s}){return t.parent_id>0&&!t.complete_at&&t.end_at&&t.end_at!=s}},watch:{openTask:{handler(t){this.taskDetail=$A.cloneJSON(t),this.__openTask&&clearTimeout(this.__openTask),this.__openTask=setTimeout(s=>{var e;return(e=this.$refs.name)==null?void 0:e.resizeTextarea()},100)},immediate:!0,deep:!0},taskId:{handler(t){t>0?this.ready=!0:(this.windowPortrait&&$A.onBlur(),this.timeOpen=!1,this.timeForce=!1,this.loopForce=!1,this.tagForce=!1,this.assistForce=!1,this.visibleForce=!1,this.addsubForce=!1,this.receiveShow=!1,this.$refs.chatInput&&this.$refs.chatInput.hidePopover())},immediate:!0},getOwner:{handler(t){const s=t.map(({userid:e})=>e);this.$set(this.taskDetail,"owner_userid",s),this.$set(this.ownerData,"owner_userid",s),this.$set(this.assistData,"disabled",t.map(({userid:e})=>e).filter(e=>e!=this.userId))},immediate:!0},getAssist:{handler(t){const s=t.map(({userid:e})=>e);this.$set(this.taskDetail,"assist_userid",s),this.$set(this.assistData,"assist_userid",s)},immediate:!0},receiveShow(t){t&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])},"taskDetail.visibility_appointor":{handler(t){(t==null?void 0:t.filter(s=>s).length)>0&&(this.taskDetail.visibility=3,this.updateVisible())},immediate:!0},tagShow(t){if(t){this.tagValue=this.getTag,this.tagBakValue=$A.cloneJSON(this.tagValue);const s=this.tagValue.length===0&&this.tagData.length===0;s&&this.tagLoad++,this.$store.dispatch("call",{url:"project/tag/list",data:{project_id:this.taskDetail.project_id}}).then(e=>{this.tagData=e.data}).finally(e=>{s&&this.tagLoad--})}else(()=>{if(this.tagValue.length!==this.tagBakValue.length)return!0;const e=o=>[...o].map(({name:n,color:l})=>({name:n,color:l})).sort((n,l)=>n.name.localeCompare(l.name)),a=e(this.tagValue),i=e(this.tagBakValue);return JSON.stringify(a)!==JSON.stringify(i)})()&&this.updateData("tag",this.tagValue)}},methods:{onReceiveShow(){this.receiveShow=!0},within24Hours(t){return $A.dayjs(t).unix()-this.nowTime<86400},expiresFormat(t){return $A.countDownFormat(this.nowTime,t)},tagColor(t){return t.overdue?"red":t.today?"orange":"blue"},loopLabel(t){const s=this.loops.find(e=>e.key===t);return s?s.label:t?`\u6BCF${t}\u5929`:"\u4ECE\u4E0D"},onNameKeydown(t){t.keyCode===13&&(t.shiftKey||(t.preventDefault(),this.updateData("name")))},checkUpdate(t){let s=!1;if(this.openTask.name!=this.taskDetail.name)if(s=!0,t===!0)this.updateData("name");else return t===!1&&this.$refs.name.focus(),!0;if(this.$refs.desc&&this.$refs.desc.getContent()!=this.taskContent)if(s=!0,t===!0)this.updateData("content");else return t===!1&&this.$refs.desc.focus(),!0;if(this.addsubShow&&this.addsubName)if(s=!0,t===!0)this.onAddsub();else return t===!1&&this.$refs.addsub.focus(),!0;return this.subList.some(({id:e})=>{this.$refs[`subTask_${e}`][0].checkUpdate(t)&&(s=!0)}),s},onHistory(){this.historyShow=!0},updateBlur(t,s){this.canUpdateBlur&&this.updateData(t,s)},updateData(t,s){let e=null;switch(t){case"priority":this.$set(this.taskDetail,"p_level",s.priority),this.$set(this.taskDetail,"p_name",s.name),this.$set(this.taskDetail,"p_color",s.color),t=["p_level","p_name","p_color"];break;case"times":if(!this.taskDetail.start_at){this.isExistTask(s).then(()=>{this.updateData("timesSave",s)});return}if(Math.abs($A.dayjs(this.taskDetail.start_at).unix()-$A.dayjs(s.start_at).unix())<60&&Math.abs($A.dayjs(this.taskDetail.end_at).unix()-$A.dayjs(s.end_at).unix())<60)return;if(s.desc){this.isExistTask(s).then(()=>{this.updateData("timesSave",s)});return}if(this.isSubTask&&!this.showSubTime){this.isExistTask(s).then(()=>{this.updateData("timesSave",s)});return}let i=!s.start_at||!s.end_at,o=`\u4FEE\u6539${this.isSubTask?"\u5B50\u4EFB\u52A1":"\u4EFB\u52A1"}\u65F6\u95F4`,n="\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8";i&&(o=`\u6E05\u9664${this.isSubTask?"\u5B50\u4EFB\u52A1":"\u4EFB\u52A1"}\u65F6\u95F4`,n="\u8BF7\u8F93\u5165\u6E05\u9664\u5907\u6CE8"),$A.modalInput({title:o,placeholder:n,okText:"\u786E\u5B9A",okType:i?"warning":"primary",onOk:d=>d?(s.desc=d,this.isExistTask(s).then(()=>{this.updateData("timesSave",s)}),!1):n});return;case"timesSave":t="times",this.$set(this.taskDetail,"times",[s.start_at,s.end_at,s.desc]);break;case"loop":if(s==="custom"){this.customLoop();return}this.$set(this.taskDetail,"loop",s);break;case"content":const l=this.$refs.desc.getContent();if(l==this.taskContent.replace(/\s+original-(width|height)="[^"]*"/g,""))return;if(!this.windowTouch||s==="force"){this.updateData("contentSave",{content:l});return}$A.modalConfirm({title:"\u6E29\u99A8\u63D0\u793A",content:"\u662F\u5426\u4FDD\u5B58\u7F16\u8F91\u5185\u5BB9\uFF1F",onOk:()=>{this.updateData("contentSave",{content:l})},onCancel:()=>{this.$refs.desc.updateContent(this.taskContent)}});return;case"contentSave":this.$set(this.taskDetail,"content",s.content),t="content",e=()=>{this.$store.dispatch("saveTaskContent",{task_id:this.taskId,content:s.content})};break;case"tag":this.$set(this.taskDetail,"task_tag",s),t="task_tag";break}const a={task_id:this.taskDetail.id};($A.isArray(t)?t:[t]).forEach(i=>{let o=this.taskDetail[i],n=this.openTask[i];$A.jsonStringify(o)!=$A.jsonStringify(n)&&(a[i]=o)}),!(Object.keys(a).length<=1)&&this.$store.dispatch("taskUpdate",a).then(({msg:i})=>{$A.messageSuccess(i),typeof e=="function"&&e()}).catch(({msg:i})=>{$A.modalError(i)})},isExistTask(t){return new Promise(s=>{if(!t.start_at||!t.end_at){s();return}this.updateParams=Object.assign({},t);const e=this.$refs.taskExistTipsRef;if(!e){s();return}e.isExistTask({taskid:this.taskDetail.id,userids:this.taskDetail.owner_userid,timerange:[t.start_at,t.end_at]},600).then(a=>{!a&&s()})})},customLoop(){let t=this.taskDetail.loop||1;$A.Modal.confirm({render:s=>s("div",[s("div",{style:{fontSize:"16px",fontWeight:"500",marginBottom:"20px"}},this.$L("\u91CD\u590D\u5468\u671F")),s("Input",{style:{width:"160px",margin:"0 auto"},props:{type:"number",value:t,maxlength:3},on:{input:e=>{t=$.runNum(e)}}},[s("span",{slot:"prepend"},this.$L("\u6BCF")),s("span",{slot:"append"},this.$L("\u5929"))])]),onOk:s=>{this.$Modal.remove(),t>0&&this.updateData("loop",t)},loading:!0,okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88")})},async taskTimeChange(){const t=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");/\s+(00:00|23:59)$/.test(t[0])&&/\s+(00:00|23:59)$/.test(t[1])&&(this.timeValue=await this.$store.dispatch("taskDefaultTime",t))},async onOwner(t){let s={task_id:this.taskDetail.id,owner:this.ownerData.owner_userid};if(t===!0){if(this.getOwner.length>0){this.receiveShow=!1,$A.messageError("\u4EFB\u52A1\u5DF2\u88AB\u9886\u53D6");return}const e=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");if(!(e[0]&&e[1])){$A.messageError("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4");return}s.times=e,s.owner=this.ownerData.owner_userid=[this.userId]}if($A.jsonStringify(this.taskDetail.owner_userid)!==$A.jsonStringify(this.ownerData.owner_userid))return $A.count(s.owner)==0&&(s.owner=""),this.ownerLoad++,new Promise((e,a)=>{this.$store.dispatch("taskUpdate",s).then(({msg:i})=>{$A.messageSuccess(i),this.ownerLoad--,this.receiveShow=!1,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{}),e()}).catch(({msg:i})=>{$A.modalError(i),this.ownerLoad--,this.receiveShow=!1,a()})})},onAssist(){if($A.jsonStringify(this.taskDetail.assist_userid)!==$A.jsonStringify(this.assistData.assist_userid))return new Promise((t,s)=>{this.getOwner.find(({userid:e})=>e===this.userId)&&this.assistData.assist_userid.find(e=>e===this.userId)?$A.modalConfirm({content:"\u4F60\u5F53\u524D\u662F\u8D1F\u8D23\u4EBA\uFF0C\u786E\u5B9A\u8981\u8F6C\u4E3A\u534F\u52A9\u4EBA\u5458\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",onOk:()=>{this.onAssistConfirm().then(t).catch(s)},onCancel:()=>{s()}}):this.onAssistConfirm().then(t).catch(s)})},onAssistConfirm(){return new Promise((t,s)=>{let e=this.assistData.assist_userid;e.length===0&&(e=!1),this.assistLoad++,this.$store.dispatch("taskUpdate",{task_id:this.taskDetail.id,assist:e}).then(({msg:a})=>{$A.messageSuccess(a),this.assistLoad--,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{}),t()}).catch(({msg:a})=>{$A.modalError(a),this.assistLoad--,s()})})},openTime(){this.timeOpen=!this.timeOpen,this.timeOpen&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])},timeChange(t){t||(this.timeOpen=!1)},timeClear(){this.updateData("times",{start_at:!1,end_at:!1}),this.timeOpen=!1},timeOk(){const t=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");this.updateData("times",{start_at:t[0],end_at:t[1]}),this.timeOpen=!1},addsubOpen(){this.addsubShow=!0,this.$nextTick(()=>{this.$refs.addsub.focus()})},addsubChackClose(){this.addsubName==""&&(this.addsubShow=!1)},addsubKeydown(t){if(t.keyCode===13){if(t.shiftKey||this.addsubLoad>0)return;t.preventDefault(),this.onAddsub()}},onAddsub(){if(this.addsubName==""){$A.messageError("\u4EFB\u52A1\u63CF\u8FF0\u4E0D\u80FD\u4E3A\u7A7A");return}this.addsubLoad++,this.$store.dispatch("taskAddSub",{task_id:this.taskDetail.id,name:this.addsubName}).then(({msg:t})=>{$A.messageSuccess(t),this.addsubLoad--,this.addsubName=""}).catch(({msg:t})=>{$A.modalError(t),this.addsubLoad--})},getLogLists(){this.navActive=="log"&&this.$refs.log.getLists(!0)},logLoadChange(t){this.logLoadIng=t},dropAdd(t){switch(t){case"tag":this.tagForce=!0,this.$nextTick(()=>{this.tagShow=!0});break;case"priority":this.$set(this.taskDetail,"p_name",this.$L("\u672A\u8BBE\u7F6E")),this.$nextTick(()=>{this.$refs.priority.show()});break;case"assist":this.assistForce=!0,this.$nextTick(()=>{this.$refs.assist.onSelection()});break;case"visible":this.visibleForce=!0,this.$nextTick(()=>{this.showCisibleDropdown(null)});break;case"times":this.timeForce=!0,this.$nextTick(()=>{this.openTime()});break;case"loop":this.loopForce=!0,this.$nextTick(()=>{this.$refs.loop.show()});break;case"file":this.onUploadClick(!0);break;case"subtask":this.addsubForce=!0,this.$nextTick(()=>{this.addsubOpen()});break}},onEventMore(t){["image","file"].includes(t)&&this.onUploadClick(!1)},onUploadClick(t){this.imageAttachment=!!t,this.$refs.upload.handleClick()},msgDialog(t=null,s=!1){this.sendLoad>0||this.openLoad>0||(s===!0?this.openLoad++:this.sendLoad++,this.$store.dispatch("call",{url:"project/task/dialog",data:{task_id:this.taskDetail.id}}).then(({data:e})=>{this.$store.dispatch("saveTask",{id:e.id,dialog_id:e.dialog_id}),this.$store.dispatch("saveDialog",e.dialog_data),$A.isSubElectron?this.resizeDialog().then(()=>{this.sendDialogMsg(t)}):this.$nextTick(()=>{if(this.windowPortrait){$A.onBlur();const a={time:$A.dayjs().unix()+10,msgRecord:this.msgRecord,msgFile:this.msgFile,msgText:typeof t=="string"&&t?t:this.msgText,dialogId:e.dialog_id};this.msgRecord={},this.msgFile=[],this.msgText="",this.$nextTick(i=>{this.dialogId>0&&this.$store.dispatch("openTask",0),this.$store.dispatch("openDialog",e.dialog_id).then(o=>{this.$store.state.dialogMsgTransfer=a})})}else this.sendDialogMsg(t)})}).catch(({msg:e})=>{$A.modalError(e)}).finally(e=>{s===!0?this.openLoad--:this.sendLoad--}))},sendDialogMsg(t=null){typeof t=="string"&&t?(this.autoSaveTextDraft(),this.$refs.dialog.sendMsg(t)):this.msgFile.length>0?(this.autoSaveTextDraft(),this.$refs.dialog.sendFileMsg(this.msgFile.map(s=>Object.assign(s,{ajaxExtraData:{image_attachment:this.imageAttachment?1:0}})))):this.msgText&&this.$refs.dialog.sendMsg(this.msgText),this.msgFile=[],this.msgText=""},autoSaveTextDraft(){!this.msgText||this.$store.dispatch("saveDialogDraft",{id:this.taskDetail.dialog_id,extra_draft_content:this.msgText})},taskPasteDrag(t,s){if(this.dialogDrag=!1,$A.dataHasFolder(s==="drag"?t.dataTransfer:t.clipboardData)){t.preventDefault(),$A.modalWarning(`\u6682\u4E0D\u652F\u6301${s==="drag"?"\u62D6\u62FD":"\u7C98\u8D34"}\u6587\u4EF6\u5939\u3002`);return}const e=s==="drag"?t.dataTransfer.files:t.clipboardData.files;this.msgFile=Array.prototype.slice.call(e),this.msgFile.length>0&&(t.preventDefault(),this.msgDialog())},taskDragOver(t,s){let e=this.__dialogDrag=$A.randomString(8);if(!t)setTimeout(()=>{e===this.__dialogDrag&&(this.dialogDrag=t)},150);else{if(s.dataTransfer.effectAllowed==="move")return;this.dialogDrag=!0}},onSelectFile(t){this.msgFile=$A.isArray(t)?t:[t],this.msgDialog()},onRecord(t){this.msgRecord=t,this.msgDialog()},onSend(t){this.$refs.chatInput&&this.$refs.chatInput.hidePopover(),t==="open"?this.msgDialog(null,!0):this.msgDialog(t)},deleteFile(t){this.$set(t,"_show_menu",!1),this.$store.dispatch("forgetTaskFile",t.id),this.$store.dispatch("call",{url:"project/task/filedelete",data:{file_id:t.id}}).catch(({msg:s})=>{$A.modalError(s),this.$store.dispatch("getTaskFiles",this.taskDetail.id)})},openMenu(t,s){const e=this.$refs[`taskMenu_${s.id}`];e&&e.handleClick(t)},openNewWin(){let t={title:this.taskDetail.name,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,this.$el.clientWidth+72),height:Math.min(window.screen.availHeight,this.$el.clientHeight+72),minWidth:600,minHeight:450};this.hasOpenDialog&&(t.minWidth=800,t.minHeight=600),this.$store.dispatch("openChildWindow",{name:`task-${this.taskDetail.id}`,path:`/single/task/${this.taskDetail.id}?navActive=${this.navActive}`,force:!1,config:t}),this.$store.dispatch("openTask",0)},resizeDialog(){return new Promise(t=>{this.$Electron.sendMessage("windowSize",{width:Math.max(1100,this.windowWidth),height:Math.max(720,this.windowHeight),minWidth:800,minHeight:600,autoZoom:!0});let s=0,e=setInterval(()=>{s++,(this.$refs.dialog||s>20)&&(clearInterval(e),this.$refs.dialog&&t())},100)})},viewFile(t){if(["jpg","jpeg","webp","gif","png"].includes(t.ext)){const e=this.fileList.filter(i=>["jpg","jpeg","webp","gif","png"].includes(i.ext)),a=e.findIndex(i=>i.id===t.id);a>-1?this.$store.dispatch("previewImage",{index:a,list:e.map(i=>({src:i.path,width:i.width,height:i.height}))}):this.$store.dispatch("previewImage",{index:0,list:[{src:t.path,width:t.width,height:t.height}]});return}const s=`/single/file/task/${t.id}`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`file-task-${t.id}`,path:s,userAgent:"/hideenOfficeTitle/",force:!1,config:{title:`${t.name} (${$A.bytesToSize(t.size)})`,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:`${t.name} (${$A.bytesToSize(t.size)})`,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${s}`}}):window.open($A.mainUrl(s.substring(1)))},downFile(t){$A.modalConfirm({language:!1,title:this.$L("\u4E0B\u8F7D\u6587\u4EF6"),okText:this.$L("\u7ACB\u5373\u4E0B\u8F7D"),content:`${t.name} (${$A.bytesToSize(t.size)})`,onOk:()=>{this.$store.dispatch("downUrl",$A.apiUrl(`project/task/filedown?file_id=${t.id}`))}})},showDropdown(t,s){const e=this.$refs.scroller.$el.getBoundingClientRect(),a=t.$el;a.style.top=s.top-e.top+"px",a.style.left=s.left-e.left+"px",a.style.width=s.width+"px",a.style.height=s.height+"px",t.visible&&t.hide(),setTimeout(()=>{t.show()},0)},showCisibleDropdown(t){var e;let s=null;t===null?s=(e=this.$refs.visibilityText)==null?void 0:e.getBoundingClientRect():s=t.target.getBoundingClientRect(),s!==null&&this.showDropdown(this.$refs.eDropdownRef,s)},showAtDropdown({target:t}){this.timeOpen=!1,this.showDropdown(this.$refs.eDeadlineRef,t.getBoundingClientRect())},visibleUserSelectShowChange(t){if(!t&&this.taskDetail.visibility_appointor.filter(s=>s).length==0){let s=this.taskDetail.old_visibility;this.taskDetail.visibility=s>2?1:s||1,this.taskDetail.visibility<3&&this.updateVisible()}},dropVisible(t){switch(t){case 1:case 2:this.taskDetail.visibility=t,this.updateVisible();break;case 3:this.taskDetail.old_visibility=this.taskDetail.visibility,this.taskDetail.visibility=t,this.$nextTick(()=>{this.$refs.visibleUserSelectRef.onSelection()});break}},dropDeadline(t){switch(t){case 1:this.delayTaskQuicks=[{time:1,type:"day",name:"1\u5929"},{time:2,type:"day",name:"2\u5929"},{time:3,type:"day",name:"3\u5929"},{time:5,type:"day",name:"5\u5929"}];const s=$A.dayjs(`${$A.dayjs().format("YYYY-MM-DD")} ${this.systemConfig.task_default_time[1]}`),e=s.diff($A.dayjs(this.taskDetail.end_at),"hour",!0).toFixed(2),a=s.diff($A.dayjs(this.taskDetail.end_at).subtract(1,"day"),"day",!0).toFixed(2),i={time:e,type:"hour",name:"\u4ECA\u5929\u4E0B\u73ED\u524D"},o={time:a,type:"day",name:"\u660E\u5929\u4E0B\u73ED\u524D"};i.time>=24&&(i.type="day",i.time=(i.time/24).toFixed(2)),o.time>0&&this.delayTaskQuicks.unshift(o),i.time>0&&this.delayTaskQuicks.unshift(i),this.delayTaskShow=!0;break;case 2:this.openTime();break;case 3:this.updateData("times",{start_at:!1,end_at:!1});break}},onDelay(){this.$refs.formDelayTaskRef.validate(t=>{if(!t)return;let{type:s,time:e}=this.delayTaskForm;s==="day"?(s="minute",e=e*24*60):s==="hour"&&(s="minute",e=e*60);const a=$A.dayjs(this.taskDetail.end_at).add(e,s);this.updateData("times",{start_at:this.taskDetail.start_at,end_at:a.format("YYYY-MM-DD HH:mm:ss"),desc:this.delayTaskForm.remark}),this.delayTaskShow=!1,this.delayTaskForm.remark="",$A.IDBSet("delayTaskForm",this.delayTaskForm)})},showFileDropdown(t,{target:s}){this.operationFile=t,this.showDropdown(this.$refs.eFileRef,s.getBoundingClientRect())},dropFile(t){switch(t){case 1:this.viewFile(this.operationFile);break;case 2:this.downFile(this.operationFile);break;case 3:$A.modalConfirm({title:"\u5220\u9664\u6587\u4EF6",content:`\u4F60\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6\u3010${this.operationFile.name}\u3011\u5417\uFF1F`,onOk:()=>{this.deleteFile(this.operationFile)}});break}},updateVisible(){this.updateData(["visibility","visibility_appointor"])},onTaskQuick(t,s){this.$set(this.delayTaskForm,"time",Math.round(t*100)/100),this.$set(this.delayTaskForm,"type",s)},onTagAdd(){this.tagValue=this.getTag,this.tagBakValue=$A.cloneJSON(this.tagValue),this.tagShow=!1,this.$refs.addTag.onOpen(null)},onTagAddSave(t){const s=this.tagValue,e=t.filter(({data:i})=>i&&i.id>0).map(({data:i})=>i),a=[...e,...s.filter(i=>!e.some(o=>o.name===i.name))];this.updateData("tag",a)}}},g={};var rt=r(lt,ot,nt,!1,dt,null,null,null);function dt(t){for(let s in g)this[s]=g[s]}var ft=function(){return rt.exports}();export{P as T,E as a,ft as b};

import{a as O,m as v}from"./vuex.cc7cb26e.js";import{F as U,D as b,C as j,t as N,c as z}from"./index.650e7670.js";import{n as f,U as F,e as u,i as q,a as $}from"./app.8392181e.js";import{D as G}from"./index.ea5a0197.js";import{V as W}from"./vue-virtual-scroll-list-hi.a171e791.js";import{I as V}from"./ImgUpload.b24e2398.js";import{U as H}from"./tip.9cde19f5.js";import{l as K}from"./lodash.18c5398d.js";var J=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Upload",{ref:"upload",attrs:{name:"files",action:t.actionUrl,headers:t.headers,data:t.params,multiple:"",format:t.uploadFormat,"show-upload-list":!1,"max-size":t.maxSize,"before-upload":t.handleBeforeUpload,"on-progress":t.handleProgress,"on-success":t.handleSuccess,"on-format-error":t.handleFormatError,"on-exceeded-size":t.handleMaxSize}})},Q=[];const Y={name:"DialogUpload",props:{dialogId:{type:Number,default:0},maxSize:{type:Number,default:1024e3}},data(){return{fileMsgCaches:{},uploadFormat:[],actionUrl:$A.apiUrl("dialog/msg/sendfile")}},computed:{...O(["getDialogQuote"]),headers(){return{fd:$A.getSessionStorageString("userWsFd"),token:this.userToken}},params(){var t;return{dialog_id:this.dialogId,reply_id:((t=this.quoteData)==null?void 0:t.id)||0}},quoteData(){var t;return((t=this.getDialogQuote(this.dialogId))==null?void 0:t.content)||null}},methods:{fileMsgName(t){return`${t.name}::${t.size}`},fileMsgData(t,s=void 0){const e=this.fileMsgName(t);if($A.isJson(s)){this.fileMsgCaches[e]=Object.assign(this.fileMsgCaches[e]||{},s);return}s={type:"file",thumb:null,width:-1,height:-1,name:t.name,size:t.size,ext:t.name.split(".").pop()};let{ext:i}=s;i==="docx"?i="doc":i==="xlsx"?i="xls":i==="pptx"&&(i="ppt"),["ai","avi","bmp","cdr","doc","eps","gif","mov","mp3","mp4","pdf","ppt","pr","psd","rar","svg","tif","txt","xls","zip"].includes(i)?s.thumb=$A.mainUrl(`images/ext/${i}.png`):s.thumb=$A.mainUrl("images/ext/file.png"),this.fileMsgCaches[e]=s},handleBeforeUpload(t){return new Promise(s=>{if(this.fileMsgData(t),/\.(jpe?g|webp|png|gif)$/i.test(t.name)){this.$store.dispatch("showSpinner",600),this.imageFileToObject(t).then(e=>{this.fileMsgData(t,e),s()}).finally(()=>{this.$store.dispatch("hiddenSpinner")});return}s()})},handleProgress(t,s){if(s.tempId===void 0){this.$parent.$options.name==="DialogWrapper"?s.tempId=this.$parent.getTempId():s.tempId=$A.randNum(1e9,9999999999),s.msg={};const e=this.fileMsgName(s);this.fileMsgCaches[e]&&(s.msg=this.fileMsgCaches[e],delete this.fileMsgCaches[e])}this.$emit("on-progress",s)},handleSuccess(t,s){t.ret===1?(s.data=t.data,this.$emit("on-success",s),t.data.task_id&&this.$store.dispatch("getTaskFiles",t.data.task_id)):($A.modalWarning({title:"\u53D1\u9001\u5931\u8D25",content:"\u6587\u4EF6 "+s.name+" \u53D1\u9001\u5931\u8D25\uFF0C"+t.msg}),this.$emit("on-error",s),this.$refs.upload.fileList.pop())},handleFormatError(t){$A.modalWarning({title:"\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E",content:"\u6587\u4EF6 "+t.name+" \u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4EC5\u652F\u6301\u53D1\u9001\uFF1A"+this.uploadFormat.join(",")})},handleMaxSize(t){$A.modalWarning({title:"\u8D85\u51FA\u6587\u4EF6\u5927\u5C0F\u9650\u5236",content:"\u6587\u4EF6 "+t.name+" \u592A\u5927\uFF0C\u4E0D\u80FD\u53D1\u9001\u8D85\u8FC7"+$A.bytesToSize(this.maxSize*1024)+"\u3002"})},handleClick(){this.$refs.upload.handleClick()},upload(t){this.$refs.upload.upload(t)},cancel(t){return this.$refs.upload.cancel(t)},imageFileToObject(t){return new Promise((s,e)=>{const i=new FileReader;i.onload=({target:a})=>{const o=new Image;o.onload=()=>{const n=document.createElement("canvas"),r=n.getContext("2d"),l=o.width,d=o.height,c=500,_=500;let p=l,g=d;(l>c||d>_)&&(l/d>c/_?(p=c,g=Math.round(c*(d/l))):(g=_,p=Math.round(_*(l/d)))),n.width=p,n.height=g,r.clearRect(0,0,p,g),r.drawImage(o,0,0,p,g),s({type:"img",thumb:n.toDataURL("image/webp",.92),width:n.width,height:n.height})},o.onerror=()=>{e()},o.src=a.result},i.onerror=()=>{e()},i.readAsDataURL(t)})}}},L={};var X=f(Y,J,Q,!1,Z,null,null,null);function Z(t){for(let s in L)this[s]=L[s]}var tt=function(){return X.exports}(),et=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"dialog-group-info"},[e("div",{staticClass:"dialog-group-head"},[e("div",{staticClass:"group-info-title"},[t._v(t._s(t.$L("\u7FA4\u540D")))]),e("div",{staticClass:"group-info-value"},[e("QuickEdit",{attrs:{value:t.dialogData.name,disabled:t.dialogData.owner_id!=t.userId},on:{"on-update":t.updateName}},[t._v(t._s(t.dialogData.name))])],1)]),e("div",{staticClass:"group-info-title"},[t._v(t._s(t.$L("\u7FA4\u7EC4 ID")))]),e("div",{staticClass:"group-info-value"},[t._v(t._s(t.dialogId))]),e("div",{staticClass:"group-info-title"},[t._v(t._s(t.$L("\u7FA4\u7C7B\u578B")))]),e("div",{staticClass:"group-info-value"},[t._v(t._s(t.$L(t.groupType)))]),e("div",{staticClass:"group-info-search"},[e("Input",{attrs:{prefix:"ios-search",placeholder:t.$L("\u641C\u7D22\u6210\u5458"),clearable:""},model:{value:t.searchKey,callback:function(i){t.searchKey=i},expression:"searchKey"}})],1),e("div",{staticClass:"group-info-user"},[e("ul",[t.allList.length===0?e("li",{staticClass:"no"},[t.loadIng>0?e("Loading"):e("span",[t._v(t._s(t.$L("\u6CA1\u6709\u7B26\u5408\u6761\u4EF6\u7684\u6570\u636E")))])],1):t.botList.length>0?[e("li",{staticClass:"label"},[e("span",[t._v(t._s(t.$L("\u7FA4\u673A\u5668\u4EBA")))])]),t._l(t.botList,function(i){return e("li",{on:{click:function(a){return t.openUser(i.userid)}}},[e("UserAvatar",{attrs:{userid:i.userid,size:32,showName:""}}),i.userid===t.dialogData.owner_id?e("div",{staticClass:"user-tag"},[t._v(t._s(t.$L("\u7FA4\u4E3B")))]):t.operableExit(i)?e("div",{staticClass:"user-exit",on:{click:function(a){return a.stopPropagation(),t.onExit(i)}}},[e("Icon",{attrs:{type:"md-exit"}})],1):t._e()],1)}),e("li",{staticClass:"label"},[e("span",[t._v(t._s(t.$L(`\u7FA4\u6210\u5458 (${t.userList.length}\u4EBA)`)))])]),t._l(t.userList,function(i){return e("li",{on:{click:function(a){return t.openUser(i.userid)}}},[e("UserAvatar",{attrs:{userid:i.userid,size:32,showName:""}}),i.userid===t.dialogData.owner_id?e("div",{staticClass:"user-tag"},[t._v(t._s(t.$L("\u7FA4\u4E3B")))]):t.operableExit(i)?e("div",{staticClass:"user-exit",on:{click:function(a){return a.stopPropagation(),t.onExit(i)}}},[e("Icon",{attrs:{type:"md-exit"}})],1):t._e()],1)})]:t._l(t.userList,function(i){return e("li",{on:{click:function(a){return t.openUser(i.userid)}}},[e("UserAvatar",{attrs:{userid:i.userid,size:32,showName:""}}),i.userid===t.dialogData.owner_id?e("div",{staticClass:"user-tag"},[t._v(t._s(t.$L("\u7FA4\u4E3B")))]):t.operableExit(i)?e("div",{staticClass:"user-exit",on:{click:function(a){return a.stopPropagation(),t.onExit(i)}}},[e("Icon",{attrs:{type:"md-exit"}})],1):t._e()],1)})],2)]),t.operableAdd?e("div",{staticClass:"group-info-button"},[t.dialogData.owner_id==t.userId||t.dialogData.owner_id==0?e("Button",{attrs:{type:"primary",icon:"md-add"},on:{click:t.openAdd}},[t._v(t._s(t.$L("\u6DFB\u52A0\u6210\u5458")))]):t._e()],1):t._e(),e("Modal",{attrs:{title:t.$L("\u6DFB\u52A0\u7FA4\u6210\u5458"),"mask-closable":!1},model:{value:t.addShow,callback:function(i){t.addShow=i},expression:"addShow"}},[e("Form",t._b({attrs:{model:t.addData},nativeOn:{submit:function(i){i.preventDefault()}}},"Form",t.formOptions,!1),[e("FormItem",{attrs:{prop:"userids",label:t.$L("\u65B0\u589E\u6210\u5458")}},[e("UserSelect",{attrs:{disabledChoice:t.addData.disabledChoice,"multiple-max":100,"show-bot":"",title:t.$L("\u9009\u62E9\u6210\u5458")},model:{value:t.addData.userids,callback:function(i){t.$set(t.addData,"userids",i)},expression:"addData.userids"}}),t.dialogData.group_type==="department"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u90E8\u95E8")))]):t.dialogData.group_type==="project"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u9879\u76EE")))]):t.dialogData.group_type==="task"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u4EFB\u52A1\u8D1F\u8D23\u4EBA")))]):t._e()],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.addShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.addLoad>0},on:{click:t.onAdd}},[t._v(t._s(t.$L("\u786E\u5B9A\u6DFB\u52A0")))])],1)],1)],1)},st=[];const it={name:"DialogGroupInfo",components:{UserSelect:F},props:{dialogId:{type:Number,default:0}},data(){return{searchKey:"",loadIng:0,dialogUser:[],addShow:!1,addData:{},addLoad:0,openIng:!1}},computed:{...v(["cacheDialogs","cacheUserBasic","userIsAdmin","formOptions"]),dialogData(){return this.cacheDialogs.find(({id:t})=>t==this.dialogId)||{}},groupType(){const{group_type:t}=this.dialogData;return t==="department"?"\u90E8\u95E8\u7FA4\u7EC4":t==="project"?"\u9879\u76EE\u7FA4\u7EC4":t==="task"?"\u4EFB\u52A1\u7FA4\u7EC4":t==="user"?"\u4E2A\u4EBA\u7FA4\u7EC4":t==="all"?"\u5168\u5458\u7FA4\u7EC4":t==="okr"?"OKR\u7FA4\u7EC4":"\u672A\u77E5"},allList(){const{dialogUser:t,searchKey:s,cacheUserBasic:e,dialogData:i}=this;return t.map(o=>{const n=e.find(r=>r.userid==o.userid);return n&&(o.nickname=n.nickname,o.email=n.email),o}).filter(o=>!(s&&o.nickname&&!$A.strExists(o.nickname,s)&&!$A.strExists(o.email,s))).sort((o,n)=>o.userid===i.owner_id||n.userid===i.owner_id?(o.userid===i.owner_id?0:1)-(n.userid===i.owner_id?0:1):$A.sortDay(o.created_at,n.created_at))},botList({allList:t}){return t.filter(s=>s.bot)},userList({allList:t}){return t.filter(s=>!s.bot)}},watch:{dialogId:{handler(){this.getDialogUser()},immediate:!0}},methods:{updateName(t,s){if(!t){s();return}this.$store.dispatch("call",{url:"dialog/group/edit",data:{dialog_id:this.dialogId,chat_name:t}}).then(({data:e})=>{this.$store.dispatch("saveDialog",e),s()}).catch(({msg:e})=>{$A.modalError(e),s()})},getDialogUser(){this.dialogId<=0||(this.loadIng++,this.$store.dispatch("call",{url:"dialog/user",data:{dialog_id:this.dialogId}}).then(({data:t})=>{this.dialogUser=t,this.$store.dispatch("saveDialog",{id:this.dialogId,people:t.length,people_user:t.filter(s=>!s.bot).length,people_bot:t.filter(s=>s.bot).length})}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.loadIng--}))},operableAdd(){const{owner_id:t,group_type:s}=this.dialogData;return s=="all"?this.userIsAdmin:[0,this.userId].includes(t)},openAdd(){this.addData={dialog_id:this.dialogId,userids:[],disabledChoice:this.dialogUser.map(t=>t.userid)},this.addShow=!0},onAdd(){this.addLoad++,this.$store.dispatch("call",{url:"dialog/group/adduser",data:this.addData}).then(({msg:t})=>{$A.messageSuccess(t),this.addShow=!1,this.addData={},this.getDialogUser()}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.addLoad--})},operableExit(t){const{owner_id:s,group_type:e}=this.dialogData;return e=="all"?this.userIsAdmin:s==this.userId||t.inviter==this.userId},onExit(t){let s="\u4F60\u786E\u5B9A\u8981\u9000\u51FA\u7FA4\u7EC4\u5417\uFF1F",e=[];$A.isJson(t)&&t.userid!=this.userId&&(s=`\u4F60\u786E\u5B9A\u8981\u5C06\u3010${t.nickname}\u3011\u79FB\u51FA\u7FA4\u7EC4\u5417\uFF1F`,e=[t.userid]),$A.modalConfirm({content:s,loading:!0,onOk:()=>new Promise((i,a)=>{this.$store.dispatch("call",{url:"dialog/group/deluser",data:{dialog_id:this.dialogId,userids:e}}).then(({msg:o})=>{i(o),e.length>0?this.getDialogUser():(this.$store.dispatch("forgetDialog",{id:this.dialogId}),this.$emit("on-close"))}).catch(({msg:o})=>{a(o)})})})},openUser(t){this.openIng||(this.openIng=!0,this.$store.dispatch("openDialogUserid",t).then(s=>{this.$emit("on-close")}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.openIng=!1}))}}},x={};var at=f(it,et,st,!1,ot,null,null,null);function ot(t){for(let s in x)this[s]=x[s]}var rt=function(){return at.exports}(),nt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"dialog-respond"},[e("div",{staticClass:"respond-title"},[e("em",{staticClass:"no-dark-content"},[t._v(t._s(t.respondData.symbol))]),t._v(t._s(t.$L("\u56DE\u5E94\u8BE6\u60C5"))+" ("+t._s(t.respondData.userids.length)+")")]),e("div",{staticClass:"respond-user"},[e("ul",t._l(t.respondData.userids,function(i,a){return e("li",{key:a,on:{click:function(o){return t.openUser(i)}}},[e("UserAvatar",{attrs:{userid:i,size:32,showName:""}})],1)}),0)])])},lt=[];const dt={name:"DialogRespond",props:{respondData:{type:Object,default:()=>({})}},data(){return{openIng:!1}},methods:{openUser(t){this.openIng||(this.openIng=!0,this.$store.dispatch("openDialogUserid",t).then(s=>{this.$emit("on-close")}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.openIng=!1}))}}},S={};var ct=f(dt,nt,lt,!1,ht,null,null,null);function ht(t){for(let s in S)this[s]=S[s]}var ut=function(){return ct.exports}(),pt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"dialog-session-history"},[e("div",{staticClass:"session-history-title"},[t._v(t._s(t.$L("\u4E0E (*) \u4F1A\u8BDD\u5386\u53F2",t.sessionData.name)))]),e("Scrollbar",{ref:"list",staticClass:"session-history-list",on:{"on-scroll":t.listScroll}},[e("ul",t._l(t.listData,function(i,a){return e("li",{key:a,on:{click:function(o){return t.onOpen(i)}}},[e("div",{staticClass:"history-title"},[t.openIng==i.id?e("div",{staticClass:"history-load"},[e("Loading")],1):t._e(),i.is_open?e("em",[t._v(t._s(t.$L("\u5F53\u524D")))]):t._e(),t._v(t._s(i.title||t.$L("\u65B0\u4F1A\u8BDD"))+" ")]),e("div",{staticClass:"history-time",attrs:{title:i.created_at}},[t._v(" "+t._s(t.$A.timeFormat(i.created_at))+" ")])])}),0),t.listLoad>0?e("div",{staticClass:"session-history-load"},[e("Loading")],1):t._e()])],1)},gt=[];const ft={name:"DialogSessionHistory",props:{sessionData:{type:Object,default:()=>({})}},data(){return{openIng:0,listData:[],listLoad:0,listCurrentPage:1,listHasMorePages:!1}},mounted(){this.getListData(1)},methods:{scrollE(){return this.$refs.list?this.$refs.list.scrollInfo().scrollE:0},getListData(t){this.listLoad++,this.$store.dispatch("call",{url:"dialog/session/list",data:{dialog_id:this.sessionData.dialog_id,page:t,pagesize:50}}).then(({data:s})=>{s.current_page===1?this.listData=s.data:this.listData=this.listData.concat(s.data),this.listCurrentPage=s.current_page,this.listHasMorePages=s.current_page<s.last_page,this.$nextTick(this.getListNextPage)}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.listLoad--})},listScroll(){this.scrollE()<10&&this.getListNextPage()},getListNextPage(){this.scrollE()<10&&this.listLoad===0&&this.listHasMorePages&&this.getListData(this.listCurrentPage+1)},onOpen(t){if(t.is_open){this.$emit("on-close");return}this.openIng>0||(this.openIng=t.id,this.$store.dispatch("call",{url:"dialog/session/open",data:{session_id:t.id}}).then(()=>{this.$emit("on-submit")}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.openIng=0}))}}},C={};var mt=f(ft,pt,gt,!1,_t,null,null,null);function _t(t){for(let s in C)this[s]=C[s]}var vt=function(){return mt.exports}(),$t=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Modal",{attrs:{"class-name":"dialog-droup-word-chain","mask-closable":!1,title:t.dialogDroupWordChain.type=="create"?t.$L("\u53D1\u8D77\u63A5\u9F99"):t.$L("\u63A5\u9F99\u7ED3\u679C"),closable:!t.isFullscreen,fullscreen:t.isFullscreen,"footer-hide":t.isFullscreen},scopedSlots:t._u([{key:"header",fn:function(){return[t.isFullscreen?e("div",{staticClass:"chain-modal-header"},[e("div",{staticClass:"chain-modal-close",on:{click:function(i){t.show=!1}}},[t._v(" "+t._s(t.$L("\u53D6\u6D88"))+" ")]),e("div",{staticClass:"chain-modal-title"},[e("span",[t._v(t._s(t.dialogDroupWordChain.type=="create"?t.$L("\u53D1\u8D77\u63A5\u9F99"):t.$L("\u63A5\u9F99\u7ED3\u679C")))])]),e("div",{staticClass:"chain-modal-submit",class:{disabled:!t.isEdit},on:{click:t.onSend}},[t.loadIng>0?e("div",{staticClass:"submit-loading"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u53D1\u9001"))+" ")])]):t._e()]},proxy:!0},{key:"close",fn:function(){return[e("i",{staticClass:"ivu-icon ivu-icon-ios-close"})]},proxy:!0}]),model:{value:t.show,callback:function(i){t.show=i},expression:"show"}},[e("div",{ref:"wordChainBodyRef",staticClass:"word-chain-body"},[t.dialogDroupWordChain.type=="create"?e("div",{staticClass:"source"},[t._v(" "+t._s(t.$L("\u6765\u81EA"))+" "),e("span",[t._v(t._s(t.dialog.name))])]):t._e(),e("div",{staticClass:"initiate"},[e("span",[t._v(t._s(t.$L("\u7531")))]),e("UserAvatar",{attrs:{userid:t.createId,size:22,showName:!0}}),e("span",[t._v(" "+t._s(t.$L("\u53D1\u8D77\uFF0C\u53C2\u4E0E\u63A5\u9F99\u76EE\u524D\u5171"+t.num+"\u4EBA")))])],1),e("div",{staticClass:"textarea"},[e("Input",{ref:"wordChainTextareaRef",attrs:{type:"textarea",autosize:{minRows:3,maxRows:5},disabled:t.dialogDroupWordChain.type!="create",placeholder:t.$L("\u8BF7\u8F93\u5165\u63A5\u9F99\u4E3B\u9898")},model:{value:t.value,callback:function(i){t.value=i},expression:"value"}})],1),e("ul",{ref:"wordChainListRef"},[t._l(t.list,function(i){return i.type=="case"&&(t.dialogDroupWordChain.type=="create"||i.text)?e("li",[e("span",[t._v(t._s(t.$L("\u4F8B")))]),e("Input",{attrs:{placeholder:t.$L("\u53EF\u586B\u5199\u63A5\u9F99\u683C\u5F0F"),disabled:t.dialogDroupWordChain.type!="create"},model:{value:i.text,callback:function(a){t.$set(i,"text",a)},expression:"item.text"}})],1):t._e()}),t._l(t.list.filter(function(i){return i.type!="case"}),function(i,a){return e("li",[e("span",[t._v(t._s(a+1))]),e("Input",{attrs:{disabled:i.userid!=t.userId,placeholder:t.$L("\u8BF7\u8F93\u5165\u63A5\u9F99\u5185\u5BB9")},model:{value:i.text,callback:function(o){t.$set(i,"text",o)},expression:"item.text"}})],1)}),e("li",{staticClass:"add"},[e("i",{staticClass:"taskfont",on:{click:t.onAdd}},[t._v("\uE78C")])])],2)]),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.loadIng>0,disabled:!t.isEdit},on:{click:t.onSend}},[t._v(t._s(t.$L("\u53D1\u9001")))])],1)])},yt=[];const wt={name:"DialogDroupWordChain",data(){return{show:!1,createId:0,value:"#"+this.$L("\u63A5\u9F99")+` 
`,list:[],oldData:"",loadIng:0}},computed:{...v(["dialogDroupWordChain","userInfo","dialogMsgs","cacheDialogs"]),isFullscreen({windowWidth:t}){return t<576},num(){var t;return((t=this.list.filter(s=>s.type!="case"))==null?void 0:t.length)||0},allList(){var e;const t=((e=this.dialogDroupWordChain.msgData)==null?void 0:e.msg)||{};let s=JSON.parse(JSON.stringify(t.list||[]));return this.dialogMsgs.filter(i=>{var a;return i.type=="word-chain"&&((a=i.msg)==null?void 0:a.uuid)==t.uuid}).forEach(i=>{(i.msg.list||[]).forEach(a=>{a.type!="case"&&s.map(o=>o.id).indexOf(a.id)==-1&&s.push(a)})}),s.filter(i=>(i.text||"").trim())},isEdit(){return this.oldData!=JSON.stringify(this.list)},dialog(){return this.cacheDialogs.find(t=>t.id==this.dialogDroupWordChain.dialog_id)||{}}},watch:{show(t){t?(this.dialogDroupWordChain.type=="create"&&this.$nextTick(()=>{this.$refs.wordChainTextareaRef.focus()}),this.scrollTo()):(this.value="#"+this.$L("\u63A5\u9F99")+` 
`,this.list=[])},dialogDroupWordChain(t){t.type=="create"&&t.dialog_id&&(this.show=!0,this.createId=this.userId,this.list=[],this.list.push({id:Date.now(),type:"case",userid:this.userId,text:""}),this.list.push({id:Date.now()+1,type:"text",userid:this.userId,text:this.userInfo.nickname})),t.type=="participate"&&t.dialog_id&&t.msgData&&(this.show=!0,this.createId=t.msgData.msg.createid||t.msgData.msg.userid,this.value=t.msgData.msg.text,this.list=this.allList,this.oldData=JSON.stringify(this.list))}},methods:{onAdd(){this.list.push({id:Date.now(),type:"text",userid:this.userId,text:this.userInfo.nickname}),this.scrollTo()},scrollTo(){this.$nextTick(()=>{this.$refs.wordChainListRef.scrollTo(0,99999)})},onSend(){if(!this.isEdit)return;if(!this.value){$A.messageError("\u8BF7\u8F93\u5165\u63A5\u9F99\u4E3B\u9898");return}const t=this.list.map(s=>s.text);if(t.length!=[...new Set(t)].length){$A.modalConfirm({content:"\u91CD\u590D\u5185\u5BB9\u5C06\u4E0D\u518D\u8BA1\u5165\u63A5\u9F99\u7ED3\u679C",cancelText:"\u8FD4\u56DE\u7F16\u8F91",okText:"\u7EE7\u7EED\u53D1\u9001",onOk:()=>{this.send()}});return}this.send()},send(){var s,e;const t=[];this.list.forEach(i=>{(i.text||i.type!="case")&&t.map(a=>a.text).indexOf(i.text)==-1&&t.push(i)}),this.loadIng++,this.$store.dispatch("call",{url:"dialog/msg/wordchain",method:"post",data:{dialog_id:this.dialogDroupWordChain.dialog_id,text:this.value,list:t,uuid:((e=(s=this.dialogDroupWordChain.msgData)==null?void 0:s.msg)==null?void 0:e.uuid)||""}}).then(({data:i})=>{this.show=!1,this.$store.dispatch("saveDialogMsg",i)}).catch(({msg:i})=>{if(i.indexOf("System error")!==-1){$A.modalInfo({title:"\u7248\u672C\u8FC7\u4F4E",content:"\u670D\u52A1\u5668\u7248\u672C\u8FC7\u4F4E\uFF0C\u8BF7\u5347\u7EA7\u670D\u52A1\u5668\u3002"});return}$A.modalError(i)}).finally(i=>{this.loadIng--})}}},T={};var It=f(wt,$t,yt,!1,kt,null,null,null);function kt(t){for(let s in T)this[s]=T[s]}var Dt=function(){return It.exports}(),bt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Modal",{attrs:{"class-name":"dialog-droup-word-chain","mask-closable":!1,title:t.dialogGroupVote.type=="create"?t.$L("\u53D1\u8D77\u6295\u7968"):t.$L("\u6295\u7968\u7ED3\u679C"),closable:!t.isFullscreen,fullscreen:t.isFullscreen,"footer-hide":t.isFullscreen},scopedSlots:t._u([{key:"header",fn:function(){return[t.isFullscreen?e("div",{staticClass:"chain-modal-header"},[e("div",{staticClass:"chain-modal-close",on:{click:function(i){t.show=!1}}},[t._v(" "+t._s(t.$L("\u53D6\u6D88"))+" ")]),e("div",{staticClass:"chain-modal-title"},[e("span",[t._v(t._s(t.dialogGroupVote.type=="create"?t.$L("\u53D1\u8D77\u6295\u7968"):t.$L("\u6295\u7968\u7ED3\u679C")))])]),e("div",{staticClass:"chain-modal-submit",class:{disabled:!t.isEdit},on:{click:t.onSend}},[t.loadIng>0?e("div",{staticClass:"submit-loading"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u53D1\u9001"))+" ")])]):t._e()]},proxy:!0},{key:"close",fn:function(){return[e("i",{staticClass:"ivu-icon ivu-icon-ios-close"})]},proxy:!0}]),model:{value:t.show,callback:function(i){t.show=i},expression:"show"}},[e("div",{ref:"wordChainBodyRef",staticClass:"word-chain-body"},[t.dialogGroupVote.type=="create"?e("div",{staticClass:"source"},[t._v(" "+t._s(t.$L("\u6765\u81EA"))+" "),e("span",[t._v(t._s(t.dialog.name))])]):t._e(),e("div",{staticClass:"initiate"},[e("span",[t._v(t._s(t.$L("\u7531")))]),e("UserAvatar",{attrs:{userid:t.createId,size:22,showName:!0,tooltipDisabled:""}}),e("span",[t._v(" "+t._s(t.$L("\u53D1\u8D77")))])],1),e("div",{staticClass:"textarea"},[e("Input",{ref:"wordChainTextareaRef",attrs:{type:"textarea",placeholder:t.$L("\u8BF7\u8F93\u5165\u6295\u7968\u4E3B\u9898"),autosize:{minRows:3,maxRows:5},disabled:t.dialogGroupVote.type!="create"},model:{value:t.value,callback:function(i){t.value=i},expression:"value"}})],1),e("ul",{ref:"wordChainListRef"},[t._l(t.list,function(i,a){return e("li",[e("i",{staticClass:"taskfont",class:{disabled:t.list.length<=2},on:{click:function(o){return t.onDel(a)}}},[t._v("\uE680")]),e("Input",{attrs:{placeholder:t.$L("\u8BF7\u8F93\u5165\u9009\u9879\u5185\u5BB9")},model:{value:i.text,callback:function(o){t.$set(i,"text",o)},expression:"item.text"}})],1)}),e("li",{staticClass:"add"},[e("i",{staticClass:"taskfont",on:{click:t.onAdd}},[t._v("\uE78C")])])],2),t.dialogGroupVote.type=="create"?e("div",{staticClass:"switch-row"},[e("span",{staticClass:"label"},[t._v(t._s(t.$L("\u5141\u8BB8\u591A\u9009")))]),e("iSwitch",{attrs:{"true-value":1,"false-value":0},model:{value:t.multiple,callback:function(i){t.multiple=i},expression:"multiple"}})],1):t._e(),t.dialogGroupVote.type=="create"?e("div",{staticClass:"switch-row"},[e("span",{staticClass:"label"},[t._v(t._s(t.$L("\u533F\u540D\u6295\u7968")))]),e("iSwitch",{attrs:{"true-value":1,"false-value":0},model:{value:t.anonymous,callback:function(i){t.anonymous=i},expression:"anonymous"}})],1):t._e()]),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.loadIng>0,disabled:!t.isEdit},on:{click:t.onSend}},[t._v(t._s(t.$L("\u53D1\u9001")))])],1)])},Lt=[];const xt={name:"DialogGroupVote",data(){return{show:!1,createId:0,value:"",list:[],multiple:0,anonymous:0,oldData:"",loadIng:0}},computed:{...v(["dialogGroupVote","userInfo","dialogMsgs","cacheDialogs"]),isFullscreen({windowWidth:t}){return t<576},allList(){var e;const t=((e=this.dialogGroupVote.msgData)==null?void 0:e.msg)||{};let s=JSON.parse(JSON.stringify(t.list||[]));return this.dialogMsgs.filter(i=>{var a;return i.type=="word-chain"&&((a=i.msg)==null?void 0:a.uuid)==t.uuid}).forEach(i=>{(i.msg.list||[]).forEach(a=>{s.map(o=>o.id).indexOf(a.id)==-1&&s.push(a)})}),s},isEdit(){return this.oldData!=JSON.stringify(this.list)},dialog(){return this.cacheDialogs.find(t=>t.id==this.dialogGroupVote.dialog_id)||{}}},watch:{show(t){t?(this.dialogGroupVote.type=="create"&&this.$nextTick(()=>{this.$refs.wordChainTextareaRef.focus()}),this.scrollTo()):(this.value="",this.list=[])},dialogGroupVote(t){t.type=="create"&&t.dialog_id&&(this.show=!0,this.createId=this.userId,this.list=[{id:Date.now(),text:""},{id:Date.now()+1,text:""}]),t.type=="participate"&&t.dialog_id&&t.msgData&&(this.show=!0,this.createId=t.msgData.msg.userid,this.value=t.msgData.msg.text,this.list=this.allList,this.oldData=JSON.stringify(this.list))}},methods:{onAdd(){this.list.push({id:Date.now(),text:""}),this.scrollTo()},onDel(t){this.list.length>2&&this.list.splice(t,1)},scrollTo(){this.$nextTick(()=>{this.$refs.wordChainListRef.scrollTo(0,99999)})},onSend(){var t,s;if(!!this.isEdit){if(!this.value){$A.messageError("\u8BF7\u8F93\u5165\u6295\u7968\u4E3B\u9898");return}if(this.list.find(e=>!e.text)){$A.messageError("\u8BF7\u8F93\u5165\u9009\u9879\u5185\u5BB9");return}this.loadIng++,this.$store.dispatch("call",{url:"dialog/msg/vote",method:"post",data:{dialog_id:this.dialogGroupVote.dialog_id,text:this.value,list:this.list,uuid:((s=(t=this.dialogGroupVote.msgData)==null?void 0:t.msg)==null?void 0:s.uuid)||"",multiple:this.multiple,anonymous:this.anonymous}}).then(({data:e})=>{this.show=!1,this.$store.dispatch("saveDialogMsg",e)}).catch(({msg:e})=>{if(e.indexOf("System error")!==-1){$A.modalInfo({title:"\u7248\u672C\u8FC7\u4F4E",content:"\u670D\u52A1\u5668\u7248\u672C\u8FC7\u4F4E\uFF0C\u8BF7\u5347\u7EA7\u670D\u52A1\u5668\u3002"});return}$A.modalError(e)}).finally(e=>{this.loadIng--})}}}},M={};var St=f(xt,bt,Lt,!1,Ct,null,null,null);function Ct(t){for(let s in M)this[s]=M[s]}var Tt=function(){return St.exports}(),Mt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"dialog-complaint-info"},[e("div",{staticClass:"group-complaint-title"},[t._v(t._s(t.$L("\u533F\u540D\u4E3E\u62A5")))]),e("div",{staticClass:"group-complaint-warp"},[e("div",{staticClass:"group-complaint-title underline required"},[t._v(t._s(t.$L("\u8BF7\u9009\u62E9\u4E3E\u62A5\u7C7B\u578B"))+":")]),e("div",{staticClass:"group-complaint-list"},[e("List",t._l(t.typeList,function(i,a){return e("ListItem",{key:a,class:{active:t.typeId==i.id}},[e("div",{staticClass:"text",on:{click:function(o){return t.onSelectType(i)}}},[t._v(t._s(t.$L(i.label)))]),e("RadioGroup",{model:{value:t.typeId,callback:function(o){t.typeId=o},expression:"typeId"}},[e("Radio",{attrs:{label:i.id,"model-value":t.typeId}},[t._v("\xA0")])],1)],1)}),1)],1),e("div",{staticClass:"group-complaint-title required"},[t._v(t._s(t.$L("\u8BF7\u8F93\u5165\u4E3E\u62A5\u539F\u56E0"))+":")]),e("div",{staticClass:"group-complaint-reason"},[e("Input",{attrs:{type:"textarea",maxlength:"500",autosize:{minRows:4,maxRows:8},placeholder:t.$L("\u8BF7\u8F93\u5165\u586B\u5199\u8BE6\u7EC6\u7684\u4E3E\u62A5\u539F\u56E0\uFF0C\u4EE5\u4F7F\u6211\u4EEC\u66F4\u597D\u7684\u5E2E\u52A9\u4F60\u89E3\u51B3\u95EE\u9898")},model:{value:t.reason,callback:function(i){t.reason=i},expression:"reason"}})],1),e("div",{staticClass:"group-complaint-img"},[e("ImgUpload",{attrs:{num:5,width:2048,height:2048,whcut:"percentage"},model:{value:t.imgs,callback:function(i){t.imgs=i},expression:"imgs"}})],1)]),e("div",{staticClass:"group-info-button"},[e("Button",{attrs:{type:"primary",icon:"md-add"},on:{click:t.onSubmit}},[t._v(t._s(t.$L("\u63D0\u4EA4")))])],1)])},At=[];const Et={name:"DialogComplaint",components:{ImgUpload:V},props:{dialogId:{type:Number,default:0}},data(){return{typeList:[{id:10,label:"\u8BC8\u9A97\u8BF1\u5BFC\u8F6C\u8D26"},{id:20,label:"\u5F15\u6D41\u4E0B\u8F7D\u5176\u4ED6APP\u4ED8\u8D39"},{id:30,label:"\u6572\u8BC8\u52D2\u7D22"},{id:40,label:"\u7167\u7247\u4E0E\u672C\u4EBA\u4E0D\u4E00\u81F4"},{id:50,label:"\u8272\u60C5\u4F4E\u4FD7"},{id:60,label:"\u9891\u7E41\u5E7F\u544A\u9A9A\u6270"},{id:70,label:"\u5176\u4ED6\u95EE\u9898"}],typeId:0,reason:"",imgs:[]}},methods:{onSelectType(t){this.typeId==t.id?this.typeId=0:this.typeId=t.id},onSubmit(){if(!this.typeId)return $A.modalError("\u8BF7\u9009\u62E9\u4E3E\u62A5\u7C7B\u578B");if(!this.reason)return $A.modalError("\u8BF7\u586B\u5199\u4E3E\u62A5\u539F\u56E0");this.$store.dispatch("call",{url:"complaint/submit",data:{dialog_id:this.dialogId,reason:this.reason,type:this.typeId,imgs:this.imgs}}).then(({data:t})=>{$A.modalSuccess("\u4E3E\u62A5\u6210\u529F"),this.$emit("on-close")}).catch(({msg:t})=>{$A.modalError(t)})}}},A={};var Ot=f(Et,Mt,At,!1,Ft,null,null,null);function Ft(t){for(let s in A)this[s]=A[s]}var Vt=function(){return Ot.exports}(),Rt=function(){var t=this,s=t.$createElement,e=t._self._c||s;return t.isReady?e("div",{staticClass:"dialog-wrapper",class:t.wrapperClass,on:{drop:function(i){return i.preventDefault(),t.chatPasteDrag(i,"drag")},dragover:function(i){return i.preventDefault(),t.chatDragOver(!0,i)},dragleave:function(i){return i.preventDefault(),t.chatDragOver(!1,i)},touchstart:t.onTouchStart,pointerover:t.onPointerover}},[e("div",{ref:"nav",staticClass:"dialog-nav"},[t._t("head",function(){return[e("div",{staticClass:"nav-wrapper",class:t.navClass},[e("div",{staticClass:"dialog-back",on:{click:t.onBack}},[e("i",{staticClass:"taskfont"},[t._v("\uE676")]),t.msgUnreadOnly?e("div",{staticClass:"back-num"},[t._v(t._s(t.msgUnreadOnly))]):t._e()]),e("div",{staticClass:"dialog-block"},[e("div",{staticClass:"dialog-avatar",on:{click:t.onViewAvatar}},[t.dialogData.type=="group"?[t.dialogData.avatar?e("EAvatar",{staticClass:"img-avatar",attrs:{src:t.dialogData.avatar,size:42}}):t.dialogData.group_type=="department"?e("i",{staticClass:"taskfont icon-avatar department"},[t._v("\uE75C")]):t.dialogData.group_type=="project"?e("i",{staticClass:"taskfont icon-avatar project"},[t._v("\uE6F9")]):t.dialogData.group_type=="task"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):t.dialogData.group_type=="okr"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):e("Icon",{staticClass:"icon-avatar",attrs:{type:"ios-people"}})]:t.dialogData.dialog_user?e("div",{staticClass:"user-avatar"},[e("UserAvatarTip",{attrs:{online:t.dialogData.online_state,userid:t.dialogData.dialog_user.userid,size:42},on:{"update:online":function(i){return t.$set(t.dialogData,"online_state",i)}}},[t.dialogData.type==="user"&&t.dialogData.online_state!==!0?e("p",{attrs:{slot:"end"},slot:"end"},[t._v(" "+t._s(t.$L(t.dialogData.online_state))+" ")]):t._e()])],1):e("Icon",{staticClass:"icon-avatar",attrs:{type:"md-person"}})],2),e("div",{staticClass:"dialog-title"},[e("div",{staticClass:"main-title"},[t._l(t.$A.dialogTags(t.dialogData),function(i){return i.color!="success"?[e("Tag",{attrs:{color:i.color,fade:!1}},[t._v(t._s(t.$L(i.text)))])]:t._e()}),e("h2",[t._v(t._s(t.dialogData.name))]),t.peopleNum>0?e("em",{on:{click:function(i){return t.onDialogMenu("groupInfo")}}},[t._v("("+t._s(t.peopleNum)+")")]):t._e(),t.dialogData.bot?e("Tag",{staticClass:"after",attrs:{fade:!1}},[t._v(t._s(t.$L("\u673A\u5668\u4EBA")))]):t._e(),t.dialogData.type==="user"&&t.approvaUserStatus?e("Tag",{staticClass:"after",attrs:{color:"red",fade:!1}},[t._v(t._s(t.$L(t.approvaUserStatus)))]):t._e(),t.dialogData.group_type=="all"?e("Tag",{staticClass:"after pointer",attrs:{fade:!1},on:{"on-click":function(i){return t.onDialogMenu("groupInfo")}}},[t._v(t._s(t.$L("\u5168\u5458")))]):t.dialogData.group_type=="department"?e("Tag",{staticClass:"after pointer",attrs:{fade:!1},on:{"on-click":function(i){return t.onDialogMenu("groupInfo")}}},[t._v(t._s(t.$L("\u90E8\u95E8")))]):t._e(),t.msgLoadIng>0&&t.allMsgs.length>0?e("div",{staticClass:"load"},[e("Loading")],1):t._e()],2),e("ul",{staticClass:"title-desc"},[t.dialogData.type==="user"?e("li",{class:[t.dialogData.online_state===!0?"online":"offline"]},[t._v(" "+t._s(t.$L(t.dialogData.online_state===!0?"\u5728\u7EBF":t.dialogData.online_state))+" ")]):t._e()]),t.tagShow?e("ul",{staticClass:"title-tags scrollbar-hidden"},t._l(t.msgTags,function(i){var a;return e("li",{key:i.type,class:(a={},a[i.type||"msg"]=!0,a.active=t.msgType===i.type,a),on:{click:function(o){return t.onMsgType(i.type)}}},[e("i",{staticClass:"no-dark-content"}),e("span",[t._v(t._s(t.$L(i.label)))])])}),0):t._e()])]),e("EDropdown",{staticClass:"dialog-menu",attrs:{trigger:"click"},on:{command:t.onDialogMenu}},[e("i",{staticClass:"taskfont dialog-menu-icon"},[t._v("\uE6E9")]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:"searchMsg"}},[e("div",[t._v(t._s(t.$L("\u641C\u7D22\u6D88\u606F")))])]),t.$isMainElectron?e("EDropdownItem",{attrs:{command:"single"}},[e("div",[t._v(t._s(t.$L("\u72EC\u7ACB\u7A97\u53E3")))])]):t._e(),t.dialogData.type==="user"?[t.dialogData.userimg?e("EDropdownItem",{attrs:{command:"previewAvatar"}},[e("div",[t._v(t._s(t.$L("\u67E5\u770B\u5934\u50CF")))])]):t._e(),t.isManageBot?e("EDropdownItem",{attrs:{command:"modifyNormal"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]):t._e(),t.isAiBot?e("EDropdownItem",{attrs:{command:"modifyAi"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u63D0\u793A\u8BCD")))])]):t._e(),e("EDropdownItem",{attrs:{command:"openCreate"}},[e("div",[t._v(t._s(t.$L("\u521B\u5EFA\u7FA4\u7EC4")))])]),t.dialogData.bot==0?e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]):t._e()]:[e("EDropdownItem",{attrs:{command:"groupInfo"}},[e("div",[t._v(t._s(t.$L("\u7FA4\u7EC4\u8BBE\u7F6E")))])]),t.dialogData.avatar?e("EDropdownItem",{attrs:{command:"previewAvatar"}},[e("div",[t._v(t._s(t.$L("\u67E5\u770B\u5934\u50CF")))])]):t._e(),t.dialogData.owner_id!=t.userId?[t.dialogData.group_type==="all"&&t.userIsAdmin?e("EDropdownItem",{attrs:{command:"modifyAdmin"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]):t._e(),e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]),e("EDropdownItem",{attrs:{command:"exit"}},[e("div",{staticStyle:{color:"#f00"}},[t._v(t._s(t.$L("\u9000\u51FA\u7FA4\u7EC4")))])])]:t.dialogData.group_type==="user"?[e("EDropdownItem",{attrs:{command:"modifyNormal"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]),e("EDropdownItem",{attrs:{command:"transfer"}},[e("div",[t._v(t._s(t.$L("\u8F6C\u8BA9\u7FA4\u4E3B")))])]),e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]),e("EDropdownItem",{attrs:{command:"disband"}},[e("div",{staticStyle:{color:"#f00"}},[t._v(t._s(t.$L("\u89E3\u6563\u7FA4\u7EC4")))])])]:t._e()]],2)],1),t.searchShow?e("div",{staticClass:"dialog-search"},[e("div",{staticClass:"search-location"},[e("i",{staticClass:"taskfont",on:{click:function(i){return t.onSearchSwitch("prev")}}},[t._v("\uE702")]),e("i",{staticClass:"taskfont",on:{click:function(i){return t.onSearchSwitch("next")}}},[t._v("\uE705")])]),e("div",{staticClass:"search-input"},[e("div",{staticClass:"search-pre"},[t.searchLoad>0?e("Loading"):e("Icon",{attrs:{type:"ios-search"}})],1),e("Form",{staticClass:"search-form",attrs:{action:"javascript:void(0)"},nativeOn:{submit:function(i){return i.preventDefault(),t.$A.eeuiAppKeyboardHide.apply(null,arguments)}}},[e("Input",{ref:"searchInput",attrs:{type:"search",placeholder:t.$L("\u641C\u7D22\u6D88\u606F"),clearable:""},on:{"on-keyup":t.onSearchKeyup},model:{value:t.searchKey,callback:function(i){t.searchKey=i},expression:"searchKey"}}),t.searchLoad===0&&t.searchResult.length>0?e("div",{staticClass:"search-total"},[t._v(t._s(t.searchLocation)+"/"+t._s(t.searchResult.length))]):t._e()],1)],1),e("div",{staticClass:"search-cancel",on:{click:function(i){return t.onSearchKeyup(null)}}},[t._v(t._s(t.$L("\u53D6\u6D88")))])]):t._e()],1)]})],2),t.topShow?e("div",{staticClass:"dialog-top-message",on:{click:t.onPosTop}},[e("div",{staticClass:"dialog-top-message-warp"},[t._m(0),e("div",{staticClass:"dialog-top-message-content"},[e("p",{staticClass:"content"},[e("UserAvatar",{attrs:{userid:t.topMsg.userid,showName:"",showIcon:!1}}),t._v(": "),e("span",[t._v(t._s(t.$A.getMsgSimpleDesc(t.topMsg)))])],1),e("p",{staticClass:"personnel"},[t._v(" "+t._s(t.$L("\u7F6E\u9876\u4EBA\u5458"))+" "),e("UserAvatar",{attrs:{userid:t.dialogData.top_userid,showName:"",showIcon:!1}})],1)]),e("div",{staticClass:"dialog-top-message-btn"},[t.topPosLoad>0?e("Loading",{attrs:{type:"pure"}}):e("i",{staticClass:"taskfont"},[t._v("\uEE15")]),e("i",{staticClass:"taskfont",on:{click:function(i){return i.stopPropagation(),t.onCancelTop(t.topMsg)}}},[t._v("\uE6E5")])],1)])]):t._e(),e("div",{ref:"msgs",staticClass:"dialog-msgs"},[t.positionShow&&t.positionMsg?e("div",{staticClass:"dialog-position"},[e("div",{staticClass:"position-label",on:{click:function(i){return t.onPositionMark(t.positionMsg.msg_id)}}},[t.positionLoad>0?e("Icon",{staticClass:"icon-loading",attrs:{type:"ios-loading"}}):e("i",{staticClass:"taskfont"},[t._v("\uE624")]),t._v(" "+t._s(t.positionMsg.label)+" ")],1)]):t._e(),e("VirtualList",{ref:"scroller",staticClass:"dialog-scroller scrollbar-virtual",attrs:{"active-prefix":"item","data-key":"id","data-sources":t.allMsgs,"data-component":t.msgItem,"extra-props":{dialogData:t.dialogData,operateVisible:t.operateVisible,operateItem:t.operateItem,pointerMouse:t.pointerMouse,isMyDialog:t.isMyDialog,msgId:t.msgId,unreadOne:t.unreadOne,scrollIng:t.scrollIng,readEnabled:t.readEnabled},"estimate-size":t.dialogData.type=="group"?105:77,keeps:t.dialogMsgKeep,disabled:t.scrollDisabled},on:{activity:t.onActivity,scroll:t.onScroll,totop:t.onPrevPage,range:t.onRange,visible:t.onVisible,"on-mention":t.onMention,"on-longpress":t.onLongpress,"on-view-reply":t.onViewReply,"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-reply-list":t.onReplyList,"on-error":t.onError,"on-emoji":t.onEmoji,"on-other":t.onOther,"on-show-emoji-user":t.onShowEmojiUser},scopedSlots:t._u([t.isChildComponent?null:{key:"header",fn:function(){return[e("div",{staticClass:"dialog-item head-box"},[t.loadIng>0||t.prevId>0?e("div",{staticClass:"loading",class:{filled:t.allMsgs.length===0}},[t.scrollOffset<100?e("span"):t._e()]):t.allMsgs.length===0?e("div",{staticClass:"describe filled"},[t._v(t._s(t.$L("\u6682\u65E0\u6D88\u606F")))]):t._e()])]},proxy:!0}],null,!0)})],1),e("div",{ref:"footer",staticClass:"dialog-footer",on:{click:t.onActive}},[t.scrollTail>500||t.msgNew>0&&t.allMsgs.length>0?e("div",{directives:[{name:"touchclick",rawName:"v-touchclick",value:t.onToBottom,expression:"onToBottom"}],staticClass:"dialog-goto"},[e("Badge",{attrs:{"overflow-count":999,count:t.msgNew}},[e("i",{staticClass:"taskfont"},[t._v("\uE72B")])])],1):t._e(),e("DialogUpload",{ref:"chatUpload",staticClass:"chat-upload",attrs:{"dialog-id":t.dialogId,maxSize:t.maxSize},on:{"on-progress":function(i){return t.chatFile("progress",i)},"on-success":function(i){return t.chatFile("success",i)},"on-error":function(i){return t.chatFile("error",i)}}}),t.todoShow?e("div",{staticClass:"chat-bottom-menu"},[e("div",{staticClass:"bottom-menu-label"},[t._v(t._s(t.$L("\u5F85\u529E"))+":")]),e("ul",{staticClass:"scrollbar-hidden"},t._l(t.todoList,function(i){return e("li",{on:{click:function(a){return a.stopPropagation(),t.onViewTodo(i)}}},[e("div",{staticClass:"bottom-menu-desc no-dark-content"},[t._v(t._s(t.$A.getMsgSimpleDesc(i.msg_data)))])])}),0)]):t.quickShow?e("div",{staticClass:"chat-bottom-menu"},[e("ul",{staticClass:"scrollbar-hidden"},t._l(t.quickMsgs,function(i){return e("li",{on:{click:function(a){return a.stopPropagation(),t.sendQuick(i,a)}}},[e("div",{staticClass:"bottom-menu-desc no-dark-content",style:i.style||null},[t._v(t._s(t.quickLabel(i)))])])}),0)]):t._e(),t.isMute?e("div",{staticClass:"chat-mute"},[t._v(" "+t._s(t.$L("\u7981\u8A00\u53D1\u8A00"))+" ")]):t.isDisable?e("div",{staticClass:"chat-mute"},[t._v(" "+t._s(t.$L("\u6B64\u8D26\u53F7\u5DF2\u505C\u7528"))+" ")]):e("ChatInput",{ref:"input",attrs:{"dialog-id":t.dialogId,"emoji-bottom":t.windowPortrait,maxlength:2e5,placeholder:t.$L("\u8F93\u5165\u6D88\u606F..."),"reply-msg-auto-mention":t.replyMsgAutoMention},on:{"on-focus":t.onEventFocus,"on-blur":t.onEventBlur,"on-more":t.onEventMore,"on-file":t.sendFileMsg,"on-send":t.sendMsg,"on-record":t.sendRecord,"on-record-state":t.onRecordState},model:{value:t.msgText,callback:function(i){t.msgText=i},expression:"msgText"}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.operateVisible,expression:"operateVisible"}],staticClass:"operate-position",style:t.operateStyles},[e("Dropdown",{ref:"operate",attrs:{trigger:"custom",placement:"top",visible:t.operateVisible,transferClassName:"dialog-wrapper-operate",transfer:""},on:{"on-clickoutside":function(i){t.operateVisible=!1}}},[e("div",{style:{userSelect:t.operateVisible?"none":"auto",height:t.operateStyles.height}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[t.operateItem.created_at?[e("DropdownItem",{attrs:{name:"action"}},[e("ul",{staticClass:"operate-action"},[t.msgId===0?e("li",{on:{click:function(i){return t.onOperate("reply")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6EB")]),e("span",[t._v(t._s(t.$L("\u56DE\u590D")))])]):t._e(),t.operateItem.userid==t.userId&&t.operateItem.type==="text"?e("li",{on:{click:function(i){return t.onOperate("update")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE779")]),e("span",[t._v(t._s(t.$L("\u7F16\u8F91")))])]):t._e(),t.actionPermission(t.operateItem,"voice2text")?e("li",{on:{click:function(i){return t.onOperate("voice2text")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE628")]),e("span",[t._v(t._s(t.$L("\u8F6C\u6587\u5B57")))])]):t._e(),t.actionPermission(t.operateItem,"translation")?e("li",{on:{click:function(i){return t.onOperate("translation")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE795")]),e("span",[t._v(t._s(t.$L("\u7FFB\u8BD1")))])]):t._e(),t._l(t.operateCopys,function(i,a){return i.visible!==!1?e("li",{key:a,on:{click:function(o){return t.onOperate("copy",i)}}},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(i.icon)}}),e("span",[t._v(t._s(t.$L(i.label||i.title)))])]):t._e()}),t.actionPermission(t.operateItem,"forward")?e("li",{on:{click:function(i){return t.onOperate("forward")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE638")]),e("span",[t._v(t._s(t.$L("\u8F6C\u53D1")))])]):t._e(),t.operateItem.userid==t.userId?e("li",{on:{click:function(i){return t.onOperate("withdraw")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE637")]),e("span",[t._v(t._s(t.$L("\u64A4\u56DE")))])]):t._e(),t.operateItem.type==="file"?[e("li",{on:{click:function(i){return t.onOperate("view")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE77B")]),e("span",[t._v(t._s(t.$L("\u67E5\u770B")))])]),e("li",{on:{click:function(i){return t.onOperate("down")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7A8")]),e("span",[t._v(t._s(t.$L("\u4E0B\u8F7D")))])])]:t._e(),e("li",{on:{click:function(i){return t.onOperate("tag")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE61E")]),e("span",[t._v(t._s(t.$L(t.operateItem.tag?"\u53D6\u6D88\u6807\u6CE8":"\u6807\u6CE8")))])]),t.actionPermission(t.operateItem,"newTask")?e("li",{on:{click:function(i){return t.onOperate("newTask")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7B8")]),e("span",[t._v(t._s(t.$L("\u65B0\u4EFB\u52A1")))])]):t._e(),e("li",{on:{click:function(i){return t.onOperate("todo")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7B7")]),e("span",[t._v(t._s(t.$L(t.operateItem.todo?"\u53D6\u6D88\u5F85\u529E":"\u8BBE\u5F85\u529E")))])]),e("li",{on:{click:function(i){return t.onOperate("top")}}},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(t.dialogData.top_msg_id==t.operateItem.id?"&#xe7e3;":"&#xe7e6;")}}),e("span",[t._v(t._s(t.$L(t.dialogData.top_msg_id==t.operateItem.id?"\u53D6\u6D88\u7F6E\u9876":"\u7F6E\u9876")))])]),t.msgType!==""?e("li",{on:{click:function(i){return t.onOperate("pos")}}},[e("i",{staticClass:"taskfont"},[t._v("\uEE15")]),e("span",[t._v(t._s(t.$L("\u5B8C\u6574\u5BF9\u8BDD")))])]):t._e()],2)]),e("DropdownItem",{staticClass:"dropdown-emoji",attrs:{name:"emoji"}},[e("ul",{staticClass:"operate-emoji scrollbar-hidden"},[t._l(t.operateEmojis,function(i,a){return e("li",{key:a,staticClass:"no-dark-content",domProps:{innerHTML:t._s(i)},on:{click:function(o){return t.onOperate("emoji",i)}}})}),e("li"),e("li",{staticClass:"more-emoji",on:{click:function(i){return t.onOperate("emoji","more")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE790")])])],2)])]:[e("DropdownItem",{attrs:{name:"action"}},[e("ul",{staticClass:"operate-action cancel"},[e("li",{on:{click:function(i){return t.onOperate("cancel")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6EB")]),e("span",[t._v(t._s(t.$L("\u53D6\u6D88\u53D1\u9001")))])])])])]],2)],1)],1),t.dialogDrag?e("div",{staticClass:"drag-over",on:{click:function(i){t.dialogDrag=!1}}},[e("div",{staticClass:"drag-text"},[t._v(t._s(t.$L("\u62D6\u52A8\u5230\u8FD9\u91CC\u53D1\u9001")))])]):t._e(),e("Modal",{attrs:{title:t.$L(t.pasteTitle),"cancel-text":t.$L("\u53D6\u6D88"),"ok-text":t.$L("\u53D1\u9001"),"enter-ok":!0,closable:!1,"mask-closable":!1},on:{"on-ok":t.pasteSend},model:{value:t.pasteShow,callback:function(i){t.pasteShow=i},expression:"pasteShow"}},[e("ul",{staticClass:"dialog-wrapper-paste",class:t.pasteClass},t._l(t.pasteItem,function(i){return e("li",[i.type=="image"?e("img",{attrs:{src:i.result}}):e("div",[t._v(t._s(t.$L("\u6587\u4EF6"))+": "+t._s(i.name)+" ("+t._s(t.$A.bytesToSize(i.size))+")")])])}),0)]),e("Modal",{attrs:{title:t.$L("\u4FEE\u6539\u8D44\u6599"),"mask-closable":!1},model:{value:t.modifyShow,callback:function(i){t.modifyShow=i},expression:"modifyShow"}},[e("Form",t._b({attrs:{model:t.modifyData},nativeOn:{submit:function(i){i.preventDefault()}}},"Form",t.formOptions,!1),[t.modifyData.system_name?e("Alert",{staticStyle:{"margin-bottom":"18px"},attrs:{type:"error"}},[t._v(t._s(t.$L(`\u6B63\u5728\u4FEE\u6539\u7CFB\u7EDF\u673A\u5668\u4EBA\uFF1A${t.modifyData.system_name}`)))]):t._e(),e("FormItem",{attrs:{prop:"avatar",label:t.$L("\u5934\u50CF")}},[e("ImgUpload",{attrs:{num:1,width:512,height:512,whcut:"cover"},model:{value:t.modifyData.avatar,callback:function(i){t.$set(t.modifyData,"avatar",i)},expression:"modifyData.avatar"}})],1),typeof t.modifyData.name!="undefined"?e("FormItem",{attrs:{prop:"name",label:t.$L("\u540D\u79F0")}},[e("Input",{attrs:{maxlength:20},model:{value:t.modifyData.name,callback:function(i){t.$set(t.modifyData,"name",i)},expression:"modifyData.name"}})],1):t._e(),t.dialogData.bot==t.userId?[typeof t.modifyData.clear_day!="undefined"?e("FormItem",{attrs:{prop:"clear_day",label:t.$L("\u6D88\u606F\u4FDD\u7559")}},[e("Input",{attrs:{maxlength:3,type:"number"},model:{value:t.modifyData.clear_day,callback:function(i){t.$set(t.modifyData,"clear_day",i)},expression:"modifyData.clear_day"}},[e("div",{attrs:{slot:"append"},slot:"append"},[t._v(t._s(t.$L("\u5929")))])])],1):t._e(),typeof t.modifyData.webhook_url!="undefined"?e("FormItem",{attrs:{prop:"webhook_url",label:"Webhook"}},[e("Input",{attrs:{maxlength:255},model:{value:t.modifyData.webhook_url,callback:function(i){t.$set(t.modifyData,"webhook_url",i)},expression:"modifyData.webhook_url"}})],1):t._e()]:t._e()],2),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.modifyShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.modifyLoad>0},on:{click:t.onModify}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u4FEE\u6539\u63D0\u793A\u8BCD"),"mask-closable":!1},model:{value:t.modifyAiShow,callback:function(i){t.modifyAiShow=i},expression:"modifyAiShow"}},[e("Form",{attrs:{model:t.modifyData},nativeOn:{submit:function(i){i.preventDefault()}}},[e("FormItem",{staticStyle:{"margin-bottom":"16px"},attrs:{prop:"value"}},[e("Input",{attrs:{maxlength:2e4,type:"textarea",autosize:{minRows:3,maxRows:5},placeholder:t.$L("\u4F8B\u5982\uFF1A\u4F60\u662F\u4E00\u4E2A\u4EBA\u5F00\u53D1\u7684AI\u52A9\u624B"),"show-word-limit":.9},model:{value:t.modifyData.value,callback:function(i){t.$set(t.modifyData,"value",i)},expression:"modifyData.value"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.modifyAiShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.modifyLoad>0},on:{click:t.onAiModify}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)],1),e("Forwarder",{ref:"forwarder",attrs:{title:t.$L("\u8F6C\u53D1"),"confirm-title":t.$L("\u786E\u8BA4\u8F6C\u53D1"),"multiple-max":50,"msg-detail":t.operateItem,"before-submit":t.onForward}}),e("Modal",{attrs:{title:t.$L("\u8BBE\u7F6E\u5F85\u529E"),"mask-closable":!1},model:{value:t.todoSettingShow,callback:function(i){t.todoSettingShow=i},expression:"todoSettingShow"}},[e("Form",t._b({ref:"todoSettingForm",attrs:{model:t.todoSettingData},nativeOn:{submit:function(i){i.preventDefault()}}},"Form",t.formOptions,!1),[e("FormItem",{attrs:{prop:"type",label:t.$L("\u5F53\u524D\u4F1A\u8BDD")}},[e("RadioGroup",{on:{"on-change":t.onTypeChange},model:{value:t.todoSettingData.type,callback:function(i){t.$set(t.todoSettingData,"type",i)},expression:"todoSettingData.type"}},[e("Radio",{attrs:{label:"all"}},[t._v(t._s(t.$L("\u6240\u6709\u6210\u5458")))]),e("Radio",{attrs:{label:"user"}},[t._v(t._s(t.$L("\u6307\u5B9A\u6210\u5458")))]),e("Radio",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{label:"quick_select"}})],1),e("CheckboxGroup",{on:{"on-change":t.onQuickChange},model:{value:t.todoSettingData.quick_value,callback:function(i){t.$set(t.todoSettingData,"quick_value",i)},expression:"todoSettingData.quick_value"}},t._l(t.todoSettingData.quick_list,function(i){return e("Checkbox",{key:i,attrs:{label:i}},[e("div",{staticClass:"dialog-wrapper-todo"},[e("div",[e("UserAvatar",{attrs:{userid:i,"show-icon":!1,"show-name":!0}}),i==t.userId?e("Tag",[t._v(t._s(t.$L("\u81EA\u5DF1")))]):t._e()],1)])])}),1)],1),t.todoSettingData.type==="user"?e("FormItem",{attrs:{prop:"userids",label:t.$L("\u6307\u5B9A\u6210\u5458")}},[e("UserSelect",{ref:"userSelect",attrs:{"dialog-id":t.dialogId,title:t.$L("\u9009\u62E9\u6307\u5B9A\u6210\u5458")},model:{value:t.todoSettingData.userids,callback:function(i){t.$set(t.todoSettingData,"userids",i)},expression:"todoSettingData.userids"}})],1):t._e()],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.todoSettingShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.todoSettingLoad>0},on:{click:function(i){return t.onTodo("submit")}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),t.todoSpecifyShow?e("UserSelect",{ref:"todoSpecifySelect",attrs:{"dialog-id":t.dialogId,title:t.$L("\u9009\u62E9\u6307\u5B9A\u6210\u5458"),module:"",border:"","before-submit":t.onTodoSpecify},model:{value:t.todoSpecifyData.userids,callback:function(i){t.$set(t.todoSpecifyData,"userids",i)},expression:"todoSpecifyData.userids"}}):t._e(),e("DrawerOverlay",{attrs:{placement:"right",size:400},model:{value:t.groupInfoShow,callback:function(i){t.groupInfoShow=i},expression:"groupInfoShow"}},[t.groupInfoShow?e("DialogGroupInfo",{attrs:{dialogId:t.dialogId},on:{"on-close":function(i){t.groupInfoShow=!1}}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:500},model:{value:t.reportShow,callback:function(i){t.reportShow=i},expression:"reportShow"}},[t.reportShow?e("DialogComplaint",{attrs:{dialogId:t.dialogId},on:{"on-close":function(i){t.reportShow=!1}}}):t._e()],1),e("Modal",{attrs:{title:t.$L("\u8F6C\u8BA9\u7FA4\u4E3B\u8EAB\u4EFD"),"mask-closable":!1},model:{value:t.groupTransferShow,callback:function(i){t.groupTransferShow=i},expression:"groupTransferShow"}},[e("Form",t._b({attrs:{model:t.groupTransferData},nativeOn:{submit:function(i){i.preventDefault()}}},"Form",t.formOptions,!1),[e("FormItem",{attrs:{prop:"userid",label:t.$L("\u65B0\u7684\u7FA4\u4E3B")}},[e("UserSelect",{attrs:{disabledChoice:t.groupTransferData.disabledChoice,"multiple-max":1,title:t.$L("\u9009\u62E9\u65B0\u7684\u7FA4\u4E3B")},model:{value:t.groupTransferData.userid,callback:function(i){t.$set(t.groupTransferData,"userid",i)},expression:"groupTransferData.userid"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.groupTransferShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.groupTransferLoad>0},on:{click:function(i){return t.onDialogMenu("transferConfirm")}}},[t._v(t._s(t.$L("\u786E\u5B9A\u8F6C\u8BA9")))])],1)],1),e("DrawerOverlay",{attrs:{placement:"right","class-name":"dialog-wrapper-drawer-list",size:500},model:{value:t.replyListShow,callback:function(i){t.replyListShow=i},expression:"replyListShow"}},[t.replyListShow?e("DialogWrapper",{staticClass:"inde-list",attrs:{dialogId:t.dialogId,msgId:t.replyListId,isChildComponent:""}},[e("div",{staticClass:"drawer-title",attrs:{slot:"head"},slot:"head"},[t._v(t._s(t.$L("\u56DE\u590D\u6D88\u606F")))])]):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:400},model:{value:t.respondShow,callback:function(i){t.respondShow=i},expression:"respondShow"}},[t.respondShow?e("DialogRespond",{attrs:{"respond-data":t.respondData},on:{"on-close":function(i){t.respondShow=!1}}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:500},model:{value:t.sessionHistoryShow,callback:function(i){t.sessionHistoryShow=i},expression:"sessionHistoryShow"}},[t.sessionHistoryShow?e("DialogSessionHistory",{attrs:{"session-data":t.sessionHistoryData},on:{"on-submit":t.onSessionSubmit,"on-close":function(i){t.sessionHistoryShow=!1}}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right","class-name":"dialog-wrapper-drawer-list",size:500},model:{value:t.todoViewShow,callback:function(i){t.todoViewShow=i},expression:"todoViewShow"}},[e("div",{staticClass:"dialog-wrapper inde-list"},[e("div",{staticClass:"dialog-nav"},[e("div",{staticClass:"drawer-title"},[t._v(t._s(t.$L("\u5F85\u529E\u6D88\u606F")))])]),e("Scrollbar",{attrs:{"class-name":"dialog-scroller"}},[t.todoViewMsg?[e("DialogItem",{attrs:{source:t.todoViewMsg,simpleView:""},on:{"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-emoji":t.onEmoji,"on-other":t.onOther}}),e("Button",{staticClass:"original-button",attrs:{icon:"md-exit",type:"text",loading:t.todoViewPosLoad},on:{click:t.onPosTodo}},[t._v(t._s(t.$L("\u56DE\u5230\u539F\u6587")))])]:e("div",{staticClass:"dialog-float-loading"},[e("Loading")],1)],2),e("div",{staticClass:"todo-button"},[e("Button",{attrs:{type:"primary",size:"large",icon:"md-checkbox-outline",loading:t.todoViewLoad,long:""},on:{click:t.onDoneTodo}},[t._v(t._s(t.$L("\u5B8C\u6210")))])],1)],1)]),e("DialogGroupWordChain"),e("DialogGroupVote")],1):t._e()},Pt=[function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"dialog-top-message-font"},[e("i",{staticClass:"taskfont"},[t._v("\uE7E6")])])}];const Bt={name:"DialogWrapper",components:{Forwarder:U,UserAvatarTip:H,UserSelect:F,ImgUpload:V,DialogRespond:ut,DialogSessionHistory:vt,DialogItem:b,VirtualList:W,ChatInput:j,DialogGroupInfo:rt,DrawerOverlay:G,DialogUpload:tt,DialogGroupWordChain:Dt,DialogGroupVote:Tt,DialogComplaint:Vt},directives:{touchclick:N},props:{dialogId:{type:Number,default:0},msgId:{type:Number,default:0},autoFocus:{type:Boolean,default:!1},location:{type:String,default:""},isChildComponent:{type:Boolean,default:!1},beforeBack:Function},data(){return{loadIng:0,msgItem:b,msgText:"",msgNew:0,msgType:"",msgActivity:!1,msgPrepared:!1,focusLazy:!1,focusTimer:null,allMsgs:[],tempMsgs:[],tempId:$A.randNum(1e9,9999999999),msgLoadIng:0,msgActiveId:0,pasteShow:!1,pasteFile:[],pasteItem:[],searchShow:!1,searchKey:"",searchLoad:0,searchLocation:1,searchResult:[],modifyShow:!1,modifyAiShow:!1,modifyData:{},modifyLoad:0,openId:0,errorId:0,dialogDrag:!1,groupInfoShow:!1,reportShow:!1,groupTransferShow:!1,groupTransferLoad:0,groupTransferData:{userid:[],disabledChoice:[]},operateClient:{x:0,y:0},operateVisible:!1,operatePreventScroll:0,operateCopys:[],operateStyles:{},operateItem:{},recordState:"",pointerMouse:!1,scrollTail:0,scrollOffset:0,replyListShow:!1,replyListId:0,respondShow:!1,respondData:{},sessionHistoryShow:!1,sessionHistoryData:{},todoSettingShow:!1,todoSettingLoad:0,todoSettingData:{type:"all",userids:[],quick_value:[]},todoSpecifyShow:!1,todoSpecifyData:{type:"user",userids:[]},todoViewLoad:!1,todoViewPosLoad:!1,todoViewShow:!1,todoViewData:{},todoViewMid:0,todoViewId:0,scrollDisabled:!1,scrollDirection:null,scrollAction:0,scrollTmp:0,scrollIng:0,scrollGroup:null,approvaUserStatus:"",observers:[],msgChangeCache:{},unreadOne:0,startMsgId:0,topPosLoad:0,positionLoad:0,positionShow:!1,preventPrevLoad:0,preventRangeLoad:0,preventToBottom:!1,scrollToBottomRefresh:!1,androidKeyboardVisible:!1,replyMsgAutoMention:!1,waitUnreadData:new Map,replyEmojiIngs:{},dialogAiModel:[]}},async created(){this.dialogAiModel=await $A.IDBArray("dialogAiModel")},mounted(){u.on("websocketMsg",this.onWebsocketMsg),u.on("dialogMsgChange",this.onMsgChange),this.windowTouch&&document.addEventListener("selectionchange",this.onSelectionchange)},beforeDestroy(){this.windowTouch&&document.removeEventListener("selectionchange",this.onSelectionchange),u.off("dialogMsgChange",this.onMsgChange),u.off("websocketMsg",this.onWebsocketMsg),this.generateUnreadData(this.dialogId),this.isChildComponent||(this.$store.dispatch("forgetInDialog",{uid:this._uid}),this.$store.dispatch("closeDialog",{id:this.dialogId})),this.observers.forEach(({observer:s})=>s.disconnect()),this.observers=[];const t=this.$refs.scroller;t&&t.virtual.destroy()},computed:{...v(["systemConfig","userIsAdmin","taskId","dialogSearchMsgId","dialogMsgs","dialogTodos","dialogMsgTops","dialogMsgTransfer","dialogMsgKeep","dialogIns","cacheDialogs","wsOpenNum","touchBackInProgress","cacheUserBasic","fileLinks","cacheEmojis","readLoadNum","readTimeout","keyboardType","keyboardHeight","safeAreaBottom","formOptions","cacheTranslationLanguage"]),...O(["isLoad","isMessengerPage","getDialogQuote"]),isReady(){return this.dialogId>0&&this.dialogData.id>0},dialogData(){const t=this.cacheDialogs.find(({id:s})=>s==this.dialogId)||{};return this.unreadOne===0&&(this.unreadOne=t.unread_one||0),t},dialogList(){return this.cacheDialogs.filter(t=>!(t.name===void 0||t.dialog_delete===1)).sort((t,s)=>t.top_at||s.top_at?$A.sortDay(s.top_at,t.top_at):t.todo_num>0||s.todo_num>0?$A.sortFloat(s.todo_num,t.todo_num):$A.sortDay(s.last_at,t.last_at))},dialogMsgList(){return this.isReady?this.dialogMsgs.filter(t=>t.dialog_id==this.dialogId):[]},tempMsgList(){return this.isReady?this.tempMsgs.filter(t=>t.dialog_id==this.dialogId):[]},allMsgList(){const t=[];if(t.push(...this.dialogMsgList.filter(s=>this.msgFilter(s))),this.msgId>0){const s=this.dialogMsgs.find(e=>e.id==this.msgId);s&&t.unshift(s)}if(this.tempMsgList.length>0){const s=t.map(({id:i})=>i),e=this.tempMsgList.filter(i=>!s.includes(i.id)&&this.msgFilter(i));e.length>0&&t.push(...e)}return t.sort((s,e)=>s.id-e.id)},loadMsg(){return this.isLoad(`msg::${this.dialogId}-${this.msgId}-${this.msgType}`)},prevId(){return this.allMsgs.length>0?$A.runNum(this.allMsgs[0].prev_id):0},peopleNum(){return this.dialogData.type==="group"?$A.runNum(this.dialogData.people_user):0},pasteTitle(){const{pasteItem:t}=this;let s=t.find(({type:i})=>i=="image"),e=t.find(({type:i})=>i!="image");return s&&e?"\u53D1\u9001\u6587\u4EF6/\u56FE\u7247":s?"\u53D1\u9001\u56FE\u7247":"\u53D1\u9001\u6587\u4EF6"},msgTags({dialogData:t}){const s=[{type:"",label:"\u6D88\u606F"}];return t.has_tag&&s.push({type:"tag",label:"\u6807\u6CE8"}),t.has_todo&&s.push({type:"todo",label:"\u4E8B\u9879"}),t.has_image&&s.push({type:"image",label:"\u56FE\u7247"}),t.has_file&&s.push({type:"file",label:"\u6587\u4EF6"}),t.has_link&&s.push({type:"link",label:"\u94FE\u63A5"}),t.group_type==="project"&&s.push({type:"project",label:"\u6253\u5F00\u9879\u76EE"}),t.group_type==="task"&&s.push({type:"task",label:"\u6253\u5F00\u4EFB\u52A1"}),t.group_type==="okr"&&s.push({type:"okr",label:"\u6253\u5F00OKR"}),s},topMsg(){return this.dialogData.top_msg_id&&this.dialogMsgTops.find(({id:t})=>t==this.dialogData.top_msg_id)},quickMsgs(){return this.dialogData.quick_msgs||[]},todoList(){return this.dialogData.todo_num?this.dialogTodos.filter(t=>!t.done_at&&t.dialog_id==this.dialogId).sort((t,s)=>s.id-t.id):[]},isDefaultSize(){return this.windowScrollY===0&&!this.androidKeyboardVisible},quickShow(){return this.quickMsgs.length>0&&this.isDefaultSize&&this.quoteId===0},todoShow(){return this.todoList.length>0&&this.isDefaultSize&&this.quoteId===0},tagShow(){return this.msgTags.length>1&&this.isDefaultSize&&!this.searchShow},topShow(){return this.topMsg&&this.isDefaultSize&&!this.searchShow&&this.msgType===""},wrapperClass(){return["ready","ing"].includes(this.recordState)?"record-ready":null},navClass(){return{completed:$A.dialogCompleted(this.dialogData),tagged:this.tagShow}},pasteClass(){return this.pasteItem.find(({type:t})=>t!=="image")?["multiple"]:[]},footerPaddingBottom({keyboardType:t,keyboardHeight:s,safeAreaBottom:e,windowScrollY:i,location:a,focusLazy:o}){return i<2&&a&&o&&t==="show"&&s>0&&s<120?s+e+(a==="modal"?15:0):0},msgUnreadOnly(){let t=0;return this.cacheDialogs.some(s=>{if(s.id==this.dialogId)return!1;t+=$A.getDialogNum(s)}),t<=0?"":(t>999&&(t="999+"),String(t))},isMyDialog(){const{dialogData:t,userId:s}=this;return t.dialog_user&&t.dialog_user.userid==s},isManageBot(){const{dialogData:t,userId:s,userIsAdmin:e}=this;return t.bot?t.bot==s?!0:t.dialog_user&&t.dialog_user.userid==t.bot&&e:!1},isAiBot({dialogData:t}){return!t.bot||t.type!=="user"?!1:/^ai-(.*?)@bot\.system/.test(t.email)},isMute(){return this.dialogData.dialog_mute==="close"?!this.userIsAdmin:!1},isDisable(){var t;return(t=this.dialogData.is_disable)!=null?t:!1},quoteData(){var t;return((t=this.getDialogQuote(this.dialogId))==null?void 0:t.content)||null},quoteUpdate(){var t;return((t=this.getDialogQuote(this.dialogId))==null?void 0:t.type)==="update"},quoteId(){var t;return this.msgId>0?this.msgId:((t=this.quoteData)==null?void 0:t.id)||0},todoViewMsg(){if(this.todoViewMid){const t=this.allMsgs.find(s=>s.id==this.todoViewMid);if(t)return t;if(this.todoViewData.id===this.todoViewMid)return this.todoViewData}return null},positionMsg({msgNew:t,dialogData:s,allMsgs:e,startMsgId:i}){const{unread:a,unread_one:o,mention:n,mention_ids:r}=s,l=a-t,d=[];return o&&o<i&&d.push({type:"unread",label:this.$L(`\u672A\u8BFB\u6D88\u606F${l}\u6761`),msg_id:o}),r&&r.length>0&&d.push(...r.map(c=>({type:"mention",label:this.$L("@\u6211\u7684\u6D88\u606F"),msg_id:c}))),l<=0||d.length===0||e.length===0?null:d.find(c=>c.type===(n===0?"unread":"mention"))||d[0]},operateEmojis({cacheEmojis:t}){const s=t.slice(0,3);return Object.values(["\u{1F44C}","\u{1F44D}","\u{1F602}","\u{1F389}","\u2764\uFE0F","\u{1F973}\uFE0F","\u{1F970}","\u{1F625}","\u{1F62D}"]).some(e=>{s.includes(e)||s.push(e)}),s},maxSize({systemConfig:t}){return t!=null&&t.file_upload_limit?t.file_upload_limit*1024:1024e3},readEnabled({msgActivity:t,msgPrepared:s}){return t===0&&s},stickToBottom({windowActive:t,scrollTail:s,preventToBottom:e}){return t&&s<=0&&!e}},watch:{dialogId:{handler(t,s){this.getDialogBase(t),this.generateUnreadData(s),this.$store.dispatch("closeDialog",{id:s}),window.localStorage.removeItem("__cache:vote__"),window.localStorage.removeItem("__cache:unfoldWordChain__")},immediate:!0},loadMsg:{handler(t){t?this.loadIng++:setTimeout(s=>{this.loadIng--},300)},immediate:!0},isReady:{handler(t){!t||this.$nextTick(s=>{if(this.$refs.msgs&&!this.observers.find(({key:e})=>e==="scroller")){const e=new ResizeObserver(this.onResizeEvent);e.observe(this.$refs.msgs),this.observers.push({key:"scroller",observer:e})}if(this.$refs.scroller&&(this.scrollGroup=this.$refs.scroller.$el.querySelector('[role="group"]'),this.scrollGroup&&!this.observers.find(({key:e})=>e==="scrollGroup"))){const e=new ResizeObserver(this.onResizeEvent);e.observe(this.scrollGroup),this.observers.push({key:"scrollGroup",observer:e})}})},immediate:!0},msgType(){this.onGetMsgClear()},searchKey(t){!t||(this.searchLoad++,setTimeout(s=>{this.searchKey===t&&(this.searchLoad++,this.searchResult=[],this.searchLocation=0,this.$store.dispatch("call",{url:"dialog/msg/search",data:{dialog_id:this.dialogId,key:t}}).then(({data:e})=>{this.searchKey===t&&(e.data.length===0&&$A.messageWarning("\u6CA1\u6709\u627E\u5230\u76F8\u5173\u6D88\u606F"),this.searchResult=e.data,this.searchLocation=this.searchResult.length)}).finally(e=>{this.searchLoad--})),this.searchLoad--},600))},searchLocation(t){if(t===0)return;const s=this.searchResult[t-1];s&&this.onPositionId(s)},dialogSearchMsgId(){this.onSearchMsgId()},dialogMsgTransfer:{handler({time:t,msgFile:s,msgRecord:e,msgText:i,dialogId:a}){t>$A.dayjs().unix()&&a==this.dialogId&&(this.$store.state.dialogMsgTransfer.time=0,this.$nextTick(()=>{$A.isArray(s)&&s.length>0?this.sendFileMsg(s):$A.isJson(e)&&e.duration>0?this.sendRecord(e):i&&this.sendMsg(i)}))},immediate:!0},wsOpenNum(t){if(t<=1)return;const s=this.allMsgs[this.allMsgs.length-1];if(!s)return;if($A(this.$refs.scroller.$el).find(`[data-id="${s.id}"]`).length===0){this.scrollToBottomRefresh=!0;return}this.errorId===this.dialogId?this.getDialogBase(this.dialogId):this.onReGetMsg()},allMsgList(t){if(JSON.stringify(t)==JSON.stringify(this.allMsgs))return;const s=this.allMsgs.length,e=s>0?this.allMsgs[s-1].id:0;if($A.isIos()&&t.length!==s&&this.$refs.scroller){const i=this.$refs.scroller.$el;i.style.visibility="hidden",this.allMsgs=t,this.$nextTick(a=>{i.style.visibility="visible"})}else this.allMsgs=t;this.stickToBottom||(this.msgNew+=t.filter(i=>i.id&&i.id>e&&i.userid!=this.userId&&!i.read_at).length)},"allMsgs.length"(){this.stickToBottom&&this.onToBottom()},windowScrollY(t){$A.isIos()&&!this.$slots.head&&(this.$refs.nav.style.marginTop=`${Math.max(0,t)}px`)},windowActive(t){if(t&&this.autoFocus){const s=$A.last(this.dialogIns);s&&s.uid===this._uid&&this.inputFocus()}},windowHeight(){this.androidKeyboardVisible=$A.isAndroid()&&$A.eeuiAppKeyboardStatus(),requestAnimationFrame(this.$refs.input.updateTools)},dialogDrag(t){t&&(this.operateVisible=!1)},msgActiveId(t){t>0&&(this.msgActiveId=0,this.shakeToMsgId(t))},footerPaddingBottom(t){this.$refs.footer.style.paddingBottom=`${t}px`,requestAnimationFrame(s=>{this.$refs.input.updateTools()})},readLoadNum(){this.positionShow=!0},operateVisible(t){t||this.pointerMouse||this.focusLazy||document.getSelection().removeAllRanges()}},methods:{getDialogBase(t){!t||(this.msgNew=0,this.msgType="",this.searchKey="",this.unreadOne=0,this.startMsgId=0,this.scrollTail=0,this.scrollOffset=0,this.searchShow=!1,this.positionShow=!1,this.msgPrepared=!1,this.scrollToBottomRefresh=!1,this.replyMsgAutoMention=!1,this.allMsgs=this.allMsgList,this.errorId=0,this.waitUnreadData.delete(t),this.getMsgs({dialog_id:t,msg_id:this.msgId,msg_type:this.msgType}).then(({data:s})=>{this.openId=t,this.msgPrepared=!0;const e=this.waitUnreadData.get(t)||[];if(e.length>0){const i=[...s.list.map(a=>a.id)].reverse();$A.getLastSameElements(e,i).forEach(a=>{this.$store.dispatch("dialogMsgRead",{id:a,dialog_id:t})})}setTimeout(i=>{this.onSearchMsgId(),this.positionShow=this.readTimeout===null,this.startMsgId===0&&s.list.length>0&&(this.startMsgId=s.list[s.list.length-1].id)},100)}).catch(s=>{this.errorId=t}),this.$store.dispatch("saveInDialog",{uid:this._uid,dialog_id:t}),this.autoFocus&&this.inputFocus(),this.getUserApproveStatus())},generateUnreadData(t){var a,o;if(!t)return;const s=[],e=this.allMsgs.filter(n=>n.read_at===null&&n.userid!=this.userId).map(n=>n.id),i=((a=this.$refs.scroller)==null?void 0:a.$el.querySelectorAll(".item-enter"))||[];for(const n of i){const r=$A.runNum((o=n.querySelector(".dialog-view"))==null?void 0:o.getAttribute("data-id"));r&&!e.includes(r)&&e.push(r)}this.waitUnreadData.set(t,$A.getLastSameElements(e,s))},sendDataHandle(t){return this.isAiBot&&(t.model_name=this.aiModelValue()),t},sendMsg(t,s){let e,i="text",a="no",o=!1;if(typeof t=="string"&&t?e=t:(e=this.msgText,o=!0),s==="md"?(e=this.$refs.input.getText(),i="md"):s==="silence"&&(a="yes"),e==""){this.inputFocus();return}if(i==="text"&&(e=e.replace(/<\/span> <\/p>$/,"</span></p>").replace(/(<span\s+class="mention"(.*?)>.*?<\/span>.*?<\/span>.*?<\/span>)(\x20)?/,"$1 ")),this.quoteUpdate){i==="text"&&(e=e.replace(new RegExp(`src=(["'])${$A.mainUrl()}`,"g"),"src=$1{{RemoteURL}}"));const n=this.quoteId;this.$store.dispatch("setLoad",{key:`msg-${n}`,delay:600}),this.cancelQuote(),this.onActive(),this.$store.dispatch("call",{url:"dialog/msg/sendtext",data:this.sendDataHandle({dialog_id:this.dialogId,update_id:n,text:e,text_type:i,silence:a}),method:"post",complete:r=>this.$store.dispatch("cancelLoad",`msg-${n}`)}).then(({data:r})=>{this.sendSuccess(r,0,!0),this.onPositionId(n)}).catch(({msg:r})=>{$A.modalError(r)})}else{const n=$A.stringLength(e.replace(/<img[^>]*?>/g,""))>5e3,r={id:this.getTempId(),dialog_id:this.dialogData.id,reply_id:this.quoteId,type:n?"loading":"text",userid:this.userId,msg:{type:i,text:n?"":e,reply_data:this.quoteData}};this.tempMsgs.push(r),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom),this.$store.dispatch("call",{requestId:r.id,url:"dialog/msg/sendtext",data:this.sendDataHandle({dialog_id:r.dialog_id,reply_id:r.reply_id,text:e,text_type:i,silence:a}),method:"post"}).then(({data:l})=>{this.sendSuccess(l,r.id)}).catch(l=>{this.$set(r,"error",!0),this.$set(r,"errorData",{type:"text",mType:s,content:l.msg,msg:e})})}o&&requestAnimationFrame(n=>this.msgText="")},sendRecord(t){const s={id:this.getTempId(),dialog_id:this.dialogData.id,reply_id:this.quoteId,type:"record",userid:this.userId,msg:Object.assign(t,{reply_data:this.quoteData})};this.tempMsgs.push(s),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom),this.$store.dispatch("call",{requestId:s.id,url:"dialog/msg/sendrecord",data:Object.assign(t,{dialog_id:this.dialogId,reply_id:this.quoteId}),method:"post"}).then(({data:e})=>{this.sendSuccess(e,s.id)}).catch(e=>{this.$set(s,"error",!0),this.$set(s,"errorData",{type:"record",mType:"record",content:e.msg,msg:t})})},sendFileMsg(t){const s=$A.isArray(t)?t:[t];s.length>0&&(this.pasteFile=[],this.pasteItem=[],s.some(e=>{if(e.type==="photo")return this.sendPhoto(e.msg),!1;const i={type:$A.getMiddle(e.type,null,"/"),name:e.name,size:e.size,result:null};if(i.type==="image"){const a=new FileReader;a.readAsDataURL(e),a.onload=({target:o})=>{i.result=o.result,this.pasteFile.push(e),this.pasteItem.push(i),this.pasteShow=!0}}else this.pasteFile.push(e),this.pasteItem.push(i),this.pasteShow=!0}))},sendPhoto(t){const s={id:$A.randNum(1e9,9999999999),file_uid:0,file_method:"photo",dialog_id:this.dialogData.id,reply_id:this.quoteId,type:"file",userid:this.userId,msg:t};this.tempMsgs.push(s),$A.eeuiAppUploadPhoto({url:$A.apiUrl("dialog/msg/sendfile"),data:{dialog_id:s.dialog_id,filename:t.filename},headers:{token:this.userToken},path:t.path,fieldName:"files",onReady:e=>{this.$set(s,"file_uid",e)}}).then(e=>{this.sendSuccess(e,s.id)}).catch(({msg:e})=>{this.forgetTempMsg(s.id),$A.messageError(e||"\u4E0A\u4F20\u5931\u8D25")})},sendLocationMsg(t){this.$store.dispatch("call",{url:"dialog/msg/sendlocation",data:Object.assign(t,{dialog_id:this.dialogId}),spinner:!0,method:"post"}).then(({data:s})=>{this.sendSuccess(s)}).catch(({msg:s})=>{$A.modalConfirm({icon:"error",title:"\u53D1\u9001\u5931\u8D25",content:s,cancelText:"\u53D6\u6D88\u53D1\u9001",okText:"\u91CD\u65B0\u53D1\u9001",onOk:e=>{this.sendLocationMsg(t)}})})},aiModelValue(){const t=this.dialogAiModel.find(({dialog_id:s})=>s==this.dialogId);return t==null?void 0:t.model},quickLabel({key:t,label:s,config:e}){if(t==="~ai-model-select"){const i=this.aiModelValue();i?s=i:e!=null&&e.model&&(s=e.model),e!=null&&e.models&&e.models.forEach(({value:a,label:o})=>{a===s&&(s=o)})}return s},sendQuick(t,s=void 0){var e,i;switch(t.key){case"locat-checkin":this.$store.dispatch("openAppMapPage",{key:t.config.key,point:`${t.config.lng},${t.config.lat}`,radius:t.config.radius}).then(r=>{if(!$A.isJson(r))return;if(r.distance>t.config.radius){$A.modalError(`\u4F60\u9009\u62E9\u7684\u4F4D\u7F6E\u300C${r.title}\u300D\u4E0D\u5728\u7B7E\u5230\u8303\u56F4\u5185`);return}const l=$A.urlAddParams("https://api.map.baidu.com/staticimage/v2",{ak:t.config.key,center:`${r.point.lng},${r.point.lat}`,markers:`${r.point.lng},${r.point.lat}`,width:800,height:480,zoom:19,copyright:1});this.sendLocationMsg({type:"bd",lng:r.point.lng,lat:r.point.lat,title:r.title,distance:r.distance,address:r.address||"",thumb:l})});break;case"meeting-create":u.emit("addMeeting",{type:"create",userids:[this.userId]});break;case"meeting-join":u.emit("addMeeting",{type:"join"});break;case"~ai-model-select":if(!this.isAiBot)return;const a=(e=t.config)==null?void 0:e.models,o=$A.isArray(a)?a:[];let n=this.aiModelValue();!n&&((i=t.config)==null?void 0:i.model)&&(n=t.config.model),this.$store.state.menuOperation={event:s,list:o,active:n,onUpdate:async r=>{this.dialogAiModel=[...this.dialogAiModel.filter(({dialog_id:l})=>l!==this.dialogId),{dialog_id:this.dialogId,model:r}],await $A.IDBSet("dialogAiModel",this.dialogAiModel)}};break;case"~ai-session-create":if(!this.isAiBot)return;this.$store.dispatch("call",{url:"dialog/session/create",data:{dialog_id:this.dialogId},spinner:300}).then(()=>{this.onGetMsgClear()}).catch(({msg:r})=>{$A.modalError(r)});break;case"~ai-session-history":if(!this.isAiBot)return;this.sessionHistoryData={dialog_id:this.dialogId,name:this.dialogData.name},this.sessionHistoryShow=!0;break;default:if(/^~/.test(t.key)){$A.modalWarning("\u5F53\u524D\u5BA2\u6237\u7AEF\u4E0D\u652F\u6301\u8BE5\u6307\u4EE4");break}this.sendMsg(`<p><span data-quick-key="${t.key}">${t.label}</span></p>`);break}},onWebsocketMsg(t){if(!$A.isSubElectron)return;const{type:s,mode:e,data:i}=t;s==="dialog"&&e==="add"&&this.tempMsgs.push(i)},onMsgChange(t){const s=this.allMsgs.find(({type:e,id:i})=>e=="text"&&i==t.id);if(!!s){switch(typeof this.msgChangeCache[t.id]=="undefined"&&(this.msgChangeCache[t.id]=[],this.msgChangeCache[`${t.id}_load`]=!1),t.type){case"append":t.text&&this.msgChangeCache[t.id].push(...`${t.text}`.split("").map(e=>({type:"append",text:e})));break;case"replace":this.msgChangeCache[t.id]=[{type:"replace",text:t.text}];break}this.onMsgOutput(t.id,s.msg)}},onMsgOutput(t,s){const e=`${t}_load`,i=this.msgChangeCache[t];if(!(!i||i.length===0)&&this.msgChangeCache[e]!==!0){this.msgChangeCache[e]=!0;try{const a=i.shift();if(!a){this.msgChangeCache[e]=!1;return}const{type:o,text:n}=a,{tail:r}=this.scrollInfo();o==="append"?s.text+=n:o==="replace"&&(s.text=n);const l=s.text;this.$nextTick(d=>{if(r<=10&&r!=this.scrollInfo().tail&&(this.operatePreventScroll++,this.$refs.scroller.scrollToBottom(),setTimeout(c=>this.operatePreventScroll--,50)),i.length===0){this.msgChangeCache[e]=!1;return}setTimeout(c=>{this.msgChangeCache[e]=!1,l===s.text&&this.onMsgOutput(t,s)},5)})}catch{this.msgChangeCache[e]=!1}}},getTempId(){return this.tempId++},getMsgs(t){return new Promise((s,e)=>{setTimeout(i=>this.msgLoadIng++,2e3),this.$store.dispatch("getDialogMsgs",t).then(s).catch(e).finally(i=>{this.msgLoadIng--})})},msgFilter(t){if(this.msgType){if(this.msgType==="tag"){if(!t.tag)return!1}else if(this.msgType==="todo"){if(!t.todo)return!1}else if(this.msgType==="link"){if(!t.link)return!1}else if(this.msgType!==t.mtype)return!1}return!(this.msgId&&t.reply_id!=this.msgId)},onSearchMsgId(){this.dialogSearchMsgId>0&&this.openId===this.dialogId&&(this.onPositionId(this.dialogSearchMsgId),this.$store.state.dialogSearchMsgId=0)},onPositionId(t,s=0,e=0){return new Promise((i,a)=>{if(t===0){$A.modalError("\u67E5\u770B\u5931\u8D25\uFF1A\u53C2\u6570\u9519\u8BEF"),a();return}if(this.loadMsg||this.msgType!==""){if(this.msgType="",e===0)this.$store.dispatch("showSpinner",600);else if(e>20){this.$store.dispatch("hiddenSpinner"),$A.modalError("\u67E5\u770B\u5931\u8D25\uFF1A\u8BF7\u6C42\u8D85\u65F6"),a();return}e++,setTimeout(r=>{this.onPositionId(t,s,e).then(i).catch(a)},Math.min(800,200*e));return}e>0&&this.$store.dispatch("hiddenSpinner");const o=this.allMsgs.findIndex(r=>r.id===t),n=this.prevId>0?0:-1;o>n?setTimeout(r=>{this.onToIndex(o,t),i()},200):(s>0&&this.$store.dispatch("setLoad",{key:`msg-${s}`,delay:600}),this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,position_id:t,spinner:2e3,save_before:r=>{this.preventToBottom=!0},save_after:r=>{this.$nextTick(l=>{this.preventToBottom=!1})}}).finally(r=>{const l=this.allMsgs.findIndex(d=>d.id===t);l>-1&&(this.onToIndex(l,t),i()),s>0&&this.$store.dispatch("cancelLoad",`msg-${s}`)}))})},onViewTodo(t){if(this.operateVisible)return;this.todoViewId=t.id,this.todoViewMid=t.msg_id,this.todoViewShow=!0,this.allMsgs.findIndex(e=>e.id===this.todoViewMid)===-1&&this.$store.dispatch("call",{url:"dialog/msg/one",data:{msg_id:this.todoViewMid}}).then(({data:e})=>{this.todoViewData=e})},onCloseTodo(){this.todoViewLoad=!1,this.todoViewShow=!1,this.todoViewData={},this.todoViewMid=0,this.todoViewId=0},onPosTodo(){!this.todoViewMid||(this.todoViewPosLoad=!0,this.onPositionId(this.todoViewMid).then(this.onCloseTodo).finally(t=>{this.todoViewPosLoad=!1}))},onDoneTodo(){!this.todoViewId||this.todoViewLoad||(this.todoViewLoad=!0,this.$store.dispatch("call",{url:"dialog/msg/done",data:{id:this.todoViewId}}).then(({data:t})=>{this.$store.dispatch("saveDialogTodo",{id:this.todoViewId,done_at:$A.daytz().format("YYYY-MM-DD HH:mm:ss")}),this.$store.dispatch("saveDialog",{id:this.dialogId,todo_num:this.todoList.length}),t.add&&this.sendSuccess(t.add),this.todoList.length===0&&this.$store.dispatch("getDialogTodo",this.dialogId),this.onCloseTodo()}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.todoViewLoad=!1}))},inputFocus(){this.$nextTick(t=>{this.$refs.input&&this.$refs.input.focus()})},onRecordState(t){this.recordState=t},chatPasteDrag(t,s){if(this.dialogDrag=!1,$A.dataHasFolder(s==="drag"?t.dataTransfer:t.clipboardData)){t.preventDefault(),$A.modalWarning(`\u6682\u4E0D\u652F\u6301${s==="drag"?"\u62D6\u62FD":"\u7C98\u8D34"}\u6587\u4EF6\u5939\u3002`);return}const e=s==="drag"?t.dataTransfer.files:t.clipboardData.files,i=Array.prototype.slice.call(e);i.length>0&&(t.preventDefault(),this.sendFileMsg(i))},chatDragOver(t,s){let e=this.__dialog_drag=$A.randomString(8);if(!t)setTimeout(()=>{e===this.__dialog_drag&&(this.dialogDrag=t)},150);else{if(s.dataTransfer.effectAllowed==="move"||Array.prototype.slice.call(s.dataTransfer.files).length===0)return;this.dialogDrag=!0}},onTouchStart(){this.androidKeyboardVisible&&$A.eeuiAppSetDisabledUserLongClickSelect(500)},onPointerover({pointerType:t}){this.pointerMouse=t==="mouse"},pasteSend(){this.__paste_send_index||(this.__paste_send_index=1,setTimeout(()=>{this.__paste_send_index=0},300),this.pasteFile.some(t=>{this.$refs.chatUpload.upload(t)}))},chatFile(t,s){switch(t){case"progress":const e=s.showProgress?Math.max(s.percentage,.01):!1,i=this.tempMsgs.find(({id:o})=>o==s.tempId);if(i){i.msg.percentage=e;return}const a={id:s.tempId,file_uid:s.uid,file_method:"uplaod",dialog_id:this.dialogData.id,reply_id:this.quoteId,type:"file",userid:this.userId,msg:Object.assign(s.msg||{},{percentage:e})};this.tempMsgs.push(a),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom);break;case"error":this.forgetTempMsg(s.tempId);break;case"success":this.sendSuccess(s.data,s.tempId);break}},sendSuccess(t,s=0,e=!1){if($A.isArray(t)){t.some(i=>{this.sendSuccess(i,s)});return}if(s>0){const i=this.tempMsgs.findIndex(({id:a})=>a==s);i>-1&&this.tempMsgs.splice(i,1,t),setTimeout(a=>{this.forgetTempMsg(s),this.forgetTempMsg(t.id)},1e3)}this.$store.dispatch("saveDialog",{id:this.dialogId,hide:0}),this.$store.dispatch("saveDialogMsg",t),e||(this.$store.dispatch("increaseTaskMsgNum",{id:t.dialog_id}),this.$store.dispatch("increaseMsgReplyNum",{id:t.reply_id}),this.$store.dispatch("updateDialogLastMsg",t)),this.cancelQuote(),this.onActive()},forgetTempMsg(t){this.tempMsgs=this.tempMsgs.filter(({id:s})=>s!=t)},setQuote(t,s){var e;(e=this.$refs.input)==null||e.setQuote(t,s)},cancelQuote(){var t;(t=this.$refs.input)==null||t.cancelQuote()},onEventFocus(){this.focusTimer&&clearTimeout(this.focusTimer),this.focusLazy=!0,this.$emit("on-focus")},onEventBlur(){this.focusTimer=setTimeout(t=>this.focusLazy=!1,10),this.$emit("on-blur")},onEventMore(t){switch(t){case"image":case"file":this.$refs.chatUpload.handleClick();break;case"call":this.onCallTel();break;case"anon":this.onAnon();break}},onCallTel(){$A.modalConfirm({content:`\u662F\u5426\u62E8\u6253\u7535\u8BDD\u7ED9 ${this.dialogData.name}\uFF1F`,onOk:()=>{this.$store.dispatch("call",{url:"dialog/tel",data:{dialog_id:this.dialogId},spinner:600}).then(({data:t})=>{t.tel&&$A.eeuiAppSendMessage({action:"callTel",tel:t.tel}),t.add&&(this.$store.dispatch("saveDialogMsg",t.add),this.$store.dispatch("updateDialogLastMsg",t.add),this.onActive())}).catch(({msg:t})=>{$A.modalError(t)})}})},onAnon(){if(this.dialogData.type!=="user"||this.dialogData.bot){$A.modalWarning("\u533F\u540D\u6D88\u606F\u4EC5\u5141\u8BB8\u53D1\u9001\u7ED9\u4E2A\u4EBA");return}$A.modalInput({title:"\u53D1\u9001\u533F\u540D\u6D88\u606F",placeholder:"\u533F\u540D\u6D88\u606F\u5C06\u901A\u8FC7\u533F\u540D\u6D88\u606F\uFF08\u673A\u5668\u4EBA\uFF09\u53D1\u9001\u7ED9\u5BF9\u65B9\uFF0C\u4E0D\u4F1A\u8BB0\u5F55\u4F60\u7684\u4EFB\u4F55\u8EAB\u4EFD\u4FE1\u606F",inputProps:{type:"textarea",rows:3,autosize:{minRows:3,maxRows:6},maxlength:2e3},okText:"\u533F\u540D\u53D1\u9001",onOk:t=>t?new Promise((s,e)=>{this.$store.dispatch("call",{url:"dialog/msg/sendanon",data:{userid:this.dialogData.dialog_user.userid,text:t},method:"post"}).then(({msg:i})=>{s(i)}).catch(({msg:i})=>{e(i)})}):"\u8BF7\u8F93\u5165\u6D88\u606F\u5185\u5BB9"})},onResizeEvent(t){t.some(({target:s,contentRect:e})=>{s===this.$refs.msgs?this.onMsgsResize(e):s===this.scrollGroup&&this.onScrollGroupResize(e)})},onMsgsResize({height:t}){if(this.$refs.scroller.$el.style.height=`${t}px`,typeof this.__msgs_height!="undefined"){const s=this.__msgs_height-t;if(s!==0){const{offset:e,tail:i}=this.scrollInfo();i>0&&this.onToOffset(e+s)}}this.__msgs_height=t},onScrollGroupResize(){this.stickToBottom&&this.onToBottom()},onActive(){this.$emit("on-active")},onToBottom(){this.msgNew=0;const t=this.$refs.scroller;t&&this.preventLoad().then(s=>{t.scrollToBottom()})},onToIndex(t,s){const e=this.$refs.scroller;if(e){e.stopToBottom();const i=e.$el.querySelector(`[data-id="${s}"]`);i!=null&&i.parentNode.parentNode.classList.contains("item-enter")||this.preventLoad().then(a=>{e.scrollToIndex(t,-80)})}requestAnimationFrame(i=>this.msgActiveId=s)},onToOffset(t,s=!1){const e=this.$refs.scroller;if(e){const i=e.getOffset()>t;e.stopToBottom(),e.scrollToOffset(t),setTimeout(a=>{i||s?e.virtual.handleFront():e.virtual.handleBehind()},10)}},preventLoad(){return new Promise(t=>{this.preventPrevLoad++,this.preventRangeLoad++,t(),requestAnimationFrame(s=>{this.preventPrevLoad--,this.preventRangeLoad--})})},scrollInfo(){const t=this.$refs.scroller;return t?t.scrollInfo():{offset:0,scale:0,tail:0}},openProject(){!this.dialogData.group_info||((!this.isMessengerPage||this.windowPortrait)&&this.$store.dispatch("openDialog",0),this.goForward({name:"manage-project",params:{projectId:this.dialogData.group_info.id}}))},openTask(){!this.dialogData.group_info||this.$store.dispatch("openTask",{id:this.dialogData.group_info.id,deleted_at:this.dialogData.group_info.deleted_at,archived_at:this.dialogData.group_info.archived_at})},openOkr(){!this.dialogData.link_id||this.$store.dispatch("openOkr",this.dialogData.link_id)},onSessionSubmit(){this.sessionHistoryShow=!1,this.onGetMsgClear()},onGetMsgClear(){this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,clear_before:!0}).then(t=>{this.onToBottom()}).catch(t=>{})},onReGetMsg(){this.scrollToBottomRefresh=!1,this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType}).catch(t=>{})},onPrevPage(){this.prevId===0||this.preventPrevLoad>0||this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,prev_id:this.prevId,save_before:t=>this.scrollDisabled=!0,save_after:t=>this.scrollDisabled=!1}).then(({data:t})=>{const s=t.list.map(e=>e.id);this.$nextTick(()=>{const e=this.$refs.scroller,i=s.reduce((a,o)=>({size:(typeof a=="object"?a.size:e.getSize(a))+e.getSize(o)}));this.onToOffset(e.getOffset()+i.size,!0)})}).catch(()=>{})},onDialogMenu(t){var s;switch(t){case"single":this.$store.dispatch("openDialog",{dialog_id:this.dialogData.id,single:!0}),!this.isMessengerPage&&this.$store.dispatch("openDialog",0);break;case"searchMsg":this.searchShow=!0,this.$nextTick(i=>{this.$refs.searchInput.focus()});break;case"openCreate":const e=[this.userId];this.dialogData.dialog_user&&this.userId!=this.dialogData.dialog_user.userid&&e.push(this.dialogData.dialog_user.userid),u.emit("createGroup",e);break;case"modifyNormal":this.modifyData={dialog_id:this.dialogData.id,avatar:this.dialogData.avatar,name:this.dialogData.name},this.dialogData.type==="user"&&(this.modifyData=Object.assign(this.modifyData,{userid:this.dialogData.dialog_user.userid,avatar:(s=this.cacheUserBasic.find(i=>i.userid===this.dialogData.dialog_user.userid))==null?void 0:s.userimg,clear_day:0,webhook_url:"",system_name:""}),this.modifyLoad++,this.$store.dispatch("call",{url:"users/bot/info",data:{id:this.dialogData.dialog_user.userid}}).then(({data:i})=>{this.modifyData.clear_day=i.clear_day,this.modifyData.webhook_url=i.webhook_url,this.modifyData.system_name=i.system_name}).finally(()=>{this.modifyLoad--})),this.modifyShow=!0;break;case"modifyAi":this.modifyData={dialog_id:this.dialogData.id,type:"ai_prompt"},this.modifyLoad++,this.$store.dispatch("call",{url:"dialog/config",data:this.modifyData}).then(({data:i})=>{this.modifyData.value=i.value}).finally(()=>{this.modifyLoad--}),this.modifyAiShow=!0;break;case"modifyAdmin":this.modifyData={dialog_id:this.dialogData.id,avatar:this.dialogData.avatar,admin:1},this.modifyShow=!0;break;case"previewAvatar":this.dialogData.type==="user"?this.$store.dispatch("previewImage",this.dialogData.userimg):this.$store.dispatch("previewImage",this.dialogData.avatar);break;case"groupInfo":this.groupInfoShow=!0;break;case"transfer":this.groupTransferData={dialog_id:this.dialogId,userid:[],disabledChoice:[this.userId]},this.groupTransferShow=!0;break;case"transferConfirm":this.onTransferGroup();break;case"disband":this.onDisbandGroup();break;case"exit":this.onExitGroup();break;case"report":this.reportShow=!0;break}},onTransferGroup(){if(this.groupTransferData.userid.length===0){$A.messageError("\u8BF7\u9009\u62E9\u65B0\u7684\u7FA4\u4E3B");return}this.groupTransferLoad++,this.$store.dispatch("call",{url:"dialog/group/transfer",data:{dialog_id:this.dialogId,userid:this.groupTransferData.userid[0]}}).then(({data:t,msg:s})=>{$A.messageSuccess(s),this.$store.dispatch("saveDialog",t)}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.groupTransferLoad--,this.groupTransferShow=!1})},onDisbandGroup(){$A.modalConfirm({content:`\u4F60\u786E\u5B9A\u8981\u89E3\u6563\u3010${this.dialogData.name}\u3011\u7FA4\u7EC4\u5417\uFF1F`,loading:!0,okText:"\u89E3\u6563",onOk:()=>new Promise((t,s)=>{this.$store.dispatch("call",{url:"dialog/group/disband",data:{dialog_id:this.dialogId}}).then(({msg:e})=>{t(e),this.$store.dispatch("forgetDialog",{id:this.dialogId})}).catch(({msg:e})=>{s(e)})})})},onExitGroup(){$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u8981\u9000\u51FA\u7FA4\u7EC4\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,s)=>{this.$store.dispatch("call",{url:"dialog/group/deluser",data:{dialog_id:this.dialogId}}).then(({msg:e})=>{t(e),this.$store.dispatch("forgetDialog",{id:this.dialogId})}).catch(({msg:e})=>{s(e)})})})},onModify(){this.modifyData.userid?(this.modifyLoad++,this.$store.dispatch("editUserBot",{id:this.modifyData.userid,avatar:this.modifyData.avatar,name:this.modifyData.name,clear_day:this.modifyData.clear_day,webhook_url:this.modifyData.webhook_url,dialog_id:this.modifyData.dialog_id}).then(({msg:t})=>{$A.messageSuccess(t),this.modifyShow=!1,this.modifyData={}}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.modifyLoad--})):(this.modifyLoad++,this.$store.dispatch("call",{url:"dialog/group/edit",data:this.modifyData}).then(({data:t,msg:s})=>{$A.messageSuccess(s),this.$store.dispatch("saveDialog",t),this.modifyShow=!1,this.modifyData={}}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.modifyLoad--}))},onAiModify(){this.modifyLoad++,this.$store.dispatch("call",{url:"dialog/config/save",data:this.modifyData,method:"post"}).then(({data:t,msg:s})=>{$A.messageSuccess(s),this.$store.dispatch("saveDialog",t),this.modifyAiShow=!1,this.modifyData={}}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.modifyLoad--})},onForward(t){return new Promise((s,e)=>{this.$store.dispatch("call",{url:"dialog/msg/forward",data:{dialogids:t.dialogids,userids:t.userids,msg_id:t.msg_id,show_source:t.sender?1:0,leave_message:t.message}}).then(({data:i,msg:a})=>{this.$store.dispatch("saveDialogMsg",i.msgs),this.$store.dispatch("updateDialogLastMsg",i.msgs),$A.messageSuccess(a),s()}).catch(({msg:i})=>{$A.modalError(i),e()})})},onActivity(t){if(this.msgActivity===!1){t&&(this.msgActivity=1);return}t?this.msgActivity++:this.msgActivity--},onScroll({target:t}){var i;this.onThrottleScroll(t),this.operateVisible&&this.onUpdateOperate((i=t.querySelector(`[data-id="${this.operateItem.id}"]`))==null?void 0:i.querySelector(".dialog-head"));const{offset:s,tail:e}=this.scrollInfo();this.scrollOffset=s,this.scrollTail=e,e<=10&&(this.msgNew=0,this.scrollToBottomRefresh&&this.onReGetMsg()),this.scrollAction=t.scrollTop,this.scrollDirection=this.scrollTmp<=this.scrollAction?"down":"up",setTimeout(a=>this.scrollTmp=this.scrollAction,0),this.scrollIng++,setTimeout(a=>this.scrollIng--,100)},onThrottleScroll:K.exports.throttle(function(t){var s;this.operatePreventScroll===0&&this.operateVisible&&(this.operateVisible=!!this.getSelectedTextInElement(t)&&!((s=t==null?void 0:t.querySelector(`[unique="${this.operateItem.id}"]`))!=null&&s.classList.contains("item-leave")))},100),onRange(t){if(this.preventRangeLoad>0)return;const s=this.scrollDirection==="down"?"next_id":"prev_id";for(let e=t.start;e<=t.end;e++){if(!this.allMsgs[e])continue;const i=this.allMsgs[e][s];if(!i)continue;const a=this.allMsgs[e+(s==="next_id"?1:-1)];a&&a.id!=i&&(this.preventRangeLoad++,this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,[s]:i}).finally(o=>{this.preventRangeLoad--}))}},onVisible(t){this.startMsgId=$A.runNum(t.length?t[Math.min(1,t.length-1)]:0)},onBack(){if(!this.beforeBack)return this.handleBack();const t=this.beforeBack();t&&t.then?t.then(()=>{this.handleBack()}):this.handleBack()},handleBack(){if($A.isSubElectron){window.close();return}const{name:t,params:s}=this.$store.state.routeHistoryLast;t===this.routeName&&/^\d+$/.test(s.dialogId)?this.goForward({name:this.routeName}):this.goBack()},onMsgType(t){switch(t){case"project":this.openProject();break;case"task":this.openTask();break;case"okr":this.openOkr();break;default:this.loadMsg?$A.messageWarning("\u6B63\u5728\u52A0\u8F7D\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5..."):this.msgType=t;break}},onMention(t){const s=this.cacheUserBasic.find(({userid:e})=>e==t.userid);s&&this.$refs.input.addMention({denotationChar:"@",id:s.userid,value:s.nickname})},onLongpress({event:t,el:s,msgData:e}){this.operateVisible=this.operateItem.id===e.id,this.operateItem=$A.isJson(e)?e:{},this.operateCopys=[],t.target.nodeName==="IMG"?(this.$Electron&&this.operateCopys.push({type:"image",icon:"&#xe7cd;",label:"\u590D\u5236\u56FE\u7247",value:$A.thumbRestore(t.target.currentSrc)}),e.type!=="file"&&!q(t.target.currentSrc)&&this.operateCopys.push({type:"imagedown",icon:"&#xe7a8;",label:"\u4E0B\u8F7D\u56FE\u7247",value:$A.thumbRestore(t.target.currentSrc)})):t.target.nodeName==="A"&&(t.target.classList.contains("mention")&&t.target.classList.contains("file")&&this.findOperateFile(this.operateItem.id,t.target.href),this.operateCopys.push({type:"link",icon:"&#xe7cb;",label:"\u590D\u5236\u94FE\u63A5",value:t.target.href})),this.operateCopys.push({type:"selected",icon:"&#xe7df;",label:"\u590D\u5236\u9009\u62E9",value:"",visible:!1}),e.type==="text"&&(e.msg.text.replace(/<[^>]+>/g,"").length>0&&this.operateCopys.push({type:"text",icon:"&#xe77f;",label:null,title:this.operateCopys.length>1?"\u590D\u5236\u6587\u672C":"\u590D\u5236",value:""}),e.msg.type==="md"&&this.operateCopys.push({type:"md",icon:"&#xe77f;",label:"\u590D\u5236\u539F\u6587",value:""})),this.$nextTick(()=>{this.operateItem.clientX=t.clientX,this.operateItem.clientY=t.clientY,this.onSelectionchange(),this.onUpdateOperate(s)})},onSelectionchange(){if(!this.operateVisible)return;const t=this.operateCopys.find(({type:i})=>i==="selected");if(!t)return;const s=this.getSelectedTextInElement(this.$refs.scroller.$el.querySelector(`[data-id="${this.operateItem.id}"]`));t.value=s,t.visible=s.length>0;const e=this.operateCopys.find(({type:i})=>i==="text");!e||(e.label=s.length>0?"\u590D\u5236\u5168\u90E8":null)},onUpdateOperate(t){if(!t)return;const s=t.getBoundingClientRect(),e=this.$refs.scroller.$el.getBoundingClientRect();let i=s.top+this.windowScrollY,a=s.height;s.top<e.top&&(i=e.top,a-=e.top-s.top),s.bottom>e.bottom&&(a-=s.bottom-e.bottom);let o=this.operateItem.clientX;if(this.windowWidth<500&&(this.operateItem.created_at?o=this.windowWidth/2:o=s.left+s.width/2),this.operateStyles={left:`${o}px`,top:`${i}px`,height:`${a}px`},this.operateClient={x:o,y:this.operateItem.clientY},this.operateVisible)try{this.$refs.operate.$refs.drop.popper.update()}catch{}else this.operateVisible=!0},onOperate(t,s=null){this.operateVisible=!1,this.$nextTick(e=>{switch(t){case"cancel":this.onCancelSend();break;case"reply":this.onReply();break;case"update":this.onUpdate();break;case"voice2text":this.onVoice2text();break;case"translation":this.onTranslation();break;case"copy":this.onCopy(s);break;case"forward":this.$refs.forwarder.onSelection();break;case"withdraw":this.onWithdraw();break;case"view":this.onViewFile();break;case"down":this.onDownFile();break;case"tag":this.onTag();break;case"newTask":let i=$A.formatMsgBasic(this.operateItem.msg.text);i=i.replace(/<img[^>]*?src=(["'])([^"']+?)(_thumb\.(png|jpg|jpeg))?\1[^>]*?>/g,'<img src="$2">'),i=i.replace(/<li\s+data-list="checked">/g,'<li class="tox-checklist--checked">'),i=i.replace(/<li\s+data-list="unchecked">/g,"<li>"),i=i.replace(/<ol[^>]*>([\s\S]*?)<\/ol>/g,'<ul class="tox-checklist">$1</ul>'),u.emit("addTask",{owner:[this.userId],content:i});break;case"todo":this.onTodo();break;case"pos":this.onPositionId(this.operateItem.id);break;case"emoji":s==="more"?z().then(this.onEmoji):this.onEmoji(s);break;case"top":this.onTopOperate();break}})},onCancelSend(){$A.modalConfirm({title:"\u53D6\u6D88\u53D1\u9001",content:"\u4F60\u786E\u5B9A\u8981\u53D6\u6D88\u53D1\u9001\u5417\uFF1F",loading:!0,onOk:()=>new Promise(async(t,s)=>{if(this.operateItem.created_at){s("\u6D88\u606F\u5DF2\u53D1\u9001\uFF0C\u4E0D\u53EF\u53D6\u6D88");return}if(this.operateItem.type==="file"){const{file_uid:e,file_method:i}=this.operateItem;if(i==="photo"){try{await $A.eeuiAppCancelUploadPhoto(e)}catch{}return this.forgetTempMsg(this.operateItem.id),t()}if(this.$refs.chatUpload.cancel(e))return this.forgetTempMsg(this.operateItem.id),t();s("\u53D6\u6D88\u53D1\u9001\u5931\u8D25")}else this.$store.dispatch("callCancel",this.operateItem.id).then(()=>{this.forgetTempMsg(this.operateItem.id),t()}).catch(()=>{s("\u53D6\u6D88\u53D1\u9001\u5931\u8D25")})})})},onReply(t){this.replyMsgAutoMention=!0,this.setQuote(this.operateItem.id,t),this.inputFocus()},onUpdate(){const{type:t}=this.operateItem;if(this.onReply(t==="text"?"update":"reply"),t==="text"){let{text:s,type:e}=this.operateItem.msg;this.$refs.input.setPasteMode(!1),e==="md"?this.$refs.input.setText(s):(s.indexOf("mention")>-1&&(s=s.replace(/<a class="mention ([^'"]*)" href="([^'"]*)"[^>]*>([~%])([^>]*)<\/a>/g,'<span class="mention" data-denotation-char="$3" data-id="$2" data-value="$4">&#xFEFF;<span contenteditable="false"><span class="ql-mention-denotation-char">$3</span>$4</span>&#xFEFF;</span>'),s=s.replace(/<span class="mention ([^'"]*)" data-id="(\d+)">([@#])([^>]*)<\/span>/g,'<span class="mention" data-denotation-char="$3" data-id="$2" data-value="$4">&#xFEFF;<span contenteditable="false"><span class="ql-mention-denotation-char">$3</span>$4</span>&#xFEFF;</span>')),s=s.replace(/<img[^>]*>/gi,i=>i.replace(/(width|height)="\d+"\s*/ig,"")),s=s.replace(/<p><\/p>/g,"<p><br/></p>"),this.msgText=$A.formatMsgBasic(s)),this.$nextTick(i=>this.$refs.input.setPasteMode(!0))}},onVoice2text(){if(!this.actionPermission(this.operateItem,"voice2text"))return;const{id:t}=this.operateItem;this.isLoad(`msg-${t}`)||(this.$store.dispatch("setLoad",`msg-${t}`),this.$store.dispatch("call",{url:"dialog/msg/voice2text",data:{msg_id:t}}).then(({data:s})=>{this.$store.dispatch("saveDialogMsg",s)}).catch(({msg:s})=>{$A.messageError(s)}).finally(s=>{this.$store.dispatch("cancelLoad",`msg-${t}`)}))},onTranslation(t=void 0){if(!this.actionPermission(this.operateItem,"translation"))return;const{id:s}=this.operateItem,e=`msg-${s}`;if(this.isLoad(e))return;let i=0;if(t==="hidden"){this.$store.dispatch("removeTranslation",e);return}else t==="retranslation"&&(this.$store.dispatch("removeTranslation",e),t=void 0,i=1);this.$store.dispatch("setLoad",e),this.$store.dispatch("call",{url:"dialog/msg/translation",data:{msg_id:s,force:i,language:t||this.cacheTranslationLanguage}}).then(({data:a})=>{this.$store.dispatch("saveTranslation",Object.assign(a,{key:e}))}).catch(({msg:a})=>{$A.messageError(a)}).finally(a=>{this.$store.dispatch("cancelLoad",e)})},applyCreateBefore(t,s,e){$A.modalConfirm({content:`\u4F60\u786E\u5B9A\u8981\u521B\u5EFA${t==="task"?"\u4EFB\u52A1":"\u5B50\u4EFB\u52A1"}\u5417\uFF1F`,onOk:()=>{this.applyCreateTask(t,s,e)}})},async applyCreateTask(t,s,e){const i=s.target;if(i.classList.contains("applying")||i.classList.contains("applied"))return;if(i.classList.add("applying"),t==="task"){if(this.dialogData.group_type!=="project"){i.classList.remove("applying"),$A.modalError("\u53EA\u6709\u5728\u9879\u76EE\u4E2D\u624D\u80FD\u521B\u5EFA\u4EFB\u52A1");return}if(!this.dialogData.group_info){i.classList.remove("applying"),$A.modalError("\u9879\u76EE\u4E0D\u5B58\u5728");return}}else if(t==="subtask"){if(this.dialogData.group_type!=="task"){i.classList.remove("applying"),$A.modalError("\u53EA\u6709\u5728\u4EFB\u52A1\u4E2D\u624D\u80FD\u521B\u5EFA\u5B50\u4EFB\u52A1");return}if(!this.dialogData.group_info){i.classList.remove("applying"),$A.modalError("\u4EFB\u52A1\u4E0D\u5B58\u5728");return}}else{i.classList.remove("applying"),$A.modalError("\u672A\u77E5\u7C7B\u578B");return}let a=s.target;for(;a&&!a.classList.contains("apply-create-task");){if(a.classList.contains("dialog-scroller")){a=null;break}a=a.parentElement}if(!a){i.classList.remove("applying"),$A.modalError("\u672A\u627E\u5230\u5185\u5BB9");return}const o=e.querySelectorAll(".apply-create-task"),n=Array.from(o).indexOf(a),r=Array.from(a.querySelectorAll("li")).map(h=>{var w,I,k,D;const m=(I=(w=h.querySelector(".title"))==null?void 0:w.innerText)==null?void 0:I.trim();if(!m)return null;const y=((D=(k=h.querySelector(".desc"))==null?void 0:k.innerText)==null?void 0:D.trim())||"",P=y?y.split(`
`).filter(Boolean).map(B=>`<p>${B.trim()}</p>`).join(""):"";return t==="subtask"?{task_id:this.dialogData.group_info.id,name:m}:{project_id:this.dialogData.group_info.id,name:m,content:P}}).filter(Boolean),l=t==="subtask"?"taskAddSub":"taskAdd",d=t==="subtask"?"\u5B50\u4EFB\u52A1":"\u4EFB\u52A1",c=[];for(const h of r)try{const m=await this.$store.dispatch(l,h);c.push({success:!0,data:m})}catch(m){c.push({success:!1,error:m})}const _=c.filter(h=>h.success).map(h=>h.data),p=c.filter(h=>!h.success).map(h=>h.error);let g=`${this.$store.state.userInfo.nickname} \u6210\u529F\u521B\u5EFA ${_.length} \u4E2A${d}`;p.length>0&&(g+=`\uFF0C${p.length} \u4E2A${d}\u521B\u5EFA\u5931\u8D25`),i.classList.remove("applying"),i.classList.add("applied");const{data:R}=await this.$store.dispatch("call",{url:"dialog/msg/sendnotice",data:{dialog_id:this.dialogId,source:"ai",notice:g}});this.sendSuccess(R),await this.$store.dispatch("call",{url:"dialog/msg/applied",data:{msg_id:this.operateItem.id,index:n}})},openTranslationMenu(t){const s=Object.keys($).map(e=>({label:$[e],value:e}));s.push({label:"\u91CD\u65B0\u7FFB\u8BD1",value:"retranslation",divided:!0},{label:"\u9690\u85CF\u7FFB\u8BD1",value:"hidden"}),this.$store.state.menuOperation={event:t,list:s,active:this.cacheTranslationLanguage,onUpdate:async e=>{$[e]&&await this.$store.dispatch("setTranslationLanguage",e),this.onTranslation(e)}}},onCopy(t){var i;if(!$A.isJson(t))return;const{type:s,value:e}=t;switch(s){case"image":this.$Electron&&this.getBase64Image(e).then(o=>{this.$Electron.sendMessage("copyBase64Image",{base64:o})});break;case"imagedown":this.$Electron?this.$Electron.sendMessage("saveImageAt",{params:{},url:e}):this.$store.dispatch("downUrl",{url:e,token:!1});break;case"filepos":this.$store.dispatch("filePos",e);break;case"filedown":this.$store.dispatch("downUrl",$A.apiUrl(`file/content?id=${e.shakeId}&down=yes`));break;case"link":this.copyText(e);break;case"selected":this.copyText(e);break;case"text":const a=(i=this.$refs.scroller.$el.querySelector(`[data-id="${this.operateItem.id}"]`))==null?void 0:i.querySelector(".dialog-content");if(a){let o=a.innerText;$A.getObject(this.operateItem.msg,"type")!=="md"&&(o=o.replace(/\n\n/g,`
`).replace(/(^\s*)|(\s*$)/g,"")),this.copyText(o)}else $A.messageWarning("\u4E0D\u53EF\u590D\u5236\u7684\u5185\u5BB9");break;case"md":this.copyText(this.operateItem.msg.text);break}},onWithdraw(){$A.modalConfirm({content:"\u786E\u5B9A\u64A4\u56DE\u6B64\u4FE1\u606F\u5417\uFF1F",okText:"\u64A4\u56DE",loading:!0,onOk:()=>new Promise((t,s)=>{this.$store.dispatch("call",{url:"dialog/msg/withdraw",data:{msg_id:this.operateItem.id}}).then(()=>{t("\u6D88\u606F\u5DF2\u64A4\u56DE"),this.$store.dispatch("forgetDialogMsg",this.operateItem)}).catch(({msg:e})=>{s(e)})})})},onViewReply(t){this.operateVisible||this.onPositionId(t.reply_id,t.msg_id)},onViewText(t,s){if(this.operateVisible)return;const{target:e,clientX:i}=t;if(e.classList.contains("mark-set")){!this.windowTouch&&this.$refs.input.focus(),this.$refs.input.setText(e.innerText);return}if(e.classList.contains("mark-insert")){this.$refs.input.insertText(e.innerText);return}if(e.classList.contains("apply-create-task-button")){this.operateItem=this.findMsgByElement(s),this.applyCreateBefore("task",t,s);return}if(e.classList.contains("apply-create-subtask-button")){this.operateItem=this.findMsgByElement(s),this.applyCreateBefore("subtask",t,s);return}if(e.classList.contains("translation-label")){this.operateItem=this.findMsgByElement(s),this.openTranslationMenu(t);return}let a=e;for(;a&&!a.classList.contains("dialog-scroller");){if(a.classList.contains("open-approve-details")){u.emit("approveDetails",a.getAttribute("data-id"));return}a=a.parentElement}switch(e.nodeName){case"IMG":if(!(e.classList.contains("browse")&&this.onViewPicture(e.currentSrc))){const n=$A.getTextImagesInfo(s.outerHTML);this.$store.dispatch("previewImage",{index:e.currentSrc,list:n})}break;case"SPAN":e.classList.contains("mention")&&e.classList.contains("task")&&this.$store.dispatch("openTask",$A.runNum(e.getAttribute("data-id"))),e.classList.contains("mention")&&e.classList.contains("okr")&&this.$store.dispatch("openOkr",$A.runNum(e.getAttribute("data-id")));break;case"LI":const o=e.getAttribute("data-list");if(["checked","unchecked"].includes(o)){if(i-e.getBoundingClientRect().x>18)return;const n=this.findMsgByElement(s);if(n.userid!=this.userId)return;const r=[].indexOf.call(s.querySelectorAll(e.tagName),e);o==="checked"?e.setAttribute("data-list","unchecked"):e.setAttribute("data-list","checked"),this.$store.dispatch("setLoad",{key:`msg-${n.id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/checked",data:{dialog_id:this.dialogId,msg_id:n.id,index:r,checked:o==="checked"?0:1}}).then(({data:l})=>{this.$store.dispatch("saveDialogMsg",l)}).catch(({msg:l})=>{o==="checked"?e.setAttribute("data-list","checked"):e.setAttribute("data-list","unchecked"),$A.modalError(l)}).finally(l=>{this.$store.dispatch("cancelLoad",`msg-${n.id}`)})}break}},findMsgByElement(t){let s=t.parentElement;for(;s&&!s.classList.contains("dialog-scroller");){if(s.classList.contains("dialog-view")){const e=s.getAttribute("data-id");return this.allMsgs.find(i=>i.id==e)||{}}s=s.parentElement}return{}},onViewFile(t){if(this.operateVisible)return;$A.isJson(t)||(t=this.operateItem);const{msg:s}=t;if(s.ext==="mp4"){this.$store.dispatch("previewImage",{index:0,list:[{src:s.path,width:s.width,height:s.height}]});return}if(["jpg","jpeg","webp","gif","png"].includes(s.ext)){this.onViewPicture(s.path);return}const e=`/single/file/msg/${t.id}`,i=t.type==="longtext"?this.$L("\u6D88\u606F\u8BE6\u60C5"):`${s.name} (${$A.bytesToSize(s.size)})`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`file-msg-${t.id}`,path:e,userAgent:"/hideenOfficeTitle/",force:!1,config:{title:i,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:i,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${e}`}}):window.open($A.mainUrl(e.substring(1)))},onViewPicture(t){const s=this.allMsgs.filter(a=>a.type==="file"?["jpg","jpeg","webp","gif","png"].includes(a.msg.ext):a.type==="text"?a.msg.text.match(/<img\s+class="browse"[^>]*?>/):!1),e=[];s.some(({type:a,msg:o})=>{a==="file"?e.push({src:o.path,width:o.width,height:o.height}):a==="text"&&e.push(...$A.getTextImagesInfo(o.text))});const i=$A.thumbRestore(t);return e.find(a=>$A.thumbRestore(a.src)==i)?(this.$store.dispatch("previewImage",{index:t,list:e}),!0):!1},onDownFile(t){if(!this.operateVisible){if($A.isJson(t)||(t=this.operateItem),t.type==="longtext"){this.onViewFile(t);return}$A.modalConfirm({language:!1,title:this.$L("\u4E0B\u8F7D\u6587\u4EF6"),okText:this.$L("\u7ACB\u5373\u4E0B\u8F7D"),content:`${t.msg.name} (${$A.bytesToSize(t.msg.size)})`,onOk:()=>{this.$store.dispatch("downUrl",$A.apiUrl(`dialog/msg/download?msg_id=${t.id}`))}})}},onReplyList(t){this.operateVisible||(this.replyListId=t.msg_id,this.replyListShow=!0)},onError(t){if(t.error!==!0)return;const{type:s,mType:e,content:i,msg:a}=t.errorData,o={icon:"error",title:"\u53D1\u9001\u5931\u8D25",content:i,cancelText:"\u53D6\u6D88\u53D1\u9001",onCancel:n=>{this.forgetTempMsg(t.id)}};if(s==="text")o.okText="\u91CD\u65B0\u53D1\u9001",o.onOk=()=>{this.forgetTempMsg(t.id),this.sendMsg(a,e)};else if(s==="record")o.okText="\u91CD\u65B0\u53D1\u9001",o.onOk=()=>{this.forgetTempMsg(t.id),this.sendRecord(a)};else return;$A.modalConfirm(o)},onEmoji(t){$A.isJson(t)||(t={msg_id:this.operateItem.id,symbol:t});const s=this.cacheEmojis.filter(e=>e!==t.symbol);if(s.unshift(t.symbol),$A.IDBSave("cacheEmojis",this.$store.state.cacheEmojis=s.slice(0,3)),this.replyEmojiIngs[t.msg_id]){$A.messageWarning("\u6B63\u5728\u5904\u7406\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5...");return}this.replyEmojiIngs[t.msg_id]=!0,this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/emoji",data:t}).then(({data:e})=>{this.dialogMsgs.findIndex(a=>a.id==e.id)>-1?this.$store.dispatch("saveDialogMsg",e):this.todoViewData.id===e.id&&(this.todoViewData=Object.assign(this.todoViewData,e))}).catch(({msg:e})=>{$A.messageError(e)}).finally(e=>{this.replyEmojiIngs[t.msg_id]=!1,this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})},onShowEmojiUser(t){this.operateVisible||(this.respondData=t,this.respondShow=!0)},onOther({event:t,data:s}){this.operateVisible||t==="todoAdd"&&(this.todoSpecifyData=Object.assign(this.todoSpecifyData,s),this.todoSpecifyShow=!0,this.$nextTick(e=>{this.$refs.todoSpecifySelect.onSelection()}))},onTag(){if(this.operateVisible)return;const t={msg_id:this.operateItem.id};this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/tag",data:t}).then(({data:s})=>{this.tagOrTodoSuccess(s)}).catch(({msg:s})=>{$A.messageError(s)}).finally(s=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})},onTypeChange(t){t==="user"&&(this.todoSettingData.userids.length===0&&this.todoSettingData.quick_value.length>0&&(this.todoSettingData.userids=this.todoSettingData.quick_value),this.$nextTick(s=>{this.$refs.userSelect.onSelection()})),t!=="quick_select"&&(this.todoSettingData.quick_value=[])},onQuickChange(t){this.todoSettingData.type=t.length===0?"all":"quick_select"},onTodo(t){var s;if(!this.operateVisible)if(t==="submit"){const e=$A.cloneJSON(this.todoSettingData);if(e.type==="quick_select")e.type="user",e.userids=e.quick_value;else if(e.type==="user"&&$A.arrayLength(e.userids)===0){$A.messageWarning("\u9009\u62E9\u6307\u5B9A\u6210\u5458");return}this.todoSettingLoad++,this.onTodoSubmit(e).then(i=>{$A.messageSuccess(i),this.todoSettingShow=!1}).catch(i=>{$A.messageError(i)}).finally(i=>{this.todoSettingLoad--})}else if(this.operateItem.todo)$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u53D6\u6D88\u5F85\u529E\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",loading:!0,onOk:()=>this.onTodoSubmit({type:"user",userids:[],msg_id:this.operateItem.id})});else{const e={};e[this.userId]=this.userId;const i=(s=this.dialogData.dialog_user)==null?void 0:s.userid;if(i&&i!=this.userId&&!this.dialogData.bot&&(e[i]=i),this.operateItem.type==="text"){const a=/<span class="mention user" data-id="(\d+)">([^<]+)<\/span>/g,o=this.operateItem.msg.text.match(a);o&&o.forEach(n=>{const r=parseInt(n.replace(a,"$1"));r&&r!=this.userId&&(e[r]=r)})}this.todoSettingData={type:"all",userids:[],msg_id:this.operateItem.id,quick_value:[],quick_list:Object.values(e)},this.todoSettingShow=!0}},onTodoSpecify(){return new Promise((t,s)=>{this.onTodoSubmit(this.todoSpecifyData).then(e=>{$A.messageSuccess(e),t()}).catch(e=>{$A.messageError(e),s()})})},onTodoSubmit(t){return new Promise((s,e)=>{this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{method:"post",url:"dialog/msg/todo",data:t}).then(({data:i,msg:a})=>{s(a),this.tagOrTodoSuccess(i),this.onActive()}).catch(({msg:i})=>{e(i)}).finally(i=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})})},tagOrTodoSuccess(t){this.$store.dispatch("saveDialogMsg",t.update),t.add&&(this.$store.dispatch("saveDialogMsg",t.add),this.$store.dispatch("updateDialogLastMsg",t.add))},onSearchSwitch(t){if(this.searchResult.length!==0){if(this.searchLocation===1&&this.searchResult.length===1){this.onPositionId(this.searchResult[0]);return}t==="prev"?this.searchLocation<=1?this.searchLocation=this.searchResult.length:this.searchLocation--:this.searchLocation>=this.searchResult.length?this.searchLocation=1:this.searchLocation++}},onSearchKeyup(t){(t===null||t.keyCode===27)&&(this.searchShow=!1,this.searchKey="",this.searchResult=[])},onPositionMark(t){this.positionLoad>0||(this.positionLoad++,this.onPositionId(t).finally(s=>{this.positionLoad--}))},actionPermission(t,s){switch(s){case"forward":if(["word-chain","vote","template"].includes(t.type))return!1;break;case"newTask":return t.type==="text";case"voice2text":if(t.type!=="record"||t.msg.text)return!1;break;case"translation":return["text","record"].includes(t.type)&&t.msg.text}return!0},findOperateFile(t,s){const e=this.fileLinks.find(i=>i.link===s);if(e){this.addFileMenu(t,e);return}this.$store.dispatch("searchFiles",{link:s}).then(({data:i})=>{if(i.length===1){const a={link:s,id:i[0].id,pid:i[0].pid};this.fileLinks.push(a),this.addFileMenu(t,a)}}).catch(i=>{})},addFileMenu(t,s){if(this.operateItem.id!=t||this.operateCopys.findIndex(i=>i.type==="filepos")!==-1)return;const e=Math.max(0,this.operateCopys.findIndex(i=>i.type==="link")-1);this.operateCopys.splice(e,0,{type:"filepos",icon:"&#xe6f3;",label:"\u663E\u793A\u6587\u4EF6",value:{folderId:s.pid,fileId:null,shakeId:s.id}},{type:"filedown",icon:"&#xe7a8;",label:"\u4E0B\u8F7D",value:{folderId:s.pid,fileId:null,shakeId:s.id}})},getBase64Image(t){return new Promise(s=>{let e=document.createElement("CANVAS"),i=e.getContext("2d"),a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{e.height=a.height,e.width=a.width,i.drawImage(a,0,0);let o="png";$A.rightExists(t,"jpg")||$A.rightExists(t,"jpeg")?o="jpeg":$A.rightExists(t,"webp")?o="webp":$A.rightExists(t,"git")&&(o="git"),s(e.toDataURL(`image/${o}`)),e=null},a.src=t})},getSelectedTextInElement(t){const s=document.getSelection();if(s.rangeCount>0){const e=s.getRangeAt(0);if(t.contains(e.commonAncestorContainer))return e.toString()}return""},onViewAvatar(t){let s=null;t.target.tagName==="IMG"?s=t.target.src:s=$A(t.target).find("img").attr("src"),s&&this.$store.dispatch("previewImage",s)},onTopOperate(){this.operateVisible||(this.operateItem.top_at?this.onCancelTop(this.operateItem):this.onTopSubmit(this.operateItem))},onTopSubmit(t){return new Promise((s,e)=>{this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/top",data:{msg_id:t.id}}).then(({data:i,msg:a})=>{var o,n,r;if(s(a),this.$store.dispatch("saveDialog",{id:this.dialogId,top_msg_id:((o=i.update)==null?void 0:o.top_msg_id)||0,top_userid:((n=i.update)==null?void 0:n.top_userid)||0}),(r=i.update)!=null&&r.top_msg_id){const l=this.dialogMsgs.findIndex(({id:d})=>d==i.update.top_msg_id);l>-1&&this.$store.dispatch("saveDialogMsgTop",Object.assign({},this.dialogMsgs[l]))}i.add&&(this.$store.dispatch("saveDialogMsg",i.add),this.$store.dispatch("updateDialogLastMsg",i.add),this.onActive())}).catch(({msg:i})=>{e(i)}).finally(i=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})})},onPosTop(){!this.topMsg||(this.topPosLoad++,this.onPositionId(this.topMsg.id).finally(t=>{this.topPosLoad--}))},onCancelTop(t){$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u53D6\u6D88\u7F6E\u9876\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",loading:!0,onOk:()=>this.onTopSubmit(t)})},getUserApproveStatus(){this.approvaUserStatus="",!(this.dialogData.type!=="user"||this.dialogData.bot)&&this.$store.dispatch("call",{url:"approve/user/status",data:{userid:this.dialogData.dialog_user.userid}}).then(({data:t})=>{this.approvaUserStatus=t}).catch(({msg:t})=>{$A.messageError(t)})},async shakeToMsgId(t){try{const s=await $A.findElementWithRetry(()=>{var e;return(e=this.$refs.scroller.$el.querySelector(`[data-id="${t}"]`))==null?void 0:e.querySelector(".dialog-head")});$A.scrollIntoAndShake(s,!1)}catch{}}}},E={};var Ut=f(Bt,Rt,Pt,!1,jt,null,null,null);function jt(t){for(let s in E)this[s]=E[s]}var Qt=function(){return Ut.exports}();export{Qt as D};
